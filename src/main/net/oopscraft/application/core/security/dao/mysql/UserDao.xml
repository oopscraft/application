<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
  
<mapper namespace="net.oopscraft.application.core.security.dao.UserDao">

    <resultMap id="user" type="net.oopscraft.application.core.security.User">
        <result column="user_id" property="id"/>
        <result column="user_email" property="email"/>
        <result column="user_mobile" property="mobile"/>
        <result column="user_name" property="name"/>
        <result column="user_nick" property="nickname"/>
        <result column="user_pwd" property="password"/>
        <result column="user_img" property="image"/>
        <result column="user_msg" property="message"/>
        <result column="user_desc" property="description"/>
        <result column="user_stat_cd" property="statusCode"/>
        <result column="user_join_dtm" property="joinDate"/>
    </resultMap>
    
    <resultMap id="group" type="net.oopscraft.application.core.security.Group">
    	<result column="path" property="path"/>
    	<result column="depth" property="depth"/>
    	<result column="group_id" property="id"/>
    	<result column="upper_group_id" property="upperId"/>
		<result column="group_name" property="name"/>
		<result column="group_desc" property="description"/>
		<result column="sort_seq" property="sortSeq"/>
    </resultMap>

	<select id="selectUserList" resultMap="user">
		<![CDATA[
		SELECT 	 user_id
				,user_email
				,user_mobile
				,user_name
				,user_nick
				,user_pwd
				,user_img
				,user_msg
				,user_desc
				,user_stat_cd
				,user_join_dtm
		FROM 	app_user_info
		WHERE 	1 = 1
		]]>
		<if test="user.id != null and user.id != ''">
		<![CDATA[
		AND 	user_id LIKE CONCAT(#{user.id},'%')
		]]>
		</if>
		<if test="user.email != null and user.email != ''">
		<![CDATA[
		AND 	user_email LIKE #{user.email}||'%'
		]]>
		</if>
		<if test="user.mobile != null and user.mobile != ''">
		<![CDATA[
		AND 	user_mobile LIKE #{user.mobile}||'%'
		]]>
		</if>
		<if test="user.name != null and user.name != ''">
		<![CDATA[
		AND 	user_name LIKE #{user.email}||'%'
		]]>
		</if>
		<if test="user.nickname != null and user.nickname != ''">
		<![CDATA[
		AND 	user_nick LIKE #{user.nickname}||'%'
		]]>
		</if>
		<![CDATA[
		AND 	sys_delete_yn = 'N'
		LIMIT 	${rows}
		OFFSET 	${(page-1)*rows}
		]]>
	</select>
	
	<select id="selectUser" resultMap="user">
		<![CDATA[
		SELECT 	 user_id
				,user_email
				,user_mobile
				,user_name
				,user_nick
				,user_pwd
				,user_img
				,user_msg
				,user_desc
				,user_stat_cd
				,user_join_dtm
		FROM 	app_user_info
		WHERE 	user_id = #{id}
		]]>
	</select>
	
	<insert id="insertUser">
		<![CDATA[
		INSERT INTO app_user_info (
 				 user_id
 				,sys_insert_dtm
 				,sys_delete_yn
				,user_email
				,user_mobile
				,user_name
				,user_nick
				,user_pwd
				,user_img
				,user_msg
				,user_desc
				,user_stat_cd
				,user_join_dtm
		) VALUES (
 				 #{user.id}
 				,NOW()
 				,'N'
				,#{user.email}
				,#{user.mobile}
				,#{user.name}
				,#{user.nickname}
				,#{user.password}
				,#{user.image}
				,#{user.message}
				,#{user.description}
				,#{user.statusCode}
				,#{user.joinDate}
		)
		]]>
	</insert>
	
	<update id="updateUser">
		<![CDATA[
		UPDATE 	app_user_info
		SET		 sys_update_dtm = NOW()
				,user_email = #{user.email}
				,user_mobile = #{user.mobile}
				,user_name = #{user.name}
				,user_nick = #{user.nickname}
				,user_pwd = #{user.password}
				,user_img = #{user.image}
				,user_msg = #{user.message}
				,user_desc = #{user.description}
				,user_stat_cd = #{user.statusCode}
				,user_join_dtm = #{user.joinDate}
		WHERE 	user_id = #{user.id}
		]]>
	</update>

	<delete id="deleteUser">
		<![CDATA[
		UPDATE 	app_user_info
		SET 	 sys_update_dtm = NOW()
				,sys_delete_yn = 'Y'
		WHERE 	user_id = #{id}
		]]>
	</delete>
	
	<select id="selectUserGroupList" resultMap="group">
		<![CDATA[
		SELECT 	 b.group_id
				,b.upper_group_id
				,b.group_name
				,b.group_desc
				,b.sort_seq
		FROM 	app_user_group_map a
		LEFT OUTER JOIN 
				app_group_info b
		ON 		b.group_id = a.group_id
		WHERE 	a.user_id = #{user.id}
		]]>
	</select>

	<select id="selectGroupList" resultMap="group">
		<![CDATA[
		SELECT 	 group_id
				,upper_group_id
				,group_name
				,group_desc
				,use_yn
				,sort_seq
		FROM 	app_group_info
		WHERE 	
		

		
		WITH RECURSIVE a (path, depth, group_id, upper_group_id, sort_seq) AS (
			-- Root element
			SELECT 	 CAST(group_id AS CHAR(10))
					,0 as depth
					,group_id
					,upper_group_id
					,sort_seq
			FROM 	app_group_info
			WHERE 	COALESCE(upper_group_id, '') = ''
			UNION ALL
			-- Child element
			SELECT 	 CONCAT(a.path,',', agi.group_id)
					,a.depth + 1
					,agi.group_id 
					,agi.upper_group_id
					,agi.sort_seq
			FROM 	app_group_info agi
			INNER JOIN a 
			ON		agi.upper_group_id = a.group_id
		)
		SELECT 		 a.path
					,a.depth
					,a.group_id
					,a.upper_group_id
					,agi.group_name
					,agi.group_desc
					,agi.sort_seq
		FROM 		a
		INNER JOIN 	app_group_info agi
		ON			agi.group_id = a.group_id
		ORDER BY	 a.path ASC
					,a.sort_seq ASC
		]]>
	</select>
	
	
	
</mapper>

<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
  
<mapper namespace="net.oopscraft.application.core.user.UserDao">

    <resultMap id="user" type="net.oopscraft.application.core.user.User">
        <result column="user_id" property="id"/>
        <result column="user_email" property="email"/>
        <result column="user_mobile" property="mobile"/>
        <result column="user_name" property="name"/>
        <result column="user_nick" property="nickname"/>
        <result column="user_pwd" property="password"/>
        <result column="user_img" property="image"/>
        <result column="user_msg" property="message"/>
        <result column="user_desc" property="description"/>
        <result column="user_stat_cd" property="statusCode"/>
        <result column="user_join_dtm" property="joinDate"/>
    </resultMap>
    
    <resultMap id="group" type="net.oopscraft.application.core.user.Group">
    	<result column="group_id" property="id"/>
    	<result column="upper_group_id" property="upperId"/>
		<result column="group_name" property="name"/>
		<result column="group_desc" property="description"/>
		<result column="sort_seq" property="sortSeq"/>
    </resultMap>

	<select id="selectUserList" resultMap="user">
		<![CDATA[
		SELECT 	 user_id
				,user_email
				,user_mobile
				,user_name
				,user_nick
				,user_pwd
				,user_img
				,user_msg
				,user_desc
				,user_stat_cd
				,user_join_dtm
		FROM 	app_user_info
		WHERE 	1 = 1
		]]>
		<if test="user.id != null and user.id != ''">
		<![CDATA[
		AND 	user_id LIKE CONCAT(#{user.id},'%')
		]]>
		</if>
		<if test="user.email != null and user.email != ''">
		<![CDATA[
		AND 	user_email LIKE #{user.email}||'%'
		]]>
		</if>
		<if test="user.mobile != null and user.mobile != ''">
		<![CDATA[
		AND 	user_mobile LIKE #{user.mobile}||'%'
		]]>
		</if>
		<if test="user.name != null and user.name != ''">
		<![CDATA[
		AND 	user_name LIKE #{user.email}||'%'
		]]>
		</if>
		<if test="user.nickname != null and user.nickname != ''">
		<![CDATA[
		AND 	user_nick LIKE #{user.nickname}||'%'
		]]>
		</if>
		<![CDATA[
		AND 	sys_delete_yn = 'N'
		LIMIT 	${rows}
		OFFSET 	${(page-1)*rows}
		]]>
	</select>
	
	<select id="selectUser" resultMap="user">
		<![CDATA[
		SELECT 	 user_id
				,user_email
				,user_mobile
				,user_name
				,user_nick
				,user_pwd
				,user_img
				,user_msg
				,user_desc
				,user_stat_cd
				,user_join_dtm
		FROM 	app_user_info
		WHERE 	user_id = #{id}
		]]>
	</select>
	
	<insert id="insertUser">
		<![CDATA[
		INSERT INTO app_user_info (
 				 user_id
 				,sys_insert_dtm
 				,sys_delete_yn
				,user_email
				,user_mobile
				,user_name
				,user_nick
				,user_pwd
				,user_img
				,user_msg
				,user_desc
				,user_stat_cd
				,user_join_dtm
		) VALUES (
 				 #{user.id}
 				,NOW()
 				,'N'
				,#{user.email}
				,#{user.mobile}
				,#{user.name}
				,#{user.nickname}
				,#{user.password}
				,#{user.image}
				,#{user.message}
				,#{user.description}
				,#{user.statusCode}
				,#{user.joinDate}
		)
		]]>
	</insert>
	
	<update id="updateUser">
		<![CDATA[
		UPDATE 	app_user_info
		SET		 sys_update_dtm = NOW()
				,user_email = #{user.email}
				,user_mobile = #{user.mobile}
				,user_name = #{user.name}
				,user_nick = #{user.nickname}
				,user_pwd = #{user.password}
				,user_img = #{user.image}
				,user_msg = #{user.message}
				,user_desc = #{user.description}
				,user_stat_cd = #{user.statusCode}
				,user_join_dtm = #{user.joinDate}
		WHERE 	user_id = #{user.id}
		]]>
	</update>

	<delete id="deleteUser">
		<![CDATA[
		UPDATE 	app_user_info
		SET 	 sys_update_dtm = NOW()
				,sys_delete_yn = 'Y'
		WHERE 	user_id = #{id}
		]]>
	</delete>
	
	<select id="selectUserGroupList" resultMap="group">
		<![CDATA[
		SELECT 	 b.group_id
				,b.upper_group_id
				,b.group_name
				,b.group_desc
				,b.sort_seq
		FROM 	app_user_group_map a
		LEFT OUTER JOIN 
				app_group_info b
		ON 		b.group_id = a.group_id
		WHERE 	a.user_id = #{user.id}
		]]>
	</select>
	
	
	
	
	
	
	
	
	
	<select id="selectGroupList" resultMap="group">
		<![CDATA[
		WITH RECURSIVE A (PATH, GRP_ID, UPPR_GRP_ID, SORT_SEQ) AS (
			-- Root element
			SELECT 	 CAST(GRP_ID AS CHAR(10))
					,GRP_ID
					,UPPR_GRP_ID
					,SORT_SEQ
			FROM 	APP_GRP_INF
			WHERE 	UPPR_GRP_ID IS NULL
			UNION ALL
			-- Child element
			SELECT 	 CONCAT(A.PATH,',', AGI.GRP_ID)
					,AGI.GRP_ID
					,AGI.UPPR_GRP_ID
					,AGI.SORT_SEQ
			FROM 	APP_GRP_INF AGI
			INNER JOIN A 
			ON		AGI.UPPR_GRP_ID = A.GRP_ID
		)
		SELECT 	 A.PATH
				,A.GRP_ID
				,A.UPPR_GRP_ID
				,A.SORT_SEQ
				,AGI.GRP_NM
				,AGI.GRP_DESC
		FROM 	A
		INNER JOIN APP_GRP_INF AGI
		ON		AGI.GRP_ID = A.GRP_ID
		ORDER BY A.PATH ASC
				,A.SORT_SEQ ASC
		]]>
	</select>
	
	<select id="selectChildGroupList" resultMap="group">
		<![CDATA[
		SELECT 	 GRP_ID
				,UPPR_GRP_ID
				,SORT_SEQ
				,GRP_NM
				,GRP_DESC
		FROM 	APP_GRP_INF
		WHERE 	UPPR_GRP_ID = #{id}
		ORDER BY SORT_SEQ ASC
		]]>
	</select>
	
	<select id="selectGroup" resultMap="group">
		<![CDATA[
		SELECT 	 GRP_ID
				,UPPR_GRP_ID
				,SORT_SEQ
				,GRP_NM
				,GRP_DESC
		FROM 	APP_GRP_INF
		WHERE 	GRP_ID = #{id}
		]]>
	</select>
	
	<insert id="insertGroup">
		<![CDATA[
		INSERT INTO APP_GRP_INF (
			 GRP_ID
			,UPPR_GRP_ID
			,SORT_SEQ
			,GRP_NM
			,GRP_DESC
		) VALUES (
			 #{id}
			,#{upperId}
			,#{sortSeq}
			,#{name}
			,#{description}
		)
		]]>
	</insert>
	
	<update id="updateGroup">
		<![CDATA[
		UPDATE 	APP_GRP_INF
		SET 	 UPPR_GRP_ID = #{upperId}
				,SORT_SEQ = #{sortSeq}
				,GRP_NM = #{name}
				,GRP_DESC = #{description}
		WHERE 	GRP_ID = #{id}
		]]>
	</update>
	
	<delete id="deleteGroup">
		<![CDATA[
		DELETE 
		FROM 	APP_GRP_INF
		WHERE 	GRP_ID = #{id}
		]]>
	</delete>
	
	
	
	
</mapper>

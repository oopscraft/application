<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
  
<mapper namespace="net.oopscraft.application.user.dao.GroupDao">

    <resultMap id="group" type="net.oopscraft.application.user.Group">
    	<result column="path" property="path"/>
    	<result column="depth" property="depth"/>
    	<result column="group_id" property="id"/>
    	<result column="upper_group_id" property="upperId"/>
		<result column="group_name" property="name"/>
		<result column="group_desc" property="description"/>
		<result column="sort_seq" property="sortSeq"/>
    </resultMap>

	<select id="selectGroupList" resultMap="group">
		<![CDATA[
		WITH RECURSIVE A (PATH, GRP_ID, UPPR_GRP_ID, SORT_SEQ) AS (
			-- Root element
			SELECT 	 CAST(GRP_ID AS CHAR(10))
					,GRP_ID
					,UPPR_GRP_ID
					,SORT_SEQ
			FROM 	APP_GRP_INF
			WHERE 	UPPR_GRP_ID IS NULL
			UNION ALL
			-- Child element
			SELECT 	 CONCAT(A.PATH,',', AGI.GRP_ID)
					,AGI.GRP_ID
					,AGI.UPPR_GRP_ID
					,AGI.SORT_SEQ
			FROM 	APP_GRP_INF AGI
			INNER JOIN A 
			ON		AGI.UPPR_GRP_ID = A.GRP_ID
		)
		SELECT 	 A.PATH
				,A.GRP_ID
				,A.UPPR_GRP_ID
				,A.SORT_SEQ
				,AGI.GRP_NM
				,AGI.GRP_DESC
		FROM 	A
		INNER JOIN APP_GRP_INF AGI
		ON		AGI.GRP_ID = A.GRP_ID
		ORDER BY A.PATH ASC
				,A.SORT_SEQ ASC
		]]>
	</select>
	
	<select id="selectGroup" resultMap="group">
		<![CDATA[
		SELECT 	 group_id
				,upper_group_id
				,group_name
				,group_desc
				,sort_seq
		FROM 	app_group_info
		WHERE 	user_id = #{id}
		]]>
	</select>
	
	<insert id="insertGroup">
		<![CDATA[
		INSERT INTO app_group_info (
 				 group_id
 				,sys_insert_dtm
 				,sys_delete_yn
 				,upper_group_id
				,group_name
				,group_desc
				,sort_seq
		) VALUES (
 				 #{group.id}
 				,NOW()
 				,'N'
 				,#{group.upper_group_id}
				,#{group.name}
				,#{group.description}
				,#{group.statusCode}
				,#{group.joinDate}
		)
		]]>
	</insert>
	
	<update id="updateGroup">
		<![CDATA[
		UPDATE 	app_group_info
		SET		 sys_update_dtm = NOW()
				,upper_group_id = #{group.upper_group_id}
				,group_name = #{group.name}
				,group_desc = #{group.description}
				,sort_seq = #{group.joinDate}
		WHERE 	group_id = #{group.id}
		]]>
	</update>

	<delete id="deleteGroup">
		<![CDATA[
		UPDATE 	app_group_info
		SET 	 sys_update_dtm = NOW()
				,sys_delete_yn = 'Y'
		WHERE 	group_id = #{id}
		]]>
	</delete>
	
</mapper>

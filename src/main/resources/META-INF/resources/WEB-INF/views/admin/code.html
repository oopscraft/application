<!DOCTYPE html>
<html layout:decorate="~{admin/admin.html}">
<div layout:fragment="content">
	<script>
		// defines variables 
		var search = new duice.Map({
			key: null,
			value: null,
			page: 1,
			rows: 20,
			totalCount: -1
		});
		const tabFolder = new duice.TabFolder();
		const codes = new duice.List();
		const code = new duice.Map();
		const codeItems = new duice.List();
		var isNew = false;

		// document ready
		$(document).ready(function() {
			
			// creates tab
			tabFolder.addTab(new duice.Tab(document.getElementById('tabButton1'), document.getElementById('tabContent1')));
			tabFolder.selectTab(0);
			
			// gets codes
			getCodes();
		    disableDetail(true);
		});
		
		// handle when search option is changed.
		search.onAfterChange(function(name, value){
			// if select all option, reset value. 
			if(name === 'key' && !value){
				search.set('value',null);				
			}
		});
		
		// checks when select row is changed.
		codes.onBeforeSelectRow(async function(selectedRow){
			if(isDetailChanged()){
				if(await duice.confirm("[[#{application.global.changeFound}+'\n'+#{application.global.ignoreChange}]]")){
					resetDetail();
					return true;
				}else{
					return false;
				}
			}
		});
		
		// event listener for select row
		codes.onAfterSelectRow(function(selectedRow){
			getCode(selectedRow.get('id'));
		});
		
		// checks user properties change
		code.onBeforeChange(async function(name,value){
			if(name === 'id'){
				if(isDuplicateCode(value)){
					await duice.alert('[[#{application.global.alreadyRegisteredItem(#{application.code.id})}]]');
					return false;
				}
			}
		});
		
		/**
		 * Disables detail
		 */
		function disableDetail(disable){
			code.setDisable(disable);
			$('#detailDiv').find('button').each(function(index, element){
				$(element).prop('disabled', disable);
			});
		}
		
		/**
		 * Returns detail changed.
		 */
		function isDetailChanged() {
			if(code.isDirty()
			|| codeItems.isDirty()
			){
				return true;
			}else{
				return false;
			}
		}
		
		/**
		 * Initializes detail
		 */
		function initializeDetail() {
			code.fromJson({});
			codeItems.fromJson([]);
		}
		
		/**
		 * Resets detail
		 */ 
		function resetDetail() {
			code.reset();
			codeItems.reset();
		}
		
		/**
		 * Gets codes
		 */
		function getCodes(page) {
			return new Promise(function(resolve,reject){
				if(page){
					search.set('page',page);
				}
				var data = {};
				if(search.get('key')){
					data[search.get('key')] = search.get('value');
				}
				data.page = search.get('page');
				data.rows = search.get('rows');
				$.ajax({
					 url: 'code/getCodes'
					,type: 'GET'
					,data: data
				})
				.done(function(data, textStatus, jqXHR) {
					codes.fromJson(data);
					search.set('totalCount', __parseTotalCount(jqXHR));
					resolve(true);
			   	});
			});
		}
		
		/**
		 * Gets specified code
		 */
		function getCode(id){
			$.ajax({
				 url: 'code/getCode'
				,type: 'GET'
				,data: {id:id}
			})
			.done(function(data, textStatus, jqXHR) {
				code.fromJson(data);
				codeItems.fromJson(data.items);
				disableDetail(false);
				code.setReadonly('id', true);
				isNew = false;
			});
		}
		
		/**
		 * Adds code
		 */
		function addCode() {
			initializeDetail();
			disableDetail(false);
			code.setReadonly('id',false);
			code.setFocus('id');
			isNew = true;
		}
		
		/**
		 * Returns duplicate code
		 */
		function isDuplicateCode(id){
			var duplicateCode = false;
			$.ajax({
				 url: 'code/getCode'
				,type: 'GET'
				,data: {id:id}
				,async: false
			})
			.done(function(data, textStatus, jqXHR) {
				if(data && data.id === id){
					duplicateCode = true;
				}
			});
			return duplicateCode;
		}
		
		/**
		 * Saves code
		 */
		async function saveCode(){
			
			// checks changes
			if(isNew === false && isDetailChanged() === false) {
				await duice.alert("[[#{application.global.changeNotFound}]]");
				return false;
			}
			
			// checks id
			if(duice.isEmpty(code.get('id'))){
				code.setFocus('id', '[[#{application.global.enterItem(#{application.code.id})}]]');
				return false;
			}
			if(!duice.isIdFormat(code.get('id'))){
				code.setFocus('id', '[[#{application.global.notValidIdFormat}]]');
				return false;
			}
			
			// checks new code is existed
			if(isNew){
				if(isDuplicateCode(code.get('id'))){
					code.setFocus('id', '[[#{application.global.alreadyRegisteredItem(#{application.code.id})}]]');
					return false;
				}
			}
			
			// checks code name
			if(duice.isEmpty(code.get('name'))){
				code.setFocus('name', '[[#{application.global.enterItem(#{application.code.name})}]]');
				return false;
			}
			
			// enters save process
			if(await duice.confirm("[[#{application.global.saveConfirm(#{application.code})}]]")){
				var data = code.toJson();
				data.items = codeItems.toJson();
				$.ajax({
					 url: 'code/saveCode'
					,type: 'POST'
					,data: JSON.stringify(data)
					,contentType: 'application/json;charset=UTF-8'
				})
				.done(function(data, textStatus, jqXHR) {
					new duice.Alert('[[#{application.global.saveComplete(#{application.code})}]]')
					.onAfterClose(async function(){
						await getCodes();
						
						// refresh list and details
						var index = codes.indexOf(function(row){
							if(row.get('id') === code.get('id')){
								return true;
							}
						});
						if(index > -1){
							initializeDetail();
							codes.selectRow(index);
						}else{
							getCode(code.get('id'));
						}
					})
					.open();
				});
			}
		}
		
		/**
		 * Deletes code
		 */
		function deleteCode(){
			new duice.Confirm("[[#{application.global.deleteConfirm(#{application.code})}]]")
			.onAfterConfirm(function(){
				$.ajax({
					 url: 'code/deleteCode'
					,type: 'DELETE'
					,data: JSON.stringify(user.toJson())
					,contentType: 'application/json;charset=UTF-8'
					,success: function(data, textStatus, jqXHR) {
						new duice.Alert("[[#{application.global.deleteComplete(#{application.global.user})}]]")
						.onAfterClose(async function(){
							await getUsers();
							initializeDetail();
							disableDetail(true);
						}).open();
			   	 	}
				});
			}).open();
		}
		
		/**
		 * Adds code item
		 */
		function addCodeItem() {
			var codeItem = new duice.Map({
				codeId: code.get('id')
			});
			codeItems.addRow(codeItem);
		}
		
		/**
		 * Removes code authority
		 */
		function removeCodeItem(index) {
			codeItems.removeRow(index);
		}
	</script>
	<div class="app-row">
		<div class="app-col" style="width:50%;">
			<!-- ====================================================== -->
			<!-- START:List												-->
			<!-- ====================================================== -->
			<div id="listDiv" class="app-row">
				<div class="app-col">
					<div class="app-row title">
						<div class="app-col bottom">
							<h1>
								<img class="icon large" th:src="@{/static/image/icon_code.png}"/>
								<span data-th-text="#{application.code} + ' ' + #{application.global.management}"></span>
							</h1>
						</div>
					</div>
					<div class="app-row search">
						<div class="app-col">
							<img class="icon" th:src="@{/static/image/icon_search.png}"/>
							<select is="duice-select" data-duice-bind="search,key" style="width:125px;">
								<option value data-th-text="'- '+#{application.global.all}+' -'"></option>
								<option value="id" data-th-text="#{application.code.id}">ID</option>
								<option value="name" data-th-text="#{application.code.name}">Name</option>
							</select>
							<input is="duice-input-text" type="text" data-duice-bind="search,value" style="width:250px;"/>
						</div>
						<div class="app-col right">
							<button class="button" onclick="getCodes(1);">
								<img th:src="@{/static/image/icon_search.png}" class="icon"/>
								<span data-th-text="#{application.global.search}"></span>
							</button>
						</div>
					</div>
					<div class="app-row">
						<div class="app-col">
							<table is="duice-table" 
								data-duice-bind="codes,code" 
								data-duice-selectable="true"
								style="width:100%;">
								<col style="width:70px;"/>
								<col style="width:35%;"/>
								<col/>
								<thead>
									<tr>
										<th data-th-text="#{application.global.no}">No</th>
										<th data-th-text="#{application.code.id}">ID</th>
										<th data-th-text="#{application.code.name}">Name</th>
									</tr>
								</thead>
								<tbody>
									<tr>
										<td class="text-center">
											<span is="duice-scriptlet" data-duice-bind="search">
												return (search.get('rows')*(search.get('page')-1)) + $context.index+1;
											</span>
										</td>
										<td><span is="duice-span" data-duice-bind="code,id"></span></td>
										<td><span is="duice-span" data-duice-bind="code,name"></span></td>
									</tr>
								</tbody>
							</table>
						</div>
					</div>
					<div class="app-row">
						<div class="app-col">
							<small>
								Total
								<span is="duice-span" data-duice-bind="search,totalCount"></span>
								Rows
							</small>
						</div>
						<div class="app-col">
							<ul is="duice-pagination" data-duice-bind="search,page,rows,totalCount" data-duice-size="5">
								<li onclick="getCodes();"></li>
							</ul>
						</div>
						<div class="app-col right">
							<button class="button" onclick="addCode();">
								<img th:src="@{/static/image/icon_add.png}" class="icon"/>
								<span data-th-text="#{application.global.add}"></span>
							</button>
						</div>
					</div>
				</div>
			</div>	
			<!-- ====================================================== -->
			<!-- END:List												-->
			<!-- ====================================================== -->
		</div>
		<div class="app-col" style="width:50%;">
			<!-- ====================================================== -->
			<!-- START:Start Detail										-->
			<!-- ====================================================== -->
			<div id="detailDiv" class="app-row">
				<div class="app-col">	
					<div class="app-row title">
						<div class="app-col bottom">
							<span id="tabButton1" class="tab">
								<img class="icon small" th:src="@{/static/image/icon_code.png}"/>
								<span data-th-text="#{application.code} + ' ' + #{application.global.details}"></span>
							</span>
						</div>
					</div>
					<!-- ====================================================== -->
					<!-- START:Start tabContent1								-->
					<!-- ====================================================== -->
					<div id="tabContent1" class="app-row">
						<div class="app-col">
							<table class="table" style="width:100%;">
								<col style="width:25%;"/>
								<col/>
								<tbody>
									<tr>
										<th><span data-th-text="#{application.code.id}" class="mand">Code ID</span></th>
										<td><input is="duice-input-text" type="text" data-duice-bind="code,id" autocomplete="nope"/></td>
									</tr>
									<tr>
										<th data-th-text="#{application.code.name}">Name</th>
										<td><input is="duice-input-text" type="text" data-duice-bind="code,name"/></td>
									</tr>
									<tr>
										<th data-th-text="#{application.code.description}">Description</th>
										<td><textarea is="duice-textarea" data-duice-bind="code,description" style="height:6rem;"></textarea></td>
									</tr>
									<tr>
										<th>
											<img class="icon" th:src="@{/static/image/icon_codeItem.png}"/>
											<br/>
											<span data-th-text="#{application.code.item}">Code Item</span>
										</th>
										<td>
											<table is="duice-table" 
												data-duice-bind="codeItems,item" 
												data-duice-editable="true"
												style="width:100%;">
												<col style="width:75px;"/>
												<col style="width:35%;"/>
												<col/>
												<col style="width:5%;"/>
												<thead>
													<tr>
														<th data-th-text="#{application.code.item.sequence}">Sequence</th>
														<th data-th-text="#{application.code.item.id}">Item ID</th>
														<th data-th-text="#{application.code.item.name}">Item Name</th>
														<th class="text-center">
															<button class="button small" onclick="addCodeItem();">
																+
															</button>
														</th>
													</tr>
												</thead>
												<tbody>
													<tr>
														<td class="text-center">
															<span is="duice-span" data-duice-bind="item,sequence"></span>
														</td>
														<td><input is="duice-input-text" type="text" data-duice-bind="item,id"/></td>
														<td><input is="duice-input-text" type="text" data-duice-bind="item,name"/></td>
														<td class="text-center">
															<button class="button small" data-index="[@duice[$context.index]]" onclick="removeCodeItem(this.dataset.index);">
																-
															</button>
														</td>
													</tr>
												</tbody>
											</table>
										</td>
									</tr>
								</tbody>
							</table>
							<div class="app-row">
								<div class="app-col right">
									<button id="deleteUserButton" class="button large" onclick="deleteCode();">
										<img th:src="@{/static/image/icon_delete.png}" class="icon"/>
										<span data-th-text="#{application.global.delete}"></span>
									</button>
									<button id="saveUserButton" class="button large" onclick="saveCode();">
										<img th:src="@{/static/image/icon_save.png}" class="icon"/>
										<span data-th-text="#{application.global.save}"></span>
									</button>
								</div>
							</div>
						</div>
					</div>
					<!-- ====================================================== -->
					<!-- END: End tabContent1									-->
					<!-- ====================================================== -->
				</div>
			</div>
			<!-- ====================================================== -->
			<!-- END:Start Detail										-->
			<!-- ====================================================== -->
		</div>
	</div>
</div>

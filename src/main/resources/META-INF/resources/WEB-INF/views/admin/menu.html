<!DOCTYPE html>
<html layout:decorate="~{admin/admin.html}">
<div layout:fragment="content">
	<script>
		// document ready
		$(document).ready(function() {
		    getMenus();
		    disableDetail(true);
		});
	
		var search = new duice.Map({
			page: 1,
			rows: 1000,
			totalCount: -1
		});
		const menus = new duice.List();
		const menu = new duice.Map();
		const menuDisplayAuthorities = new duice.List();
		var isNew = false;
		
		// adds index changed event listener
		menus.onBeforeSelectRow(async function(index){
			if(isDetailChanged()){
				return await new duice.Confirm("[[#{application.message.changeFound}+'\n'+#{application.message.ignoreChange}]]")
				.onAfterConfirm(function(){
					resetDetail();
				})
				.open();
			}
		});
		
		// event listener for select row
		menus.onAfterSelectRow(function(selectedRow){
			getMenu(selectedRow.get('id'));	
		});
		
		// event listner for before move row
		menus.onBeforeMoveRow(async function(sourceRow,targetRow){
			console.log('menus.onBeforeMoveRow', sourceRow.toJson(), targetRow && targetRow.toJson());
			return await new duice.Confirm("[[#{application.message.changePositionConfirm(#{application.label.group})}]]")
			.open();
		});
		
		// event listner for after move row
		menus.onAfterMoveRow(async function(sourceRow,targetRow){
			console.log('menus.onAfterMoveRow', sourceRow.toJson(), targetRow && targetRow.toJson());
			var group = sourceRow;
			var id = group.get('id');
			$.ajax({
				 url: 'menu/changeUpperId'
				,type: 'POST'
				,data: JSON.stringify(group.toJson())
				,contentType: 'application/json;charset=UTF-8'
				,success: function(data, textStatus, jqXHR) {
					new duice.Alert('[[#{application.message.changePositionComplete(#{application.label.group})}]]')
					.onAfterClose(async function(){
						await getMenus();
						menus.forEach(function(row,index){
							if(row.get('id') === id){
								initializeDetail();
								menus.selectRow(index);
								return true;
							}
						});
					}).open();
		   	 	}
			});	
		});
		
		/**
		 * Disables detail
		 */
		function disableDetail(disable){
			menu.setDisable(disable);
			$('#detailDiv').find('button').each(function(index, element){
				$(element).prop('disabled', disable);
			});
		}
		
		/**
		 * Returns detail changed.
		 */
		function isDetailChanged() {
			if(menu.isDirty()
			|| menuDisplayAuthorities.isDirty()
			){
				return true;
			}else{
				return false;
			}
		}
		
		/**
		 * Initiates detail
		 */
		function initializeDetail() {
			menu.fromJson({});
			menuDisplayAuthorities.fromJson([]);
		}
		
		/**
		 * Resets detail
		 */
		function resetDetail(){
			menu.reset();
			menuDisplayAuthorities.reset();
		}
	
		/**
		 * Gets menus
		 * Retrieves list of menu from serer API.
		 */
		function getMenus() {
			return new Promise(function(resolve,reject){
				var data = {};
				data.page = search.get('page');
				data.rows = search.get('rows');
				$.ajax({
					 url: 'menu/getMenus'
					,type: 'GET'
					,data: data
					,success: function(data, textStatus, jqXHR) {
						menus.fromJson(data);
						search.set('totalCount', __parseTotalCount(jqXHR));
						resolve(true);
			   	 	}
				})
				.done(function(data, textStatus, jqXHR) {
					menus.fromJson(data);
					search.set('totalCount', __parseTotalCount(jqXHR));
					resolve(true);
			   	});
			});
		}
		
		/**
		 * Gets specified menu
		 */
		function getMenu(id){
			$.ajax({
				 url: 'menu/getMenu'
				,type: 'GET'
				,data: {id:id}
			})
			.done(function(data, textStatus, jqXHR) {
				menu.fromJson(data);
				menuDisplayAuthorities.fromJson(data.displayAuthorities);
				disableDetail(false);
				menu.setReadonly('id', true);
				isNew = false;
			});
		}
		
		/**
		 * Adds menu
		 */
		function addMenu() {
			initializeDetail();
			disableDetail(false);
			menu.setReadonly('id',false);
			isNew = true;
			menu.setFocus('id');
		}
		
		/**
		 * Returns duplicate menu
		 */
		function isDuplicateMenu(id){
			var duplicateMenu = false;
			$.ajax({
				 url: 'menu/getMenu'
				,type: 'GET'
				,data: {id:id}
				,async: false
			})
			.done(function(data, textStatus, jqXHR) {
				if(data && data.id === id){
					duplicateMenu = true;
				}
			});
			return duplicateMenu;
		}
		
		/**
		 * Saves menu
		 */
		async function saveMenu(){
			
			// checks changes
			if(isNew === false && isDetailChanged() === false) {
				await duice.alert("[[#{application.message.changeNotFound}]]");
				return false;
			}
			
			// checks id
			if(duice.isEmpty(menu.get('id'))){
				menu.setFocus('id', '[[#{application.message.enterItem(#{application.label.id})}]]');
				return false;
			}
			if(!duice.isIdFormat(menu.get('id'))){
				menu.setFocus('id', '[[#{application.message.notValidIdFormat}]]');
				return false;
			}
			
			// checks new menu is existed
			if(isNew){
				if(isDuplicateUser(menu.get('id'))){
					menu.setFocus('id', '[[#{application.message.alreadyRegisteredItem(#{application.label.id})}]]');
					return false;
				}
			}
			
			// checks menu name
			if(duice.isEmpty(menu.get('name'))){
				menu.setFocus('name', '[[#{application.message.enterItem(#{application.label.name})}]]');
				return false;
			}

			
			// enters save process
			if(await duice.confirm("[[#{application.message.saveConfirm(#{application.label.menu})}]]")){
				var data = menu.toJson();
				data.displayAuthorities = menuDisplayAuthorities.toJson();
				$.ajax({
					 url: 'menu/saveMenu'
					,type: 'POST'
					,data: JSON.stringify(data)
					,contentType: 'application/json;charset=UTF-8'
				})
				.done(function(data, textStatus, jqXHR) {
					new duice.Alert('[[#{application.message.saveComplete(#{application.label.menu})}]]')
					.onAfterClose(async function(){
						await getMenus();
						
						// refresh list and details
						var index = menus.indexOf(function(row){
							if(row.get('id') === menu.get('id')){
								return true;
							}
						});
						if(index > -1){
							initializeDetail();
							menus.selectRow(index);
						}else{
							getMenu(menu.get('id'));
						}
					})
					.open();
				});
			}
		}
		
		/**
		 * Deletes menu
		 */
		function deleteMenu(){
			new duice.Confirm("[[#{application.message.deleteConfirm(#{application.label.menu})}]]")
			.onAfterConfirm(function(){
				$.ajax({
					 url: 'menu/deleteMenu'
					,type: 'DELETE'
					,data: JSON.stringify(menu.toJson())
					,contentType: 'application/json;charset=UTF-8'
					,success: function(data, textStatus, jqXHR) {
						new duice.Alert("[[#{application.message.deleteComplete(#{application.label.menu})}]]")
						.onAfterClose(function(){
							getMenus();
						}).open();
			   	 	}
				});
			}).open();
		}
		
		/**
		 * Adds menu display authority
		 */
		function addMenuDisplayAuthority() {
			__authorityDialog.open({
				checkedAuthorities: menuDisplayAuthorities.toJson(),
				disabledAuthorities: menuDisplayAuthorities.toJson(),
				onAfterConfirm: function(selectedAuthorities){
					selectedAuthorities.forEach(function(item){
						menuDisplayAuthorities.addRow(new duice.Map(item));
					});
				}
			});
		}
		
		/**
		 * Removes menu display authority
		 */
		function removeMenuDisplayAuthority(index) {
			menuDisplayAuthorities.removeRow(index);
		}

	</script>

	<div class="app-row">
		<div class="app-col">
			<h1>
				<img class="icon large" th:src="@{/static/image/icon_menu.png}"/>
				<span data-th-text="#{application.label.menu} + ' ' + #{application.label.management}"></span>
			</h1>
		</div>
	</div>
	<hr class="hr"/>
	<div class="app-row">
		<!-- ====================================================== -->
		<!-- List													-->
		<!-- ====================================================== -->
		<div id="listDiv" class="app-col" style="width:50%;">
			<div class="app-row">
				<div class="app-col">
					<ul is="duice-ui-ul" 
					data-duice-selectable="true"
					data-duice-bind="menus,menu" 
					data-duice-hierarchy="id,upperId"
					data-duice-editable="true"
					data-duice-foldable="true">
						<li>
							<div style="border-bottom:dotted 1px #ccc;">
								<img is="duice-ui-img" data-duice-bind="menu,icon" th:src="@{/static/image/icon_menu.png}" class="icon small"/>
								<span is="duice-ui-span" data-duice-bind="menu,name" style="font-weight:bold;"></span>
							</div>
						</li>
					</ul>
				</div>
			</div>		
		</div>
		<!-- ====================================================== -->
		<!-- Start Detail											-->
		<!-- ====================================================== -->
		<div id="detailDiv" class="app-col" style="width:50%;">
			<div class="app-row">
				<div class="app-col">
					<img class="icon" th:src="@{/static/image/icon_menu.png}"/>
					<span data-th-text="#{application.label.menu} + ' ' + #{application.label.details}" class="font-bold"></span>
				</div>
				<div class="app-col right">
					<button id="addMenuButton" class="button" onclick="addMenu();">
						<img th:src="@{/static/image/icon_create.png}" class="icon"/>
						<span data-th-text="#{application.label.new}"></span>
					</button>
					<button id="deleteMenuButton" class="button" onclick="deleteMenu();">
						<img th:src="@{/static/image/icon_delete.png}" class="icon"/>
						<span data-th-text="#{application.label.delete}"></span>
					</button>
					<button id="saveMenuButton" class="button" onclick="saveMenu();">
						<img th:src="@{/static/image/icon_save.png}" class="icon"/>
						<span data-th-text="#{application.label.save}"></span>
					</button>
				</div>
			</div>
			<div class="app-row">
				<div class="app-col">
					<table class="table" style="width:100%;">
						<col style="width:25%;"/>
						<col/>
						<tbody>
							<tr>
								<th><span data-th-text="#{application.label.menu}+' '+#{application.label.id}" class="mand">Menu ID</span></th>
								<td><input is="duice-ui-input" type="text" data-duice-bind="menu,id"/></td>
							</tr>
							<tr>
								<th data-th-text="#{application.label.upper}+' '+#{application.label.menu}">Upper Menu</th>
								<td>
									<span is="duice-ui-span" data-duice-bind="menu,upperId"></span>
									<button class="button small" onclick="openUpperMenuDialog();">
										<img th:src="@{/static/image/icon_change.png}" class="icon"/>
										<span data-th-text="#{application.label.change}">Change</span>
									</button>
								</td>
							</tr>
							<tr>
								<th data-th-text="#{application.label.menu}+' '+#{application.label.icon}">Menu Icon</th>
								<td>
									<img is="duice-ui-img" data-duice-bind="menu,icon" th:src="@{/static/image/icon_menu.png}"/>
								</td>
							</tr>
							<tr>
								<th data-th-text="#{application.label.menu}+' '+#{application.label.name}">Menu Name</th>
								<td><input is="duice-ui-input" type="text" data-duice-bind="menu,name"/></td>
							</tr>
							<tr>
								<th data-th-text="#{application.label.menu}+' '+#{application.label.description}">Description</th>
								<td><textarea is="duice-ui-textarea" data-duice-bind="menu,description" style="height:6rem;"></textarea></td>
							</tr>
							<tr>
								<th data-th-text="#{application.label.link}+' '+#{application.label.url}">Value</th>
								<td><input is="duice-ui-input" type="text" data-duice-bind="menu,linkUrl"/></td>
							</tr>
							<tr>
								<th data-th-text="#{application.label.link}+' '+#{application.label.target}">Menu Type</th>
								<td>
									<select is="duice-ui-select" data-duice-bind="menu,linkTarget">
										<option value="_self">_self</option>
										<option value="_blank">_blank</option>
									</select>
								</td>
							</tr>
							<tr>
								<th>
									<span data-th-text="#{application.label.display}+' '+#{application.label.policy}"></span>
								</th>
								<td>
									<select is="duice-ui-select" data-duice-bind="menu,displayPolicy">
										<option> - select - </option>
										<option value="ANONYMOUS">ANONYMOUS</option>
										<option value="AUTHENTICATED">AUTHENTICATED</option>
										<option value="AUTHORIZED">AUTHORIZED</option>
									</select>
									<table is="duice-ui-table" 
										data-duice-bind="menuDisplayAuthorities,authority" 
										style="width:100%;">
										<col style="width:50px;"/>
										<col style="width:35%;"/>
										<col/>
										<col style="width:5%;"/>
										<thead>
											<tr>
												<th data-th-text="#{application.label.no}">No</th>
												<th data-th-text="#{application.label.id}">ID</th>
												<th data-th-text="#{application.label.name}">Name</th>
												<th class="text-center">
													<button class="button small" onclick="addMenuDisplayAuthority();">
														+
													</button>
												</th>
											</tr>
										</thead>
										<tbody>
											<tr>
												<td class="text-center">
													<span is="duice-ui-scriptlet" data-duice-bind="authority">return $context.index+1;</span>
												</td>
												<td>
													<img is="duice-ui-img" data-duice-bind="authority,icon" th:src="@{/static/image/icon_authority.png}" class="icon small"/>
													<span is="duice-ui-span" data-duice-bind="authority,id"></span>
												</td>
												<td><span is="duice-ui-span" data-duice-bind="authority,name"></span></td>
												<td class="text-center">
													<button class="button small" data-index="[[$context.index]]" onclick="removeMenuDisplayAuthority(this.dataset.index);">
														-
													</button>
												</td>
											</tr>
										</tbody>
									</table>
								</td>
							</tr>
						</tbody>
					</table>
				</div>
			</div>
		</div>
	</div>
	
	<!-- ====================================================== -->
	<!-- upperMenuDialog									-->
	<!-- ====================================================== -->
	<script>
		const upperMenus = new duice.List();
		upperMenus.onAfterSelectRow(function(row){
			
			// skip row is disabled.
			console.log(row.isDisable());
			if(row.isDisable()){
				return;				
			}
			
			// release other items
			upperMenus.forEach(function(item){
				if(item.get('id') !== row.get('id')){
					item.set('__checked', false);	
				}				
			});
			
			// toggles __checked in current row.
			var __checked = row.get('__checked');
			if(__checked === true){
				row.set('__checked', false);
			}else{
				row.set('__checked', true);
			}
		});
	</script>
	<dialog id="upperMenuDialog" style="width:600px;">
		<div class="app-row">
			<div class="app-col">
				<img class="icon" th:src="@{/static/image/icon_group.png}"/>
				<span data-th-text="#{application.label.group} + ' ' + #{application.label.select}" class="font-bold"></span>
			</div>
		</div>
		<hr class="hr"/>
		<div class="app-row">
			<div class="app-col">
				<ul is="duice-ui-ul" 
				data-duice-bind="upperMenus,menu" 
				data-duice-hierarchy="id,upperId"
				data-duice-selectable="true"
				data-duice-foldable="true"
				style="max-height:600px; overflow-y:scroll;">
					<li>
						<div class="app-row" style="width:95%;border-bottom:dotted 1px #ccc;">
							<div class="app-col">
								<img is="duice-ui-img" data-duice-bind="menu,icon" th:src="@{/static/image/icon_group.png}" class="icon small"/>
								<span is="duice-ui-span" data-duice-bind="menu,name" style="font-weight:bold;"></span>
							</div>
							<div class="app-col text-right">
								<input is="duice-ui-input" type="checkbox" data-duice-bind="menu,__checked"/>
							</div>
						</div>
					</li>
				</ul>				
			</div>
		</div>
		<div class="app-row">
			<div class="app-col right">
				<button class="button" onclick="changeUpperMenu();">
					<img th:src="@{/static/image/icon_confirm.png}" class="icon small"/>
					OK
				</button>
			</div>
		</div>
	</dialog>
	<script>
		var upperMenuDialog = new duice.Dialog($('#upperMenuDialog')[0]);
	
		/**
		 * Changes password
		 */
		function openUpperMenuDialog() {
			$.ajax({
				 url: 'menu/getMenus'
				,type: 'GET'
				,data: {}
			})
			.done(function(data, textStatus, jqXHR) {
				upperMenus.fromJson(data);
				var id = menu.get('id');
				var upperId = menu.get('upperId');
				
				// checked current parent menu
				upperMenus.forEach(function(row){
					// set checked upper menu
					if(row.get('id') === upperId) {
						row.set('__checked', true);
					}else{
						row.set('__checked', false);
					}
					// sets diable self
					if(row.get('id') === id){
						row.setDisable(true);
					}
				});
				
				// make child nodes to be disabled.
				function disablbeChildMenu(menu){
					upperMenus.forEach(function(row){
						if(row.get('upperId') === menu.get('id')){
							row.setDisable(true);
							findChildMenu(row);
						}
					});
				}
				disablbeChildMenu(menu);
				
				// opens dialog
				upperMenuDialog.open();
			});
		}
		
		/**
		 * Confirms change password
		 */
		function changeUpperMenu() {
			var checkedIndex = upperMenus.indexOf(function(row){
				if(row.get('__checked') === true){
					return true;
				}
			});
			if(checkedIndex > -1){
				var newUpperId = upperMenus.getRow(checkedIndex).get('id');
				menu.set('upperId', newUpperId);
			}else{
				menu.set('upperId', null);
			}
			upperMenuDialog.close();
		}
	</script>

	
</div>










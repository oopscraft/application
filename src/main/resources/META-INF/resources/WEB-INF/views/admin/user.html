<!DOCTYPE html>
<html layout:decorate="~{admin/admin.html}">
<div layout:fragment="content">
	<script>
	// defines variables
	const search = new duice.Map({
		key: null,
		value: null,
		status: null,
		page: 1,
		rows: 20,
		totalCount: -1
	});
	const tabFolder = new duice.TabFolder();
	const users = new duice.List();
	const user = new duice.Map();
	const userGroups = new duice.List();
	const userRoles = new duice.List();
	const userAuthorities = new duice.List();
	const userAvailableAuthorities = new duice.List();
	users.setReadonlyAll(true);
	userGroups.setReadonlyAll(true);
	userRoles.setReadonlyAll(true);
	userAuthorities.setReadonlyAll(true);
	userAvailableAuthorities.setReadonlyAll(true);
	var isNew = false;
	
	// handle when search option is changed.
	search.onAfterChange(function(name, value){
		// if select all option, reset value. 
		if(name === 'key' && !value){
			search.set('value',null);				
		}
	});
	
	// checks when select row is changed.
	users.onBeforeSelectRow(async function(selectedRow){
		if(isDetailChanged()){
			if(await duice.confirm("[[#{application.global.changeFound}+'\n'+#{application.global.ignoreChange}]]")){
				resetDetail();
				return true;
			}else{
				return false;
			}
		}
	});
	
	// event listener for select row
	users.onAfterSelectRow(function(selectedRow){
		getUser(selectedRow.get('id'));
	});
	
	// checks user properties change
	user.onBeforeChange(async function(name,value){
		if(name === 'id'){
			if(await isDuplicateUser(value)){
				user.setFocus('id', '[[#{application.global.alreadyRegisteredItem(#{application.user.id})}]]');
			}
		}
	});
	
	// document ready
	$(document).ready(function() {
		
		// checks authorization
		if([[${!#authorization.expression('hasAuthority("ADMN_USER_EDIT")')}]]){
			lockDetails();
		}
		
		// creates tab
		tabFolder.addTab(new duice.Tab(document.getElementById('tabButton1'), document.getElementById('tabContent1')));
		tabFolder.addTab(new duice.Tab(document.getElementById('tabButton2'), document.getElementById('tabContent2')));
		tabFolder.onAfterSelectTab(function(selectedTab){
			if(user.get('id')){
				// tabButton2
				if(selectedTab.getButton() === document.getElementById('tabButton2')){
					getUserAvailableAuthorities(user.get('id'));
				}
			}
		});
		tabFolder.selectTab(0);

		// gets users
	    getUsers();
	    disableDetail(true);
	});
	
	/**
	 * Disables detail
	 */
	function disableDetail(disable){
		user.setDisableAll(disable);
		$('#detailDiv').find('button').each(function(index, element){
			$(element).prop('disabled', disable);
		});
	}
	
	/**
	 * Returns detail changed.
	 */
	function isDetailChanged() {
		if(user.isDirty()
		|| userGroups.isDirty()
		|| userRoles.isDirty()
		|| userAuthorities.isDirty()
		){
			return true;
		}else{
			return false;
		}
	}
	
	/**
	 * Initializes detail
	 */
	function initializeDetail() {
		user.fromJson({});
		userGroups.fromJson([]);
		userRoles.fromJson([]);
		userAuthorities.fromJson([]);
		userAvailableAuthorities.fromJson([]);
	}
	
	/**
	 * Resets detail
	 */ 
	function resetDetail() {
		user.reset();
		userGroups.reset();
		userRoles.reset();
		userAuthorities.reset();
	}

	/**
	 * Lock details
	 */
	function lockDetails(){
		user.setReadonlyAll(true);
		userGroups.setReadonlyAll(true);
		userRoles.setReadonlyAll(true);
		userAuthorities.setReadonlyAll(true);
	}
	
	/**
	 * Gets users
	 */
	function getUsers(page) {
		return new Promise(function(resolve,reject){
			if(page){
				search.set('page',page);
			}
			var data = {};
			if(search.get('key')){
				data[search.get('key')] = search.get('value');
			}
			if(search.get('status')){
				data.status = search.get('status');
			}
			data.page = search.get('page');
			data.rows = search.get('rows');
			$.ajax({
				 url: 'user/getUsers'
				,type: 'GET'
				,data: data
			})
			.done(function(data, textStatus, jqXHR) {
				users.fromJson(data);
				search.set('totalCount', __parseTotalCount(jqXHR));
				resolve(true);
		   	});
		});
	}
	
	/**
	 * Gets specified user
	 */
	function getUser(id){
		initializeDetail();
		$.ajax({
			 url: 'user/getUser'
			,type: 'GET'
			,data: {id:id}
		})
		.done(function(data, textStatus, jqXHR) {
			user.fromJson(data);
			userGroups.fromJson(data.groups);
			userRoles.fromJson(data.roles);
			userAuthorities.fromJson(data.authorities);
			disableDetail(false);
			user.setReadonly('id', true);
			$('#passwordTr').hide();
			$('#passwordConfirmTr').hide();
			$('#changePasswordTr').show();
			isNew = false;
			tabFolder.selectTab(0);
		});
	}
	
	/**
	 * Gets user available authorities
	 */
	function getUserAvailableAuthorities(id){
		$.ajax({
			 url: 'user/getAvailableAuthorities'
			,type: 'GET'
			,data: {id:id}
		})
		.done(function(data, textStatus, jqXHR) {
			userAvailableAuthorities.fromJson(data);
		});
	}
	
	/**
	 * Adds user
	 */
	function addUser() {
		initializeDetail();
		disableDetail(false);
		isNew = true;
		user.setReadonly('id',false);
		user.setFocus('id');
		$('#passwordTr').show();
		$('#passwordConfirmTr').show();
		$('#changePasswordTr').hide();
	}
	
	/**
	 * Returns duplicate user
	 */
	function isDuplicateUser(id){
		return new Promise(function(resolve, reject){
			$.ajax({
				 url: 'user/getUser'
				,type: 'GET'
				,data: {id:id}
			})
			.done(function(data, textStatus, jqXHR) {
				if(data && data.id === id){
					resolve(true);
				}else{
					resolve(false)
				}
			});
		});
	}
	
	/**
	 * Saves user
	 */
	async function saveUser(){
		
		// checks changes
		if(isNew === false && isDetailChanged() === false) {
			duice.alert("[[#{application.global.changeNotFound}]]").open();
			return false;
		}

		// checks id
		if(duice.isEmpty(user.get('id'))){
			user.setFocus('id', '[[#{application.global.enterItem(#{application.user.id})}]]');
			return false;
		}
		if(!duice.isIdFormat(user.get('id'))){
			user.setFocus('id', '[[#{application.global.notValidIdFormat}]]');
			return false;
		}
		if(isNew){
			if(await isDuplicateUser(user.get('id'))){
				user.setFocus('id', '[[#{application.global.alreadyRegisteredItem(#{application.user.id})}]]');
				return false;
			}
		}
		
		// checks email
		if(duice.isEmpty(user.get('email'))){
			user.setFocus('email', '[[#{application.global.enterItem(#{application.user.email})}]]');
			return false;
		}
		if(!duice.isEmailFormat(user.get('email'))){
			user.setFocus('email', '[[#{application.global.notValidItemFormat(#{application.user.email})}]]');
			return false;
		}
		
		// new
		if(isNew) {
			
			// password
			if(duice.isEmpty(user.get('password'))){
				user.setFocus('password', '[[#{application.global.enterItem(#{application.user.password})}]]');
				return false;
			}
			if(!duice.isPasswordFormat(user.get('password'))){
				user.setFocus('password', '[[#{application.global.notValidPassowrdFormat}]]');
				return false;
			}
			
			// passwordConfirm
			if(duice.isEmpty(user.get('passwordConfirm'))){
				user.setFocus('passwordConfirm', '[[#{application.global.enterItem(#{application.user.passwordConfirm})}]]');
				return false;
			}
			if(user.get('passwordConfirm') !== user.get('password')){
				user.setFocus('passwordConfirm', '[[#{application.global.itemNotMatch(#{application.user.passwordConfirm})}]]');
				return false;
			}
		}
		
		// status
		if(duice.isEmpty(user.get('status'))){
			user.setFocus('status', '[[#{application.global.enterItem(#{application.user.status})}]]');
			return false;
		}
		
		// name
		if(duice.isEmpty(user.get('name'))){
			user.setFocus('name', '[[#{application.global.enterItem(#{application.user.name})}]]');
			return false;
		}

		// enters save process
		if(await duice.confirm("[[#{application.global.saveConfirm(#{application.user})}]]")){
			var data = user.toJson();
			data.groups = userGroups.toJson();
			data.roles = userRoles.toJson();
			data.authorities = userAuthorities.toJson();
			$.ajax({
				 url: 'user/saveUser'
				,type: 'POST'
				,data: JSON.stringify(data)
				,contentType: 'application/json;charset=UTF-8'
			})
			.done(function(data, textStatus, jqXHR) {
				new duice.Alert('[[#{application.global.saveComplete(#{application.user})}]]')
				.onAfterClose(async function(){
					await getUsers();
					
					// refresh list and details
					var index = users.indexOf(function(row){
						if(row.get('id') === user.get('id')){
							return true;
						}
					});
					if(index > -1){
						initializeDetail();
						users.selectRow(index);
					}else{
						getUser(user.get('id'));
					}
				})
				.open();
			});
		}
	}
	
	/**
	 * Deletes user
	 */
	function deleteUser(){
		new duice.Confirm("[[#{application.global.deleteConfirm(#{application.user})}]]")
		.onAfterConfirm(function(){
			$.ajax({
				 url: 'user/deleteUser'
				,type: 'DELETE'
				,data: JSON.stringify(user.toJson())
				,contentType: 'application/json;charset=UTF-8'
			})
			.done(function(data, textStatus, jqXHR) {
				new duice.Alert("[[#{application.global.deleteComplete(#{application.user})}]]")
				.onAfterClose(async function(){
					await getUsers();
					initializeDetail();
					disableDetail(true);
				}).open();
			});
		}).open();
	}
	
	/**
	 * Adds user group
	 */
	function addUserGroup() {
		__groupDialog.open({
			checkedGroups: userGroups.toJson(),
			disabledGroups: userGroups.toJson(),
			onAfterConfirm: function(returnGroups){
				returnGroups.forEach(function(group){
					userGroups.addRow(new duice.Map(group));
				});
			}
		});
	}
	
	/**
	 * Removes user group
	 */
	function removeUserGroup(index) {
		userGroups.removeRow(index);
	}
	
	/**
	 * Adds user role
	 */
	function addUserRole() {
		__roleDialog.open({
			checkedRoles: userRoles.toJson(),
			disabledRoles: userRoles.toJson(),
			onAfterConfirm: function(selectedRoles){
				selectedRoles.forEach(function(item){
					userRoles.addRow(new duice.Map(item));
				});
			}
		});
	}
	
	/**
	 * Removes user role
	 */
	function removeUserRole(index) {
		userRoles.removeRow(index);
	}
	
	/**
	 * Adds user authority
	 */
	function addUserAuthority() {
		__authorityDialog.open({
			checkedAuthorities: userAuthorities.toJson(),
			disabledAuthorities: userAuthorities.toJson(),
			onAfterConfirm: function(selectedAuthorities){
				selectedAuthorities.forEach(function(item){
					userAuthorities.addRow(new duice.Map(item));
				});
			}
		});
	}
	
	/**
	 * Removes user authority
	 */
	function removeUserAuthority(index) {
		userAuthorities.removeRow(index);
	}
	</script>
	<div class="app-row">
		<div class="app-col" style="width:50%;">
			<!-- ====================================================== -->
			<!-- START:List												-->
			<!-- ====================================================== -->
			<div id="listDiv" class="app-row">
				<div class="app-col">
					<div class="app-row title">
						<div class="app-col bottom">
							<h1>
								<img class="icon large" th:src="@{/static/image/icon_user.png}"/>
								<span data-th-text="#{application.user} + ' ' + #{application.global.management}"></span>
							</h1>
						</div>
					</div>
					<div class="app-row search">
						<div class="app-col">
							<img class="icon" th:src="@{/static/image/icon_search.png}"/>
							<select is="duice-select" data-duice-bind="search,key" style="width:125px;">
								<option value data-th-text="'- '+#{application.global.all}+' -'"></option>
								<option value="id" data-th-text="#{application.user.id}">ID</option>
								<option value="name" data-th-text="#{application.user.name}">Name</option>
								<option value="email" data-th-text="#{application.user.email}">Email</option>
							</select>
							<input is="duice-input" type="text" data-duice-bind="search,value" style="width:250px;"/>
							&nbsp;
							<span data-th-text="#{application.user.status}">Status</span>
							<select is="duice-select" data-duice-bind="search,status" style="width:125px;">
								<option value data-th-text="'- '+#{application.global.all}+' -'"></option>
								<option th:each="status:${Status}" th:value="${status}" th:text="#{'application.user.status.'+${status}}"></option>
							</select>
						</div>
						<div class="app-col right">
							<button class="button" onclick="getUsers(1);">
								<img th:src="@{/static/image/icon_search.png}" class="icon"/>
								<span data-th-text="#{application.global.search}"></span>
							</button>
						</div>
					</div>
					<div class="app-row">
						<div class="app-col">
							<table is="duice-table" 
								data-duice-bind="users,user" 
								data-duice-selectable="true"
								style="width:100%;">
								<col style="width:10%;"/>
								<col/>
								<col/>
								<col/>
								<col/>
								<col style="width:110px;"/>
								<thead>
									<tr>
										<th data-th-text="#{application.global.no}" class="text-center">No</th>
										<th data-th-text="#{application.user.id}">ID</th>
										<th data-th-text="#{application.user.email}">Email</th>
										<th data-th-text="#{application.user.name}">Name</th>
										<th data-th-text="#{application.user.nickname}">Nickname</th>
										<th data-th-text="#{application.user.status}">Status</th>
									</tr>
								</thead>
								<tbody>
									<tr>
										<td class="text-center">
											<small is="duice-scriptlet" data-duice-bind="users" data-duice-value="
												return (search.get('rows')*(search.get('page')-1)) + $context.index+1;
											">
											</small>
										</td>
										<td>
											<img is="duice-img" data-duice-bind="user,photo" th:src="@{/static/image/icon_user.png}" class="icon small"/>
											<span is="duice-span" data-duice-bind="user,id" class="id [@duice[$context.user.get('systemEmbedded') === true ? 'embd' : '']]"></span>
										</td>
										<td><span is="duice-span" data-duice-bind="user,email"></span></td>
										<td><span is="duice-span" data-duice-bind="user,name"></span></td>
										<td><span is="duice-span" data-duice-bind="user,nickname"></span></td>
										<td class="text-center">
											<select is="duice-select" data-duice-bind="user,status">
												<option th:each="status:${Status}" th:value="${status}" th:text="#{'application.user.status.'+${status}}"></option>
											</select>
										</td>
									</tr>
								</tbody>
							</table>
						</div>
					</div>
					<div class="app-row">
						<div class="app-col">
							<small>
								Total
								<span is="duice-span" data-duice-bind="search,totalCount"></span>
								Rows
							</small>
						</div>
						<div class="app-col center">
							<ul is="duice-widget-pagination" data-duice-bind="search,page,rows,totalCount" data-duice-size="5">
								<li data-page="[@duice[$context.page]]" onclick="getUsers(this.dataset.page);"></li>
							</ul>
						</div>
						<div class="app-col right">
							<button class="button" onclick="addUser();" th:classappend="!${#authorization.expression('hasAuthority(''ADMN_USER_EDIT'')')}?'lock'">
								<img th:src="@{/static/image/icon_add.png}" class="icon"/>
								<span data-th-text="#{application.global.add}"></span>
							</button>
						</div>
					</div>
				</div>
			</div>
			<!-- ====================================================== -->
			<!-- END:List												-->
			<!-- ====================================================== -->
		</div>
		<div class="app-col" style="width:50%;">
			<!-- ====================================================== -->
			<!-- START:Start Detail										-->
			<!-- ====================================================== -->
			<div id="detailDiv" class="app-row">
				<div class="app-col">
					<div class="app-row title">
						<div class="app-col bottom">
							<span id="tabButton1" class="tab">
								<img class="icon small" th:src="@{/static/image/icon_user.png}"/>
								<span data-th-text="#{application.user} + ' ' + #{application.global.details}"></span>
							</span>
							<span id="tabButton2" class="tab">
								<img class="icon small" th:src="@{/static/image/icon_authority.png}"/>
								<span data-th-text="#{application.global.available} + ' ' + #{application.user.authorities}"></span>
							</span>
						</div>
					</div>
					<!-- ====================================================== -->
					<!-- START:Start tabContent1								-->
					<!-- ====================================================== -->
					<div id="tabContent1" class="app-row">
						<div class="app-col">
							<table class="table" style="width:100%;">
								<col style="width:25%;"/>
								<col/>
								<tbody>
									<tr>
										<th><span data-th-text="#{application.user.id}" class="mand">ID</span></th>
										<td><input id="userId" is="duice-input" type="text" class="id" data-duice-bind="user,id" pattern="^[a-zA-Z0-9_-]{1,32}$" autocomplete="nope"/></td>
									</tr>
									<tr>
										<th><span data-th-text="#{application.user.email}" class="mand">Email</span></th>
										<td>
											<input is="duice-input" type="text" data-duice-bind="user,email"/>
										</td>
									</tr>
									<tr id="passwordTr">
										<th><span data-th-text="#{application.user.password}" class="mand">Password</span></th>
										<td>
											<input is="duice-input" type="password" data-duice-bind="user,password"/>
										</td>
									</tr>
									<tr id="passwordConfirmTr">
										<th><span data-th-text="#{application.user.passwordConfirm}" class="mand">Password(Confirm)</span></th>
										<td>
											<input is="duice-input" type="password" data-duice-bind="user,passwordConfirm"/>
										</td>
									</tr>
									<tr id="changePasswordTr">
										<th><span data-th-text="#{application.user.password}" class="mand">Password</span></th>
										<td>
											<button id="changePasswordButton" class="button" onclick="openChangePassword();" th:classappend="!${#authorization.expression('hasAuthority(''ADMN_USER_EDIT'')')}?'lock'">
												<img th:src="@{/static/image/icon_password.png}" class="icon"/>
												<span data-th-text="#{application.user.changePassword}"></span>
											</button>
										</td>
									</tr>
									<tr>
										<th><span data-th-text="#{application.user.status}" class="mand">Status</span></th>
										<td>
											<select is="duice-select" data-duice-bind="user,status">
												<option value data-th-text="'- '+#{application.global.select}+' -'"></option>
												<option th:each="status:${Status}" th:value="${status}" th:text="#{'application.user.status.'+${status}}"></option>
											</select>
										</td>
									</tr>
									<tr>
										<th><span data-th-text="#{application.user.name}" class="mand">Name</span></th>
										<td><input is="duice-input" type="text" data-duice-bind="user,name"/></td>
									</tr>
									<tr>
										<th data-th-text="#{application.user.nickname}">Nickname</th>
										<td><input is="duice-input" type="text" data-duice-bind="user,nickname"/></td>
									</tr>
									<tr>
										<th data-th-text="#{application.user.mobile}">Mobile</th>
										<td>
											<div class="app-row">
												<div class="app-col" style="width:25%;">
													<select is="duice-select" data-duice-bind="user,mobileCountry">
														<option value data-th-text="'- '+#{application.global.select}+' -'"></option>
														<option th:each="country:${__countries}" th:value="${country.country}" th:text="${country.displayCountry}"></option>
													</select>
												</div>
												<div class="app-col" style="width:75%;">
													<input is="duice-input" type="text" data-duice-bind="user,mobileNumber"/>
												</div>
											</div>
										</td>
									</tr>
									<tr>
										<th data-th-text="#{application.user.photo}">Photo</th>
										<td><img is="duice-img" data-duice-bind="user,photo" th:src="@{/static/image/icon_user.png}" style="max-height:64px;"/></td>
									</tr>
									<tr>
										<th data-th-text="#{application.user.profile}">Profile</th>
										<td><textarea is="duice-textarea" data-duice-bind="user,profile" style="height:100px;"></textarea></td>
									</tr>
									<tr>
										<th data-th-text="#{application.user.language}">Locale</th>
										<td>
											<select is="duice-select" data-duice-bind="user,language">
												<option value data-th-text="'- '+#{application.global.select}+' -'"></option>
												<option th:each="language:${__languages}" th:value="${language.language}" th:text="${language.displayLanguage}"></option>
											</select>
										</td>
									</tr>
									<tr>
										<th data-th-text="#{application.user.joinDate}">Join Date</th>
										<td>
											<small style="font-weight:bold;">
												<span is="duice-span" data-duice-bind="user,joinDate" data-duice-mask="date,yyyy-MM-dd HH:mm:ss"></span>
											</small>
										</td>
									</tr>
									<tr>
										<th data-th-text="#{application.user.closeDate}">Close Date</th>
										<td>
											<small style="font-weight:bold;">
												<span is="duice-span" data-duice-bind="user,closeDate" data-duice-mask="date,yyyy-MM-dd HH:mm:ss"></span>
											</small>
									</tr>
									<tr>
										<th>
											<img class="icon" th:src="@{/static/image/icon_group.png}"/>
											<br/>
											<span data-th-text="#{application.user.groups}"></span>
										</th>
										<td>
											<div style="width:100%; max-height:177px; overflow-y:scroll;">
												<table is="duice-table" 
												data-duice-bind="userGroups,group" style="width:100%;">
													<col style="width:15%;"/>
													<col style="width:30%;"/>
													<col/>
													<col style="width:5%;"/>
													<thead>
														<tr>
															<th data-th-text="#{application.global.no}" class="text-center"></th>
															<th data-th-text="#{application.group.id}"></th>
															<th data-th-text="#{application.group.name}"></th>
															<th class="text-center">
																<img class="icon small button" th:src="@{/static/image/icon_add.png}" onclick="addUserGroup();" th:classappend="!${#authorization.expression('hasAuthority(''ADMN_USER_EDIT'')')}?'lock'"/>
															</th>
														</tr>
													</thead>
													<tbody>
														<tr>
															<td class="text-center">
																<small is="duice-scriptlet" data-duice-bind="group" data-duice-value="return $context.index+1;"></small>
															</td>
															<td>
																<img is="duice-img" data-duice-bind="group,icon" th:src="@{/static/image/icon_group.png}" class="icon small"/>
																<span is="duice-span" data-duice-bind="group,id"></span>
															</td>
															<td><span is="duice-span" data-duice-bind="group,name"></span></td>
															<td class="text-center">
																<img class="icon small button" th:src="@{/static/image/icon_remove.png}" data-index="[@duice[$context.index]]" onclick="removeUserGroup(this.dataset.index);" th:classappend="!${#authorization.expression('hasAuthority(''ADMN_USER_EDIT'')')}?'lock'"/>
															</td>
														</tr>
													</tbody>
												</table>
											</div>
										</td>
									</tr>
									<tr>
										<th>
											<img class="icon" th:src="@{/static/image/icon_role.png}"/>
											<br/>
											<span data-th-text="#{application.user.roles}"></span>
										</th>
										<td>
											<div style="width:100%; max-height:177px; overflow-y:scroll;">
												<table is="duice-table" 
												data-duice-bind="userRoles,role" 
												style="width:100%;">
													<col style="width:15%;"/>
													<col style="width:30%;"/>
													<col/>
													<col style="width:5%;"/>
													<thead>
														<tr>
															<th data-th-text="#{application.global.no}" class="text-center"></th>
															<th data-th-text="#{application.role.id}">ID</th>
															<th data-th-text="#{application.role.name}">Name</th>
															<th class="text-center">
																<img th:src="@{/static/image/icon_add.png}" class="icon small button" onclick="addUserRole();" th:classappend="!${#authorization.expression('hasAuthority(''ADMN_USER_EDIT'')')}?'lock'">
															</th>
														</tr>
													</thead>
													<tbody>
														<tr>
															<td class="text-center">
																<small is="duice-scriptlet" data-duice-bind="role" data-duice-value="return $context.index+1;"></small>
															</td>
															<td>
																<img is="duice-img" data-duice-bind="role,icon" th:src="@{/static/image/icon_role.png}" class="icon small"/>
																<span is="duice-span" data-duice-bind="role,id"></span>
															</td>
															<td><span is="duice-span" data-duice-bind="role,name"></span></td>
															<td class="text-center">
																<img th:src="@{/static/image/icon_remove.png}" class="icon small button" data-index="[@duice[$context.index]]" onclick="removeUserRole(this.dataset.index);" th:classappend="!${#authorization.expression('hasAuthority(''ADMN_USER_EDIT'')')}?'lock'">
															</td>
														</tr>
													</tbody>
												</table>
											</div>
										</td>
									</tr>
									<tr>
										<th>
											<img class="icon" th:src="@{/static/image/icon_authority.png}"/>
											<br/>
											<span data-th-text="#{application.user.authorities}"></span>
										</th>
										<td>
											<div style="width:100%; max-height:177px; overflow-y:scroll;">
												<table is="duice-table" 
													data-duice-bind="userAuthorities,authority" 
													style="width:100%;">
													<col style="width:15%;"/>
													<col style="width:30%;"/>
													<col/>
													<col style="width:5%;"/>
													<thead>
														<tr>
															<th data-th-text="#{application.global.no}" class="text-center"></th>
															<th data-th-text="#{application.authority.id}"></th>
															<th data-th-text="#{application.authority.name}"></th>
															<th class="text-center">
																<img th:src="@{/static/image/icon_add.png}" class="icon small button" onclick="addUserAuthority();" th:classappend="!${#authorization.expression('hasAuthority(''ADMN_USER_EDIT'')')}?'lock'"/>
															</th>
														</tr>
													</thead>
													<tbody>
														<tr>
															<td class="text-center">
																<small is="duice-scriptlet" data-duice-bind="authority" data-duice-value="return $context.index+1;"></small>
															</td>
															<td>
																<img is="duice-img" data-duice-bind="authority,icon" th:src="@{/static/image/icon_authority.png}" class="icon small"/>
																<span is="duice-span" data-duice-bind="authority,id"></span>
															</td>
															<td><span is="duice-span" data-duice-bind="authority,name"></span></td>
															<td class="text-center">
																<img th:src="@{/static/image/icon_remove.png}" class="icon small button" data-index="[@duice[$context.index]]" onclick="removeUserAuthority(this.dataset.index);" th:classappend="!${#authorization.expression('hasAuthority(''ADMN_USER_EDIT'')')}?'lock'"/>
															</td>
														</tr>
													</tbody>
												</table>
											</div>
										</td>
									</tr>
								</tbody>
							</table>
							<div class="app-row action">
								<div class="app-col right">
									<button class="button" onclick="deleteUser();" th:classappend="!${#authorization.expression('hasAuthority(''ADMN_USER_EDIT'')')}?'lock'">
										<img th:src="@{/static/image/icon_delete.png}" class="icon"/>
										<span data-th-text="#{application.global.delete}"></span>
									</button>
									<button class="button" onclick="saveUser();" th:classappend="!${#authorization.expression('hasAuthority(''ADMN_USER_EDIT'')')}?'lock'">
										<img th:src="@{/static/image/icon_save.png}" class="icon"/>
										<span data-th-text="#{application.global.save}"></span>
									</button>
								</div>
							</div>
						</div>
					</div>
					<!-- ====================================================== -->
					<!-- END: End tabContent1									-->
					<!-- ====================================================== -->
					<!-- ====================================================== -->
					<!-- START: Start tabContent2								-->
					<!-- ====================================================== -->
					<div id="tabContent2" class="app-row">
						<div class="app-col">
							<div style="width:100%; max-height:800px; overflow-y:scroll; border:solid 1px #dee2e6;">
								<table is="duice-table" 
									data-duice-bind="userAvailableAuthorities,authority" 
									style="width:100%; border:none;">
									<col style="width:10%;"/>
									<col/>
									<col/>
									<col/>
									<thead>
										<tr>
											<th data-th-text="#{application.global.no}" class="text-center">No</th>
											<th data-th-text="#{application.authority.id}">ID</th>
											<th data-th-text="#{application.authority.name}">Name</th>
											<th data-th-text="#{application.authority.holder}">Holder</th>
										</tr>
									</thead>
									<tbody>
										<tr>
											<td class="text-center">
												<small is="duice-scriptlet" data-duice-bind="authority" data-duice-value="return $context.index+1;"></small>
											</td>
											<td>
												<img is="duice-img" data-duice-bind="authority,icon" th:src="@{/static/image/icon_authority.png}" class="icon small"/>
												<span is="duice-span" data-duice-bind="authority,id"></span>
											</td>
											<td><span is="duice-span" data-duice-bind="authority,name"></span></td>
											<td><span is="duice-span" data-duice-bind="authority,holder"></span></td>
										</tr>
									</tbody>
								</table>
							</div>
						</div>
					</div>
					<!-- ====================================================== -->
					<!-- END: End tabContent2									-->
					<!-- ====================================================== -->
				</div>
			</div>
			<!-- ====================================================== -->
			<!-- END:Start Detail										-->
			<!-- ====================================================== -->
		</div>
	</div>
	
	<!-- ====================================================== -->
	<!-- START: changePasswordDialog							-->
	<!-- ====================================================== -->
	<script>
	var changePassword = new duice.Map();
	</script>
	<dialog is="duice-dialog" id="changePasswordDialog" style="width:400px;">
		<div class="app-row">
			<div class="app-col">
				<h2>
					<img class="icon" th:src="@{/static/image/icon_password.png}"/>
					<span data-th-text="#{application.user.changePassword}" class="font-bold"></span>
				</h2>
			</div>
		</div>
		<div class="app-row">
			<div class="app-col">
				<table class="table" style="width:100%;">
					<col style="width:35%;"/>
					<col/>
					<tbody>
						<tr>
							<th><span data-th-text="#{application.user.password}" class="mand">Password</span></th>
							<td>
								<input is="duice-input" type="password" data-duice-bind="changePassword,password"/>
							</td>
						</tr>
						<tr>
							<th><span data-th-text="#{application.user.passwordConfirm}" class="mand">Password(Confirm)</span></th>
							<td>
								<input is="duice-input" type="password" data-duice-bind="changePassword,passwordConfirm"/>
							</td>
						</tr>
					</tbody>
				</table>
			</div>
		</div>
		<div class="app-row">
			<div class="app-col right">
				<button class="button" onclick="confirmChangePassword();">
					<img th:src="@{/static/image/icon_confirm.png}" class="icon small"/>
					<span data-th-text="#{application.global.confirm}"></span>
				</button>
			</div>
		</div>
	</dialog>
	<script>
	var changePasswordDialog = new duice.Dialog($('#changePasswordDialog')[0]);

	/**
	 * Changes password
	 */
	function openChangePassword() {
		changePassword.fromJson({
			id: user.get('id'),
			password: null,
			passwordConfirm: null
		});
		changePasswordDialog.open();
	}
	
	/**
	 * Confirms change password
	 */
	function confirmChangePassword() {
		// checks password and password confirm, in case of new
		if(duice.isEmpty(changePassword.get('password'))){
			changePassword.setFocus('password', '[[#{application.global.enterItem(#{application.user.password})}]]');
			return false;
		}
		if(!duice.isPasswordFormat(changePassword.get('password'))){
			changePassword.setFocus('password', '[[#{application.global.notValidPassowrdFormat}]]');
			return false;
		}
		if(duice.isEmpty(changePassword.get('passwordConfirm'))){
			changePassword.setFocus('passwordConfirm', '[[#{application.global.enterItem(#{application.user.passwordConfirm})}]]');
			return false;
		}
		if(changePassword.get('passwordConfirm') !== changePassword.get('password')){
			changePassword.setFocus('passwordConfirm', '[[#{application.global.itemNotMatch(#{application.user.passwordConfirm})}]]');
			return false;
		}
		
		new duice.Confirm("[[#{application.global.saveConfirm(#{application.user.password})}]]")
		.onAfterConfirm(function(){
			var data = user.toJson();
			data.groups = userGroups.toJson();
			data.roles = userRoles.toJson();
			data.authorities = userAuthorities.toJson();
			$.ajax({
				 url: 'user/changePassword'
				,type: 'POST'
				,data: JSON.stringify(changePassword.toJson())
				,contentType: 'application/json;charset=UTF-8'
				,success: function(data, textStatus, jqXHR) {
					new duice.Alert('[[#{application.global.saveComplete(#{application.user.password})}]]')
					.onAfterClose(function(){
						changePasswordDialog.close();
					}).open();
		   	 	}
			});	
		}).open();
	}
	</script>
	<!-- ====================================================== -->
	<!-- END: changePasswordDialog								-->
	<!-- ====================================================== -->
</div>












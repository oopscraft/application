<!DOCTYPE html>
<html layout:decorate="~{admin/admin.html}">
<div layout:fragment="content">
	<script>
	// defines variables
	var search = new duice.Map({
		key: null,
		value: null,
		status: null,
		page: 1,
		rows: 20,
		totalCount: -1
	});
	const tabFolder = new duice.TabFolder();
	const messages = new duice.List();
	messages.setReadonly('language',true);
	const message = new duice.Map();
	const messageLanguages = new duice.List();
	var isNew = false;
	
	// document ready
	$(document).ready(function() {
		
		// checks authorization
		if([[${#authorization.expression('hasAuthority("ADMN_MESG_EDIT")')}]] === false){
			lockDetails();
		}

		// creates tab
		tabFolder.addTab(new duice.Tab(document.getElementById('tabButton1'), document.getElementById('tabContent1')));
		tabFolder.selectTab(0);
		
		// gets messages
		getMessages();
	    disableDetail(true);
	});
	
	// handle when search option is changed.
	search.onAfterChange(function(name, value){
		// if select all option, reset value. 
		if(name === 'key' && !value){
			search.set('value',null);				
		}
	});
	
	// checks when select row is changed.
	messages.onBeforeSelectRow(async function(selectedRow){
		if(isDetailChanged()){
			if(await duice.confirm("[[#{application.global.changeFound}+'\n'+#{application.global.ignoreChange}]]")){
				resetDetail();
				return true;
			}else{
				return false;
			}
		}
	});
	
	// event listener for select row
	messages.onAfterSelectRow(function(selectedRow){
		getMessage(selectedRow.get('id'), selectedRow.get('language'));
	});
	
	// checks messages change
	message.onBeforeChange(async function(name,value){
		if(name === 'id'){
			if(isDuplicateMessage(value)){
				await duice.alert('[[#{application.global.alreadyRegisteredItem(#{application.message.id})}]]');
				return false;
			}
		}
	});
	
	/**
	 * Disables detail
	 */
	function disableDetail(disable){
		message.setDisableAll(disable);
		$('#detailDiv').find('button').each(function(index, element){
			$(element).prop('disabled', disable);
		});
	}
	
	/**
	 * Returns detail changed.
	 */
	function isDetailChanged() {
		if(message.isDirty() 
		|| messageLanguages.isDirty()){
			return true;
		}else{
			return false;
		}
	}

	/**
	 * Initializes detail
	 */
	function initializeDetail() {
		message.fromJson({});
		messageLanguages.fromJson([]);
	}
	
	/**
	 * Resets detail
	 */ 
	function resetDetail() {
		message.reset();
		messageLanguages.reset();
	}
	
	/**
	 * Lock details
	 */
	function lockDetails(){
		message.setReadonlyAll(true);
		messageLanguages.setReadonlyAll(true);
	}
	
	/**
	 * Gets messages
	 */
	function getMessages(page) {
		return new Promise(function(resolve,reject){
			if(page){
				search.set('page',page);
			}
			var data = {};
			if(search.get('key')){
				data[search.get('key')] = search.get('value');
			}
			if(search.get('status')){
				data.status = search.get('status');
			}
			data.page = search.get('page');
			data.rows = search.get('rows');
			$.ajax({
				 url: 'message/getMessages'
				,type: 'GET'
				,data: data
			})
			.done(function(data, textStatus, jqXHR) {
				messages.fromJson(data);
				search.set('totalCount', __parseTotalCount(jqXHR));
				resolve(true);
		   	});
		});
	}
	
	/**
	 * Gets specified message
	 */
	function getMessage(id, language){
		$.ajax({
			 url: 'message/getMessage'
			,type: 'GET'
			,data: { id:id, language:language }
		})
		.done(function(data, textStatus, jqXHR) {
			message.fromJson(data);
			messageLanguages.fromJson(data.languages);
			disableDetail(false);
			message.setReadonly('id', true);
			message.setReadonly('language', true);
			isNew = false;
		});
	}
	
	/**
	 * Adds message
	 */
	function addMessage() {
		initializeDetail();
		disableDetail(false);
		message.setReadonly('id',false);
		message.setReadonly('language',false);
		isNew = true;
		message.setFocus('id');
	}
	
	/**
	 * Returns duplicate message
	 */
	function isDuplicateMessage(id){
		var duplicateMessage = false;
		$.ajax({
			 url: 'message/getMessage'
			,type: 'GET'
			,data: { id:id }
			,async: false
		})
		.done(function(data, textStatus, jqXHR) {
			if(data && (data.id === id && data.language === language)){
				duplicateMessage = true;
			}
		});
		return duplicateMessage;
	}
	
	/**
	 * Saves message
	 */
	async function saveMessage(){
		
		// checks changes
		if(isNew === false && isDetailChanged() === false) {
			await duice.alert("[[#{application.global.changeNotFound}]]");
			return false;
		}
		
		// checks id
		if(!message.has('id')){
			message.setFocus('id', '[[#{application.global.enterItem(#{application.message.id})}]]');
			return false;
		}
		if(!duice.isIdFormat(message.get('id'))){
			user.setFocus('id', '[[#{application.global.notValidIdFormat}]]');
			return false;
		}
		
		// checks new message is existed
		if(isNew){
			if(isDuplicateMessage(message.get('id'))){
				message.setFocus('id', '[[#{application.global.alreadyRegisteredItem(#{application.message.id})}]]');
				return false;
			}
		}

		// enters save process
		if(await duice.confirm("[[#{application.global.saveConfirm(#{application.message})}]]")){
			var data = message.toJson();
			data.languages = messageLanguages.toJson();
			$.ajax({
				 url: 'message/saveMessage'
				,type: 'POST'
				,data: JSON.stringify(data)
				,contentType: 'application/json;charset=UTF-8'
			})
			.done(function(data, textStatus, jqXHR) {
				new duice.Alert('[[#{application.global.saveComplete(#{application.message})}]]')
				.onAfterClose(async function(){
					await getMessages();
					
					// refresh list and details
					var index = messages.indexOf(function(row){
						if(row.get('id') === message.get('id')){
							return true;
						}
					});
					if(index > -1){
						initializeDetail();
						messages.selectRow(index);
					}else{
						getMessage(message.get('id'));
					}
				})
				.open();
			});
		}
	}

	/**
	 * Deletes message
	 */
	function deleteMessage(){
		new duice.Confirm("[[#{application.global.deleteConfirm(#{application.message})}]]")
		.onAfterConfirm(function(){
			$.ajax({
				 url: 'message/deleteMessage'
				,type: 'DELETE'
				,data: JSON.stringify(message.toJson())
				,contentType: 'application/json;charset=UTF-8'
			})
			.done(function(data, textStatus, jqXHR) {
					new duice.Alert("[[#{application.global.deleteComplete(#{application.message})}]]")
					.onAfterClose(async function(){
						await getMessages();
						initializeDetail();
						disableDetail(true);
					}).open();
			});
		}).open();
	}
	
	/**
	 * Adds message language
	 */
	function addMessageLanguage() {
		var messageLanguage = new duice.Map({
			messageId: message.get('id')
		});
		messageLanguages.addRow(messageLanguage);
	}
	
	/**
	 * Removes message language
	 */
	function removeMessageLanguage(index) {
		messageLanguages.removeRow(index);
	}
	</script>
	<div class="app-row">
		<div class="app-col" style="width:50%;">
			<!-- ====================================================== -->
			<!-- START:List												-->
			<!-- ====================================================== -->
			<div id="listDiv" class="app-row">
				<div class="app-col">
					<div class="app-row title">
						<div class="app-col bottom">
							<h1>
								<img class="icon large" th:src="@{/static/image/icon_message.png}"/>
								<span data-th-text="#{application.message} + ' ' + #{application.global.management}"></span>
							</h1>
						</div>
					</div>
					<div class="app-row search">
						<div class="app-col">
							<img class="icon" th:src="@{/static/image/icon_search.png}"/>
							<select is="duice-select" data-duice-bind="search,key" style="width:125px;">
								<option value data-th-text="'- '+#{application.global.all}+' -'"></option>
								<option value="id" data-th-text="#{application.message.id}"></option>
								<option value="name" data-th-text="#{application.message.name}"></option>
							</select>
							<input is="duice-input" type="text" data-duice-bind="search,value" style="width:250px;"/>
						</div>
						<div class="app-col right">
							<button class="button" onclick="getMessages(1);">
								<img th:src="@{/static/image/icon_search.png}" class="icon"/>
								<span data-th-text="#{application.global.search}"></span>
							</button>
						</div>
					</div>
					<div class="app-row">
						<div class="app-col">
							<table is="duice-table" 
								data-duice-bind="messages,message" 
								data-duice-selectable="true"
								style="width:100%;">
								<col style="width:10%;"/>					
								<col/>
								<col/>
								<col style="width:10%;"/>
								<thead>
									<tr>
										<th data-th-text="#{application.global.no}" class="text-center"></th>
										<th data-th-text="#{application.message.id}"></th>
										<th data-th-text="#{application.message.name}"></th>
										<th data-th-text="#{application.message.languages}" class="text-center"></th>
									</tr>
								</thead>
								<tbody>
									<tr>
										<td class="text-center">
											<small is="duice-scriptlet" data-duice-bind="search" data-duice-value="
												return (search.get('rows')*(search.get('page')-1)) + $context.index+1;
											">
											</small>
										</td>
										<td><span is="duice-span" data-duice-bind="message,id" class="id [@duice[$context.message.get('systemEmbedded') === true ? 'embd' : '']]"></span></td>
										<td><span is="duice-span" data-duice-bind="message,name"></span></td>
										<td class="text-center">
											<small is="duice-scriptlet" data-duice-bind="message" data-duice-value="
												return $context.message.get('languages').length;
											">
											</small>
										</td>

									</tr>
								</tbody>
							</table>						
						</div>
					</div>
					<div class="app-row">
						<div class="app-col">
							<small>
								Total
								<span is="duice-span" data-duice-bind="search,totalCount"></span>
								Rows
							</small>
						</div>
						<div class="app-col center">
							<ul is="duice-pagination" data-duice-bind="search,page,rows,totalCount" data-duice-size="5">
								<li data-page="[@duice[$context.page]]" onclick="getMessages(this.dataset.page);"></li>
							</ul>
						</div>
						<div class="app-col right">
							<button class="button" onclick="addMessage();" th:classappend="!${#authorization.expression('hasAuthority(''ADMN_MESG_EDIT'')')}?'lock'">
								<img th:src="@{/static/image/icon_add.png}" class="icon"/>
								<span data-th-text="#{application.global.add}"></span>
							</button>
						</div>
					</div>
				</div>
			</div>	
			<!-- ====================================================== -->
			<!-- END:List												-->
			<!-- ====================================================== -->
		</div>
		<div class="app-col" style="width:50%;">
			<!-- ====================================================== -->
			<!-- START:Start Detail										-->
			<!-- ====================================================== -->
			<div id="detailDiv" class="app-row">
				<div class="app-col">	
					<div class="app-row title">
						<div class="app-col bottom">
							<span id="tabButton1" class="tab">
								<img class="icon small" th:src="@{/static/image/icon_message.png}"/>
								<span data-th-text="#{application.message} + ' ' + #{application.global.details}"></span>
							</span>
						</div>
					</div>
					<!-- ====================================================== -->
					<!-- START:Start tabContent1								-->
					<!-- ====================================================== -->
					<div id="tabContent1" class="app-row">
						<div class="app-col">
							<table class="table" style="width:100%;">
								<col style="width:25%;"/>
								<col/>
								<tbody>
									<tr>
										<th><span data-th-text="#{application.message.id}" class="mand">ID</span></th>
										<td><input is="duice-input" type="text" data-duice-bind="message,id" autocomplete="nope" class="id"/></td>
									</tr>
									<tr>
										<th data-th-text="#{application.message.name}">Name</th>
										<td><input is="duice-input" type="text" data-duice-bind="message,name"/></td>
									</tr>
									<tr>
										<th data-th-text="#{application.message.description}">Description</th>
										<td><textarea is="duice-textarea" data-duice-bind="message,description" style="height:100px;"></textarea></td>
									</tr>
									<tr>
										<th>
											<img class="icon" th:src="@{/static/image/icon_language.png}"/>
											<br/>
											<span data-th-text="#{application.message.languages}"></span>
										</th>
										<td>
											<div style="width:100%; max-height:1024px; overflow-y:scroll;">
												<table is="duice-table" 
												data-duice-bind="messageLanguages,language" 
												style="width:100%;">
													<col style="width:15%;"/>
													<col/>
													<col style="width:5%;"/>
													<thead>
														<tr>
															<th data-th-text="#{application.message.language.id}" class="text-center">ID</th>
															<th data-th-text="#{application.message.language.value}">Value</th>
															<th class="text-center">
																<img th:src="@{/static/image/icon_add.png}" class="icon small button" onclick="addMessageLanguage();" th:classappend="!${#authorization.expression('hasAuthority(''ADMN_MESG_EDIT'')')}?'lock'">
															</th>
														</tr>
													</thead>
													<tbody>
														<tr>
															<td>
																<select is="duice-select" data-duice-bind="language,id" style="height:50px;">
																	<option value data-th-text="'- '+#{application.global.select}+' -'"></option>
																	<option th:each="language:${__languages}" th:value="${language.language}" th:text="${language.displayLanguage}"></option>
																</select>
															</td>
															<td>
																<textarea is="duice-textarea" data-duice-bind="language,value" style="height:50px;"></textarea>
															</td>
															<td class="text-center">
																<img th:src="@{/static/image/icon_remove.png}" class="icon small button" data-index="[@duice[$context.index]]" onclick="removeMessageLanguage(this.dataset.index);" th:classappend="!${#authorization.expression('hasAuthority(''ADMN_MESG_EDIT'')')}?'lock'">
															</td>
														</tr>
													</tbody>
												</table>
											</div>
										</td>
									</tr>
								</tbody>
							</table>
							<div class="app-row action">
								<div class="app-col right">
									<button class="button large" onclick="deleteMessage();" th:classappend="!${#authorization.expression('hasAuthority(''ADMN_MESG_EDIT'')')}?'lock'">
										<img th:src="@{/static/image/icon_delete.png}" class="icon"/>
										<span data-th-text="#{application.global.delete}"></span>
									</button>
									<button class="button large" onclick="saveMessage();" th:classappend="!${#authorization.expression('hasAuthority(''ADMN_MESG_EDIT'')')}?'lock'">
										<img th:src="@{/static/image/icon_save.png}" class="icon"/>
										<span data-th-text="#{application.global.save}"></span>
									</button>
								</div>
							</div>
						</div>
					</div>
					<!-- ====================================================== -->
					<!-- END: End tabContent1									-->
					<!-- ====================================================== -->
				</div>
			</div>
			<!-- ====================================================== -->
			<!-- END:Start Detail										-->
			<!-- ====================================================== -->
		</div>
	</div>
</div>

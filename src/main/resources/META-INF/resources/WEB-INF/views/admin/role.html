<!DOCTYPE html>
<html layout:decorate="~{admin/admin.html}">
<div layout:fragment="content">
	<script>
		// document ready
		$(document).ready(function() {
			getRoles();
		    disableDetail(true);
		});
		
		// defines roles and role data 
		const search = new duice.Map({
			key: null,
			value: null,
			status: null,
			page: 1,
			rows: 20,
			totalCount: -1
		});
		const roles = new duice.List();
		const role = new duice.Map();
		const roleAuthorities = new duice.List();
		var isNew = false;
		
		// handle when search option is changed.
		search.onAfterChange(function(name, value){
			// if select all option, reset value. 
			if(name === 'key' && !value){
				search.set('value',null);				
			}
		});

		// checks when select row is changed.
		roles.onBeforeSelectRow(async function(selectedRow){
			if(isDetailChanged()){
				return await new duice.Confirm("[[#{application.global.changeFound}+'\n'+#{application.global.ignoreChange}]]")
				.onAfterConfirm(function(){
					resetDetail();
				})
				.open();
			}
		});
		
		// event listener for select row
		roles.onAfterSelectRow(function(selectedRow){
			getRole(selectedRow.get('id'));
		});
		
		/**
		 * Disables detail
		 */
		function disableDetail(disable){
			role.setDisable(disable);
			$('#detailDiv').find('button').each(function(index, element){
				$(element).prop('disabled', disable);
			});
		}
		
		/**
		 * Returns detail changed.
		 */
		function isDetailChanged() {
			if(role.isDirty()
			|| roleAuthorities.isDirty()
			){
				return true;
			}else{
				return false;
			}
		}
		
		/**
		 * Initializes detail
		 */
		function initializeDetail() {
			role.fromJson({});
			roleAuthorities.fromJson([]);
		}
		
		/**
		 * Resets detail
		 */ 
		function resetDetail() {
			role.reset();
			roleAuthorities.reset();
		}
		
		/**
		 * Gets roles
		 */
		function getRoles(page) {
			return new Promise(function(resolve,reject){
				if(page){
					search.set('page',page);
				}
				var data = {};
				if(search.get('key')){
					data[search.get('key')] = search.get('value');
				}
				data.page = search.get('page');
				data.rows = search.get('rows');
				$.ajax({
					 url: 'role/getRoles'
					,type: 'GET'
					,data: data
					,success: function(data, textStatus, jqXHR) {
						roles.fromJson(data);
						search.set('totalCount', __parseTotalCount(jqXHR));
						resolve(true);
			   	 	}
				});
			});
		}
		
		/**
		 * Gets specified role
		 */
		function getRole(id){
			$.ajax({
				 url: 'role/getRole'
				,type: 'GET'
				,data: {id:id}
				,success: function(data, textStatus, jqXHR) {
					role.fromJson(data);
					roleAuthorities.fromJson(data.authorities);
					disableDetail(false);
					role.setReadonly('id', true);
					isNew = false;
		   	 	}
			});	
		}
		
		/**
		 * Adds role
		 */
		function addRole() {
			initializeDetail();
			disableDetail(false);
			role.setReadonly('id',false);
			isNew = true;
		}
		
		/**
		 * Saves role
		 */
		function saveRole(){
			
			// checks changes
			if(isNew === false && isDetailChanged() === false) {
				new duice.Alert("[[#{application.global.changeNotFound}]]").open();
				return;
			}
			
			// checks id
			if(duice.isEmpty(role.get('id'))){
				user.setFocus('id', '[[#{application.global.enterItem(#{application.role.id})}]]');
				return false;
			}
			if(!duice.isIdFormat(role.get('id'))){
				user.setFocus('id', '[[#{application.global.notValidIdFormat}]]');
				return false;
			}
			
			// checks user name
			if(duice.isEmpty(role.get('name'))){
				user.setFocus('name', '[[#{application.global.enterItem(#{application.role.name})}]]');
				return false;
			}
			
			// enters save process
			new duice.Confirm("[[#{application.global.saveConfirm(#{application.role})}]]")
			.onAfterConfirm(function(){
				var data = role.toJson();
				data.authorities = roleAuthorities.toJson();
				$.ajax({
					 url: 'role/saveRole'
					,type: 'POST'
					,data: JSON.stringify(data)
					,contentType: 'application/json;charset=UTF-8'
					,success: function(data, textStatus, jqXHR) {
						new duice.Alert('[[#{application.global.saveComplete(#{application.role})}]]')
						.onAfterClose(async function(){
							await getRoles();
							
							// refresh list and details
							var index = roles.indexOf(function(row){
								if(row.get('id') === role.get('id')){
									return true;
								}
							});
							if(index > -1){
								initializeDetail();
								roles.selectRow(index);
							}else{
								getRole(role.get('id'));
							}
						}).open();
			   	 	}
				});	
			}).open();
		}
		
		/**
		 * Deletes role
		 */
		function deleteRole(){
			new duice.Confirm("[[#{application.global.deleteConfirm(#{application.role})}]]")
			.onAfterConfirm(function(){
				$.ajax({
					 url: 'role/deleteRole'
					,type: 'DELETE'
					,data: JSON.stringify(role.toJson())
					,contentType: 'application/json;charset=UTF-8'
					,success: function(data, textStatus, jqXHR) {
						new duice.Alert("[[#{application.global.deleteComplete(#{application.role})}]]")
						.onAfterClose(async function(){
							await getRoles();
							initializeDetail();
							disableDetail(true);
						}).open();
			   	 	}
				});
			}).open();
		
		}
		
		/**
		 * Adds role authority
		 */
		function addRoleAuthority() {
			__authorityDialog.open({
				disabledAuthorities: roleAuthorities.toJson(),
				onAfterConfirm: function(selectedAuthorities){
					selectedAuthorities.forEach(function(item){
						roleAuthorities.addRow(new duice.Map(item));
					});
				}
			});
		}
		
		/**
		 * Removes role authority
		 */
		function removeRoleAuthority(index) {
			roleAuthorities.removeRow(index);
		}
	</script>
	<div class="app-row">
		<div class="app-col">
			<h1>
				<img class="icon large" th:src="@{/static/image/icon_role.png}"/>
				<span data-th-text="#{application.role}+' '+#{application.global.management}"></span>
			</h1>
		</div>
	</div>
	<hr class="hr"/>
	<div class="app-row">
		<!-- ====================================================== -->
		<!-- List													-->
		<!-- ====================================================== -->
		<div id="listDiv" class="app-col" style="width:50%;">
			<div class="app-row">
				<div class="app-col" style="width:50%;">
					<select is="duice-ui-select" data-duice-bind="search,key" style="width:125px;">
						<option value data-th-text="'- '+#{application.global.all}+' -'"></option>
						<option value="id" data-th-text="#{application.role.id}">Role ID</option>
						<option value="name" data-th-text="#{application.role.name}">Role Name</option>
					</select>
					<input is="duice-ui-input" type="text" data-duice-bind="search,value" style="width:250px;"/>
				</div>
				<div class="app-col right">
					<button class="button" onclick="getRoles(1);">
						<img th:src="@{/static/image/icon_search.png}" class="icon"/>
						<span data-th-text="#{application.global.search}"></span>
					</button>
				</div>
			</div>
			<div class="app-row">
				<div class="app-col">
					<table is="duice-ui-table" 
						data-duice-bind="roles,role" 
						data-duice-selectable="true"
						style="width:100%;">
						<col style="width:70px;"/>					
						<col/>
						<col/>
						<thead>
							<tr>
								<th data-th-text="#{application.global.no}">No</th>
								<th data-th-text="#{application.role.id}">Role ID</th>
								<th data-th-text="#{application.role.name}">Role Name</th>
							</tr>
						</thead>
						<tbody>
							<tr>
								<td class="text-center">
									<span is="duice-ui-scriptlet" data-duice-bind="search">
										return (search.get('rows')*(search.get('page')-1)) + $context.index+1;
									</span>
								</td>
								<td>
									<img is="duice-ui-img" data-duice-bind="role,icon" th:src="@{/static/image/icon_role.png}" class="icon small"/>
									<span is="duice-ui-span" data-duice-bind="role,id"></span>
								</td>
								<td><span is="duice-ui-span" data-duice-bind="role,name"></span></td>
							</tr>
						</tbody>
						<tfoot>
							<tr>
								<td colspan="7">
									<ul is="duice-ui-pagination" data-duice-bind="search,page,rows,totalCount" data-duice-size="5">
										<li onclick="getRoles();"></li>
									</ul>
								</td>
							</tr>
						</tfoot>
					</table>
				</div>
			</div>		
		</div>
		<!-- ====================================================== -->
		<!-- Start Detail											-->
		<!-- ====================================================== -->
		<div id="detailDiv" class="app-col" style="width:50%;">
			<div class="app-row">
				<div class="app-col">
					<img class="icon" th:src="@{/static/image/icon_role.png}"/>
					<span data-th-text="#{application.role} + ' ' + #{application.global.details}" class="font-bold"></span>
				</div>
				<div class="app-col right">
					<button id="addRoleButton" class="button" onclick="addRole();">
						<img th:src="@{/static/image/icon_create.png}" class="icon"/>
						<span data-th-text="#{application.global.new}"></span>
					</button>
					<button id="deleteRoleButton" class="button" onclick="deleteRole();">
						<img th:src="@{/static/image/icon_delete.png}" class="icon"/>
						<span data-th-text="#{application.global.delete}"></span>
					</button>
					<button id="saveRoleButton" class="button" onclick="saveRole();">
						<img th:src="@{/static/image/icon_save.png}" class="icon"/>
						<span data-th-text="#{application.global.save}"></span>
					</button>
				</div>
			</div>
			<div class="app-row">
				<div class="app-col">
					<table class="table" style="width:100%;">
						<col style="width:25%;"/>
						<col/>
						<tbody>
							<tr>
								<th><span data-th-text="#{application.role.id}" class="mand">Role ID</span></th>
								<td><input is="duice-ui-input" type="text" data-duice-bind="role,id" autocomplete="nope"/></td>
							</tr>
							<tr>
								<th data-th-text="#{application.role.icon}">Role Icon</th>
								<td>
									<img is="duice-ui-img" data-duice-bind="role,icon" th:src="@{/static/image/icon_role.png}"/>
								</td>
							</tr>
							<tr>
								<th data-th-text="#{application.role.name}">Role Name</th>
								<td><input is="duice-ui-input" type="text" data-duice-bind="role,name"/></td>
							</tr>
							<tr>
								<th data-th-text="#{application.role.description}">Role Description</th>
								<td><textarea is="duice-ui-textarea" data-duice-bind="role,description"></textarea></td>
							</tr>
							<tr>
								<th>
									<img class="icon" th:src="@{/static/image/icon_authority.png}"/>
									<br/>
									<span data-th-text="#{application.authority}"></span>
								</th>
								<td>
									<table is="duice-ui-table" 
										data-duice-bind="roleAuthorities,authority" 
										style="width:100%;">
										<col style="width:50px;"/>
										<col style="width:35%;"/>
										<col/>
										<col style="width:5%;"/>
										<thead>
											<tr>
												<th data-th-text="#{application.global.no}">No</th>
												<th data-th-text="#{application.role.id}">Authority ID</th>
												<th data-th-text="#{application.role.name}">Authority Name</th>
												<th class="text-center">
													<button class="button small" onclick="addRoleAuthority();">
														+
													</button>
												</th>
											</tr>
										</thead>
										<tbody>
											<tr>
												<td class="text-center">
													<span is="duice-ui-scriptlet" data-duice-bind="authority">return $context.index+1;</span>
												</td>
												<td>
													<img is="duice-ui-img" data-duice-bind="authority,icon" th:src="@{/static/image/icon_authority.png}" class="icon small"/>
													<span is="duice-ui-span" data-duice-bind="authority,id"></span>
												</td>
												<td><span is="duice-ui-span" data-duice-bind="authority,name"></span></td>
												<td class="text-center">
													<button class="button small" data-index="[@duice[$context.index]]" onclick="removeRoleAuthority(this.dataset.index);">
														-
													</button>
												</td>
											</tr>
										</tbody>
									</table>
								</td>
							</tr>
						</tbody>
					</table>
				</div>
			</div>
		</div>
	</div>
</div>

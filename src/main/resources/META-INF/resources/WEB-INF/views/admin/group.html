<!DOCTYPE html>
<html layout:decorate="~{admin/admin.html}">
<div layout:fragment="content">
	<script>
	// defines variables 
	const search = new duice.Map({
		page: 1,
		rows: 1000,
		totalCount: -1
	});
	const tabFolder = new duice.TabFolder();
	const groups = new duice.List();
	const group = new duice.Map();
	const groupRoles = new duice.List();
	const groupAuthorities = new duice.List();
	const groupAvailableAuthorities = new duice.List();
	var isNew = false;
	
	// document ready
	$(document).ready(function() {
		
		// creates tab
		tabFolder.addTab(new duice.Tab(document.getElementById('tabButton1'), document.getElementById('tabContent1')));
		tabFolder.addTab(new duice.Tab(document.getElementById('tabButton2'), document.getElementById('tabContent2')));
		tabFolder.onAfterSelectTab(function(selectedTab){
			if(group.get('id')){
				// tabButton2
				if(selectedTab.getButton() === document.getElementById('tabButton2')){
					getGroupAvailableAuthorities(group.get('id'));
				}
			}
		});
		tabFolder.selectTab(0);
		
		// gets groups
	    getGroups();
	    disableDetail(true);
	});


	// adds index changed event listener
	groups.onBeforeSelectRow(async function(index){
		if(isDetailChanged()){
			return await new duice.Confirm("[[#{application.global.changeFound}+'\n'+#{application.global.ignoreChange}]]")
			.onAfterConfirm(function(){
				resetDetail();
			})
			.open();
		}
	});
	
	// event listener for select row
	groups.onAfterSelectRow(function(selectedRow){
		getGroup(selectedRow.get('id'));	
	});
	
	// event listner for before move row
	groups.onBeforeMoveRow(async function(sourceRow,targetRow){
		console.log('groups.onBeforeMoveRow', sourceRow.toJson(), targetRow && targetRow.toJson());
		return await new duice.Confirm("[[#{application.global.changePositionConfirm(#{application.group})}]]")
		.open();
	});
	
	// event listner for after move row
	groups.onAfterMoveRow(async function(sourceRow,targetRow){
		console.log('groups.onAfterMoveRow', sourceRow.toJson(), targetRow && targetRow.toJson());
		var group = sourceRow;
		var id = group.get('id');
		$.ajax({
			 url: 'group/changeUpperId'
			,type: 'POST'
			,data: JSON.stringify(group.toJson())
			,contentType: 'application/json;charset=UTF-8'
			,success: function(data, textStatus, jqXHR) {
				new duice.Alert('[[#{application.global.changePositionComplete(#{application.group})}]]')
				.onAfterClose(async function(){
					await getGroups();
					groups.forEach(function(row,index){
						if(row.get('id') === id){
							clearDetail();
							groups.selectRow(index);
							return true;
						}
					});
				}).open();
	   	 	}
		});	
	});
	
	/**
	 * Disables detail
	 */
	function disableDetail(disable){
		group.setDisable(disable);
		$('#detailDiv').find('button').each(function(index, element){
			$(element).prop('disabled', disable);
		});
	}
	
	/**
	 * Returns detail changed.
	 */
	function isDetailChanged() {
		if(group.isDirty()
		|| groupRoles.isDirty()
		|| groupAuthorities.isDirty()
		){
			return true;
		}else{
			return false;
		}
	}
	
	/**
	 * Clears detail
	 */
	function clearDetail() {
		group.fromJson({});
		groupRoles.fromJson([]);
		groupAuthorities.fromJson([]);
		groupAvailableAuthorities.fromJson([]);
	}
	
	/**
	 * Resets detail
	 */
	function resetDetail(){
		group.reset();
		groupRoles.reset();
		groupAuthorities.reset();
	}

	/**
	 * Gets groups
	 * Retrieves list of group from serer API.
	 */
	function getGroups() {
		return new Promise(function(resolve,reject){
			var data = {};
			data.page = search.get('page');
			data.rows = search.get('rows');
			$.ajax({
				 url: 'group/getGroups'
				,type: 'GET'
				,data: data
				,success: function(data, textStatus, jqXHR) {
					groups.fromJson(data);
					search.set('totalCount', __parseTotalCount(jqXHR));
					resolve(true);
		   	 	}
			});	
		});
	}
	
	/**
	 * Gets specified group
	 */
	function getGroup(id){
		$.ajax({
			 url: 'group/getGroup'
			,type: 'GET'
			,data: {id:id}
		})
		.done(function(data, textStatus, jqXHR) {
			group.fromJson(data);
			groupRoles.fromJson(data.roles);
			groupAuthorities.fromJson(data.authorities);
			disableDetail(false);
			group.setReadonly('id', true);
			isNew = false;
			tabFolder.selectTab(0);
		});	
	}

	/**
	 * Gets group available authorities
	 */
	function getGroupAvailableAuthorities(id){
		$.ajax({
			 url: 'group/getAvailableAuthorities'
			,type: 'GET'
			,data: {id:id}
		})
		.done(function(data, textStatus, jqXHR) {
			groupAvailableAuthorities.fromJson(data);
		});
	}
	
	/**
	 * Adds group
	 */
	function addGroup() {
		clearDetail();
		disableDetail(false);
		group.setReadonly('id',false);
		isNew = true;
	}
	
	/**
	 * Change upper id
	 */
	function changeUpperId(){
		
		// creates disabled list(self and child nodes)
		var disabledGroups = new duice.List();

		// finds child group recursively.
		var childGroups = new duice.List();
		function getChildGroup(group){
			groups.forEach(function(row){
				if(row.get('upperId') === group.get('id')){
					childGroups.addRow(row);
					getChildGroup(row);
				}
			});
		}
		getChildGroup(group);
		
		// sets disabled groups (self and child nodes)
		disabledGroups.addRow(group);
		childGroups.forEach(function(row){
			disabledGroups.addRow(row);
		});
		
		// opens global group select select dialog
		__groupDialog.open({
			singleSelect:true,
			checkedGroups: [{id:group.get('upperId')}],
			disabledGroups: disabledGroups.toJson(),
			onAfterConfirm: function(returnGroups){
				var upperGroup = returnGroups[0];
				var upperId = null;
				if(upperGroup){
					upperId = upperGroup.id;
				}
				
				// updates upperId
				group.set('upperId', upperId);
			}
		});
	}
	
	/**
	 * Saves group
	 */
	function saveGroup(){
		
		// checks changes
		if(isNew === false && isDetailChanged() === false) {
			new duice.Alert("[[#{application.global.changeNotFound}]]").open();
			return;
		}
		
		// check group id
		if(duice.isEmpty(group.get('id'))){
			group.setFocus('id', '[[#{application.global.enterItem(#{application.group.id})}]]');
			return false;
		}
		if(!duice.isIdFormat(group.get('id'))){
			group.setFocus('id', '[[#{application.global.notValidIdFormat}]]');
			return false;
		}
		// checks group name
		if(duice.isEmpty(group.get('name'))){
			group.setFocus('name', '[[#{application.global.enterItem(#{application.group.name})}]]');
			return false;
		}
					
		// fires confirm message
		new duice.Confirm("[[#{application.global.saveConfirm(#{application.group})}]]")
		.onAfterConfirm(function(){
			var data = group.toJson();
			data.roles = groupRoles.toJson();
			data.authorities = groupAuthorities.toJson();
			$.ajax({
				 url: 'group/saveGroup'
				,type: 'POST'
				,data: JSON.stringify(data)
				,contentType: 'application/json;charset=UTF-8'
				,success: function(data, textStatus, jqXHR) {
					new duice.Alert('[[#{application.global.saveComplete(#{application.group})}]]')
					.onAfterClose(async function(){
						await getGroups();
						
						// refresh list and details
						var index = groups.indexOf(function(row){
							if(row.get('id') === group.get('id')){
								return true;
							}
						});
						if(index > -1){
							clearDetail();
							groups.selectRow(index);
						}else{
							getGroup(group.get('id'));
						}
					}).open();
		   	 	}
			});	
		}).open();
	}
	
	/**
	 * Deletes group
	 */
	function deleteGroup(){
		new duice.Confirm("[[#{application.global.deleteConfirm(#{application.group})}]]")
		.onAfterConfirm(function(){
			$.ajax({
				 url: 'group/deleteGroup'
				,type: 'DELETE'
				,data: JSON.stringify(group.toJson())
				,contentType: 'application/json;charset=UTF-8'
				,success: function(data, textStatus, jqXHR) {
					new duice.Alert("[[#{application.global.deleteComplete(#{application.group})}]]")
					.onAfterClose(async function(){
						await getGroups();
						clearDetail();
						disableDetail(true);
					}).open();
		   	 	}
			});
		}).open();
	}
	
	/**
	 * Adds group role
	 */
	function addGroupRole() {
		__roleDialog.open({
			checkedRoles: groupRoles.toJson(),
			disabledRoles: groupRoles.toJson(),
			onAfterConfirm: function(selectedRoles){
				selectedRoles.forEach(function(item){
					groupRoles.addRow(new duice.Map(item));
				});
			}
		});
	}
	
	/**
	 * Removes group role
	 */
	function removeGroupRole(index) {
		groupRoles.removeRow(index);
	}
	
	/**
	 * Adds group authority
	 */
	function addGroupAuthority() {
		__authorityDialog.open({
			checkedAuthorities: groupAuthorities.toJson(),
			disabledAuthorities: groupAuthorities.toJson(),
			onAfterConfirm: function(selectedAuthorities){
				selectedAuthorities.forEach(function(item){
					groupAuthorities.addRow(new duice.Map(item));
				});
			}
		});
	}
	
	/**
	 * Removes authority
	 */
	function removeGroupAuthority(index) {
		groupAuthorities.removeRow(index);
	}
	</script>
	<div class="app-row">
		<div class="app-col" style="width:50%;">
			<!-- ====================================================== -->
			<!-- START:List												-->
			<!-- ====================================================== -->
			<div id="listDiv" class="app-row">
				<div class="app-col">
					<div class="app-row title">
						<div class="app-col bottom">
							<h1>
								<img class="icon large" th:src="@{/static/image/icon_group.png}"/>
								<span data-th-text="#{application.group} + ' ' + #{application.global.management}"></span>
							</h1>
						</div>
					</div>
					<div class="app-row">
						<div class="app-col">
							<ul is="duice-ul" 
							data-duice-bind="groups,group" 
							data-duice-selectable="true"
							data-duice-hierarchy="id,upperId"
							data-duice-editable="true"
							data-duice-foldable="true">
								<li>
									<div style="border-bottom:dotted 1px #ccc;">
										<img is="duice-img" data-duice-bind="group,icon" th:src="@{/static/image/icon_group.png}" class="icon small"/>
										<span is="duice-span" data-duice-bind="group,name" style="font-weight:bold;" class="[@duice[$context.group.get('systemEmbedded') === true ? 'embd' : '']]"></span>
									</div>
								</li>
							</ul>
						</div>
					</div>
					<div class="app-row">
						<div class="app-col">
							<small>
								Total
								<span is="duice-span" data-duice-bind="search,totalCount"></span>
								Rows
							</small>
						</div>
						<div class="app-col right">
							<button class="button" onclick="addGroup();">
								<img th:src="@{/static/image/icon_add.png}" class="icon"/>
								<span data-th-text="#{application.global.add}"></span>
							</button>
						</div>
					</div>
				</div>
			</div>
			<!-- ====================================================== -->
			<!-- END:List												-->
			<!-- ====================================================== -->
		</div>
		<div class="app-col" style="width:50%;">
			<!-- ====================================================== -->
			<!-- START:Start Detail										-->
			<!-- ====================================================== -->
			<div id="detailDiv" class="app-row">
				<div class="app-col">
					<div class="app-row title">
						<div class="app-col bottom">
							<span id="tabButton1" class="tab">
								<img class="icon small" th:src="@{/static/image/icon_group.png}"/>
								<span data-th-text="#{application.group} + ' ' + #{application.global.details}"></span>
							</span>
							<span id="tabButton2" class="tab">
								<img class="icon small" th:src="@{/static/image/icon_authority.png}"/>
								<span data-th-text="#{application.global.available} + ' ' + #{application.group.authorities}"></span>
							</span>
						</div>
					</div>
					<!-- ====================================================== -->
					<!-- START:Start tabContent1								-->
					<!-- ====================================================== -->
					<div id="tabContent1" class="app-row">
						<div class="app-col">
							<table class="table" style="width:100%;">
								<col style="width:25%;"/>
								<col/>
								<tbody>
									<tr>
										<th><span data-th-text="#{application.group.id}" class="mand">Group ID</span></th>
										<td><input is="duice-input-text" type="text" data-duice-bind="group,id"/></td>
									</tr>
									<tr>
										<th data-th-text="#{application.group.upperId}">Upper Group</th>
										<td>
											<span is="duice-scriptlet" data-duice-bind="group">
												<![CDATA[
												var breadCrumb = new Array();
												var upperId = group.get('upperId');
												var run = true;
												while(run){
													var upperExist = false;
													for(var i = 0, size = groups.getRowCount(); i < size; i ++ ){
														var row = groups.getRow(i);
														if(row.get('id') === upperId){
															breadCrumb.push(row.get('name'));
															upperId = row.get('upperId');
															upperExist = true;
															break;
														}
													}
													run = upperExist;
												}
												breadCrumb.reverse();
												return breadCrumb.join(" / ");
												]]>
											</span>
											<button class="button small" onclick="changeUpperId();" style="padding-right:12px;">
												<img th:src="@{/static/image/icon_change.png}" class="icon small"/>
												<span data-th-text="#{application.global.change}">Change</span>
											</button>
										</td>
									</tr>
									<tr>
										<th data-th-text="#{application.group.icon}">Group Icon</th>
										<td><img is="duice-img" data-duice-bind="group,icon" th:src="@{/static/image/icon_group.png}"/></td>
									</tr>
									<tr>
										<th data-th-text="#{application.group.name}">Group Name</th>
										<td><input is="duice-input-text" type="text" data-duice-bind="group,name"/></td>
									</tr>
									<tr>
										<th data-th-text="#{application.group.description}">Group Description</th>
										<td><textarea is="duice-textarea" data-duice-bind="group,description" style="height:6rem;"></textarea></td>
									</tr>
									<tr>
										<th>
											<img class="icon" th:src="@{/static/image/icon_role.png}"/>
											<br/>
											<span data-th-text="#{application.group.roles}"></span>
										</th>
										<td>
											<table is="duice-table" 
											data-duice-bind="groupRoles,role" 
											style="width:100%;">
												<col style="width:50px;"/>
												<col style="width:35%;"/>
												<col/>
												<col style="width:5%;"/>
												<thead>
													<tr>
														<th data-th-text="#{application.global.no}">No</th>
														<th data-th-text="#{application.role.id}">ID</th>
														<th data-th-text="#{application.role.name}">Name</th>
														<th class="text-center">
															<button class="button small" onclick="addGroupRole();">
																+
															</button>
														</th>
													</tr>
												</thead>
												<tbody>
													<tr>
														<td class="text-center">
															<span is="duice-scriptlet" data-duice-bind="role">return $context.index+1;</span>
														</td>
														<td>
															<img is="duice-img" data-duice-bind="role,icon" th:src="@{/static/image/icon_role.png}" class="icon small"/>
															<span is="duice-span" data-duice-bind="role,id"></span>
														</td>
														<td><span is="duice-span" data-duice-bind="role,name"></span></td>
														<td class="text-center">
															<button class="button small" data-index="[@duice[$context.index]]" onclick="removeGroupRole(this.dataset.index);">
																-
															</button>
														</td>
													</tr>
												</tbody>
											</table>
										</td>
									</tr>
									<tr>
										<th>
											<img class="icon" th:src="@{/static/image/icon_authority.png}"/>
											<br/>
											<span data-th-text="#{application.group.authorities}">Own Authority</span>
										</th>
										<td>
											<table is="duice-table" 
												data-duice-bind="groupAuthorities,authority" 
												style="width:100%;">
												<col style="width:50px;"/>
												<col style="width:35%;"/>
												<col/>
												<col style="width:5%;"/>
												<thead>
													<tr>
														<th data-th-text="#{application.global.no}">No</th>
														<th data-th-text="#{application.authority.id}">Authority ID</th>
														<th data-th-text="#{application.authority.name}">Authority Name</th>
														<th class="text-center">
															<button class="button small" onclick="addGroupAuthority();">
																+
															</button>
														</th>
													</tr>
												</thead>
												<tbody>
													<tr>
														<td class="text-center">
															<span is="duice-scriptlet" data-duice-bind="authority">return $context.index+1;</span>
														</td>
														<td>
															<img is="duice-img" data-duice-bind="authority,icon" th:src="@{/static/image/icon_authority.png}" class="icon small"/>
															<span is="duice-span" data-duice-bind="authority,id"></span>
														</td>
														<td><span is="duice-span" data-duice-bind="authority,name"></span></td>
														<td class="text-center">
															<button class="button small" data-index="[@duice[$context.index]]" onclick="removeGroupAuthority(this.dataset.index);">
																-
															</button>
														</td>
													</tr>
												</tbody>
											</table>
										</td>
									</tr>
								</tbody>
							</table>
							<div class="app-row">
								<div class="app-col right">
									<button id="deleteUserButton" class="button large" onclick="deleteGroup();">
										<img th:src="@{/static/image/icon_delete.png}" class="icon"/>
										<span data-th-text="#{application.global.delete}"></span>
									</button>
									<button id="saveUserButton" class="button large" onclick="saveGroup();">
										<img th:src="@{/static/image/icon_save.png}" class="icon"/>
										<span data-th-text="#{application.global.save}"></span>
									</button>
								</div>
							</div>							
						</div>
					</div>
					<!-- ====================================================== -->
					<!-- END: End tabContent1									-->
					<!-- ====================================================== -->
					<!-- ====================================================== -->
					<!-- START: Start tabContent2								-->
					<!-- ====================================================== -->
					<div id="tabContent2" class="app-row">
						<div class="app-col">
							<table is="duice-table" 
								data-duice-bind="groupAvailableAuthorities,authority" 
								style="width:100%;">
								<col/>
								<col/>
								<col/>
								<col/>
								<thead>
									<tr>
										<th data-th-text="#{application.global.no}">No</th>
										<th data-th-text="#{application.authority.id}">ID</th>
										<th data-th-text="#{application.authority.name}">Name</th>
										<th data-th-text="#{application.authority.holder}">Holder</th>
									</tr>
								</thead>
								<tbody>
									<tr>
										<td>
											<span is="duice-scriptlet" data-duice-bind="authority">return $context.index+1;</span>
										</td>
										<td>
											<img is="duice-img" data-duice-bind="authority,icon" th:src="@{/static/image/icon_authority.png}" class="icon small"/>
											<span is="duice-span" data-duice-bind="authority,id"></span>
										</td>
										<td><span is="duice-span" data-duice-bind="authority,name"></span></td>
										<td>
											<span is="duice-scriptlet" data-duice-bind="authority">
												<![CDATA[
												return JSON.stringify($context.authority.get('holder'));
												]]>
											</span>
										</td>
									</tr>
								</tbody>
							</table>
						</div>
					</div>
					<!-- ====================================================== -->
					<!-- END: End tabContent2									-->
					<!-- ====================================================== -->
				</div>
			</div>
			<!-- ====================================================== -->
			<!-- END:Start Detail										-->
			<!-- ====================================================== -->
		</div>
	</div>
</div>

<!DOCTYPE html>
<html layout:decorate="~{admin/admin.html}">
<div layout:fragment="content">
	<script>
		// document ready
		$(document).ready(function() {
		    getGroups();
		    disableDetail(true);
		});
	
		var search = new duice.Map({
			page: 1,
			rows: 1000,
			totalCount: -1
		});
		var groups = new duice.List();
		var group = new duice.Map();
		var groupRoles = new duice.List();
		var groupAuthorities = new duice.List();
		
		// adds index changed event listener
		groups.onAfterChangeIndex(function(index){
			if(index > -1){
				var id = this.get(index).get('id');
				getGroup(id);	
			}
		});
		
		/**
		 * Disables detail
		 */
		function disableDetail(disable){
			group.setDisable(disable);
			$('#deleteGroupButton').prop('disabled', disable);
			$('#saveGroupButton').prop('disabled', disable);
		}
		
		/**
		 * Clears detail
		 */
		function clearDetail(){
			group.clear();
			groupRoles.clear();
			groupAuthorities.clear();
		}
	
		/**
		 * Gets groups
		 * Retrieves list of group from serer API.
		 */
		function getGroups() {
			var data = {};
			data.page = search.get('page');
			data.rows = search.get('rows');
			$.ajax({
				 url: 'group/getGroups'
				,type: 'GET'
				,data: data
				,success: function(data, textStatus, jqXHR) {
					groups.fromJson(data);
					search.set('totalCount', __parseTotalCount(jqXHR));
					
					// sets current group
					groups.forEach(function(row,index){
						if(row.get('id') === group.get('id')){
							groups.setIndex(index);
							return false;
						}
					});
		   	 	}
			});	
		}
		
		/**
		 * Gets specified group
		 */
		function getGroup(id){
			$.ajax({
				 url: 'group/getGroup'
				,type: 'GET'
				,data: {id:id}
				,success: function(data, textStatus, jqXHR) {
					group.fromJson(data);
					groupRoles.fromJson(data.roles);
					groupAuthorities.fromJson(data.authorities);
					disableDetail(false);
					group.setReadonly('id', true);
		   	 	}
			});	
		}
		
		/**
		 * Adds group
		 */
		function addGroup() {
			clearDetail();
			disableDetail(false);
			group.setReadonly('id',false);
		}
		
		/**
		 * Change upper id
		 */
		function changeUpperId(){
			// opens dialog
			__groupDialog.open({
				singleSelect:true,
				selectedGroups: new duice.List([{id:group.get('upperId')}]),
				onAfterConfirm: function(selectedGroups){
					var selectedGroup = selectedGroups.get(0);
					if(selectedGroup){
						group.set('upperId', selectedGroup.get('id'));
					}
				}
			});
		}
		
		/**
		 * Saves group
		 */
		function saveGroup(){
			
			// checks changes
			if(!group.isDirty()
			&& !groupRoles.isDirty()
			&& !groupAuthorities.isDirty()
			){
				new duice.Alert("[[#{application.message.changeNotFound}]]").open();
				return;
			}
			
			new duice.Confirm("[[#{application.message.saveConfirm(#{application.label.group})}]]")
			.onAfterConfirm(function(){
				var data = group.toJson();
				data.roles = groupRoles.toJson();
				data.authorities = groupAuthorities.toJson();
				$.ajax({
					 url: 'group/saveGroup'
					,type: 'POST'
					,data: JSON.stringify(data)
					,contentType: 'application/json;charset=UTF-8'
					,success: function(data, textStatus, jqXHR) {
						new duice.Alert('[[#{application.message.saveComplete(#{application.label.group})}]]')
						.onAfterClose(function(){
							getGroups();
						}).open();
			   	 	}
				});	
			}).open();
		}
		
		/**
		 * Deletes group
		 */
		function deleteGroup(){
			new duice.Confirm("[[#{application.message.deleteConfirm(#{application.label.group})}]]")
			.onAfterConfirm(function(){
				$.ajax({
					 url: 'group/deleteGroup'
					,type: 'DELETE'
					,data: JSON.stringify(group.toJson())
					,contentType: 'application/json;charset=UTF-8'
					,success: function(data, textStatus, jqXHR) {
						new duice.Alert("[[#{application.message.deleteComplete(#{application.label.group})}]]")
						.onAfterClose(function(){
							getGroups();
						}).open();
			   	 	}
				});
			}).open();
		
		}
		
		/**
		 * Adds group role
		 */
		function addGroupRole() {
			__roleDialog.open({
				disabledRoles: groupRoles,
				onAfterConfirm: function(selectedRoles){
					selectedRoles.forEach(function(selectedRole){
						groupRoles.add(selectedRole);
					});
				}
			});
		}
		
		/**
		 * Removes group role
		 */
		function removeGroupRole(index) {
			groupRoles.remove(index);
		}
		
		/**
		 * Adds group authority
		 */
		function addGroupAuthority() {
			__authorityDialog.open({
				disabledAuthorities: groupAuthorities,
				onAfterConfirm: function(selectedAuthorities){
					selectedAuthorities.forEach(function(selectedAuthority){
						groupAuthorities.add(selectedAuthority);
					});
				}
			});
		}
		
		/**
		 * Removes authority
		 */
		function removeAuthority(index) {
			groupAuthorities.remove(index);
		}
	
	</script>

	<div class="app-row">
		<div class="app-col">
			<h1>
				<img class="icon large" th:src="@{/static/image/icon_group.png}"/>
				<span data-th-text="#{application.label.group}+' '+#{application.label.management}"></span>
			</h1>
		</div>
	</div>
	<hr class="hr"/>
	<div class="app-row">
		<div class="app-col" style="width:50%;">
			<div class="app-row">
				<div class="app-col">
					<ul is="duice-ui-ul" 
					data-duice-bind="groups,group" 
					data-duice-selectable="true"
					data-duice-hierarchy="id,upperId"
					data-duice-foldable="true">
						<li>
							<div style="border-bottom:dotted 1px #ccc;">
								<img is="duice-ui-img" data-duice-bind="group,icon" th:src="@{/static/image/icon_group.png}" class="icon small"/>
								<span is="duice-ui-span" data-duice-bind="group,name" style="font-weight:bold;"></span>
							</div>
						</li>
					</ul>
				</div>
			</div>		
		</div>
		<div class="app-col" style="width:50%;">
			<div class="app-row">
				<div class="app-col">
					<img class="icon" th:src="@{/static/image/icon_group.png}"/>
					<span data-th-text="#{application.label.group}+' '+#{application.label.details}" class="font-bold"></span>
				</div>
				<div class="app-col right">
					<button id="addGroupButton" class="button" onclick="addGroup();">
						<img th:src="@{/static/image/icon_create.png}" class="icon"/>
						<span data-th-text="#{application.label.new}"></span>
					</button>
					<button id="deleteGroupButton" class="button" onclick="deleteGroup();">
						<img th:src="@{/static/image/icon_delete.png}" class="icon"/>
						<span data-th-text="#{application.label.delete}"></span>
					</button>
					<button id="saveGroupButton" class="button" onclick="saveGroup();">
						<img th:src="@{/static/image/icon_save.png}" class="icon"/>
						<span data-th-text="#{application.label.save}"></span>
					</button>
				</div>
			</div>
			<div class="app-row">
				<div class="app-col">
					<table class="table" style="width:100%;">
						<col style="width:25%;"/>
						<col/>
						<tbody>
							<tr>
								<th><span data-th-text="#{application.label.group}+' '+#{application.label.id}" class="mand">Group ID</span></th>
								<td><input is="duice-ui-input" type="text" data-duice-bind="group,id"/></td>
							</tr>
							<tr>
								<th data-th-text="#{application.label.upper}+' '+#{application.label.group}">Upper Group</th>
								<td>
									<span is="duice-ui-span" data-duice-bind="group,upperId"></span>
									<button class="button small" onclick="changeUpperId();">
										<img th:src="@{/static/image/icon_change.png}" class="icon small"/>
										<span data-th-text="#{application.label.change}">Change</span>
									</button>
								</td>
							</tr>
							<tr>
								<th data-th-text="#{application.label.group}+' '+#{application.label.icon}">Group Icon</th>
								<td><img is="duice-ui-img" data-duice-bind="group,icon" th:src="@{/static/image/icon_group.png}"/></td>
							</tr>
							<tr>
								<th data-th-text="#{application.label.group}+' '+#{application.label.name}">Group Name</th>
								<td><input is="duice-ui-input" type="text" data-duice-bind="group,name"/></td>
							</tr>
							<tr>
								<th data-th-text="#{application.label.group}+' '+#{application.label.description}">Group Description</th>
								<td><textarea is="duice-ui-textarea" data-duice-bind="group,description" style="height:6rem;"></textarea></td>
							</tr>
							<tr>
								<th>
									<img class="icon" th:src="@{/static/image/icon_role.png}"/>
									<br/>
									<span data-th-text="#{application.label.own}+' '+#{application.label.role}"></span>
								</th>
								<td>
									<table is="duice-ui-table" 
									data-duice-bind="groupRoles,role" 
									style="width:100%;">
										<col style="width:50px;"/>
										<col style="width:35%;"/>
										<col/>
										<col style="width:5%;"/>
										<thead>
											<tr>
												<th data-th-text="#{application.label.no}">No</th>
												<th data-th-text="#{application.label.role}+' '+#{application.label.id}">ID</th>
												<th data-th-text="#{application.label.role}+' '+#{application.label.name}">Name</th>
												<th class="text-center">
													<button class="button small" onclick="addGroupRole();">
														+
													</button>
												</th>
											</tr>
										</thead>
										<tbody>
											<tr>
												<td class="text-center">
													<span is="duice-ui-scriptlet" data-duice-bind="role">return $context.index+1;</span>
												</td>
												<td>
													<img is="duice-ui-img" data-duice-bind="role,icon" th:src="@{/static/image/icon_role.png}" class="icon small"/>
													<span is="duice-ui-span" data-duice-bind="role,id"></span>
												</td>
												<td><span is="duice-ui-span" data-duice-bind="role,name"></span></td>
												<td class="text-center">
													<button class="button small" data-index="[[$context.index]]" onclick="removeGroupRole(this.dataset.index);">
														-
													</button>
												</td>
											</tr>
										</tbody>
									</table>
								</td>
							</tr>
							<tr>
								<th>
									<img class="icon" th:src="@{/static/image/icon_authority.png}"/>
									<br/>
									<span data-th-text="#{application.label.own}+' '+#{application.label.authority}">Own Authority</span>
								</th>
								<td>
									<table is="duice-ui-table" 
										data-duice-bind="groupAuthorities,authority" 
										style="width:100%;">
										<col style="width:50px;"/>
										<col style="width:35%;"/>
										<col/>
										<col style="width:5%;"/>
										<thead>
											<tr>
												<th data-th-text="#{application.label.no}">No</th>
												<th data-th-text="#{application.label.authority}+' '+#{application.label.id}">Authority ID</th>
												<th data-th-text="#{application.label.authority}+' '+#{application.label.name}">Authority Name</th>
												<th class="text-center">
													<button class="button small" onclick="addGroupAuthority();">
														+
													</button>
												</th>
											</tr>
										</thead>
										<tbody>
											<tr>
												<td class="text-center">
													<span is="duice-ui-scriptlet" data-duice-bind="authority">return $context.index+1;</span>
												</td>
												<td>
													<img is="duice-ui-img" data-duice-bind="authority,icon" th:src="@{/static/image/icon_authority.png}" class="icon small"/>
													<span is="duice-ui-span" data-duice-bind="authority,id"></span>
												</td>
												<td><span is="duice-ui-span" data-duice-bind="authority,name"></span></td>
												<td class="text-center">
													<button class="button small" data-index="[[$context.index]]" onclick="removeGroupAuthority(this.dataset.index);">
														-
													</button>
												</td>
											</tr>
										</tbody>
									</table>
								</td>
							</tr>
						</tbody>
					</table>
				</div>
			</div>
		</div>
	</div>
</div>










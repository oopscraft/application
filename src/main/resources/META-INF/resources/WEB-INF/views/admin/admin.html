<!DOCTYPE html>
<html>
	<head>
		<meta charset="UTF-8">
		<meta name="viewport" content="width=2048,initial-scale=1">
    	<title>Application</title>
		<link rel="stylesheet" type="text/css" th:href="@{/static/duice/polyfill/normalize.css}">
		<script th:src="@{/static/duice/polyfill/dataset.js}"></script>
		<script th:src="@{/static/duice/polyfill/classList.js}"></script>
		<script th:src="@{/static/duice/duice.js}"></script>
		<link rel="stylesheet" type="text/css" th:href="@{/static/duice/duice.css}">
		<script th:src="@{/static/duice/widget/duice.widget.pagination.js}"></script>
		<link rel="stylesheet" type="text/css" th:href="@{/static/duice/widget/duice.widget.pagination.css}">
		<script th:src="@{/static/duice/integrate/ckeditor/ckeditor.js}"></script>
		<script th:src="@{/static/duice/integrate/duice.integrate.ckeditor.js}"></script>
		<script th:src="@{/static/jquery.js}"></script>
		<link rel="stylesheet" type="text/css" th:href="@{/static/application.css}">
		<script th:src="@{/static/application.js}"></script>
		<script th:src="@{/static/marked/marked.min.js}"></script>
		<link rel="stylesheet" th:href="@{/static/prism/prism.css}">
		<script th:src="@{/static/prism/prism.js}"></script>
		<script th:src="@{/static/libphonenumber.js}"></script>
		<script th:src="@{/static/moment.js}"></script>
		<script th:src="@{/static/chartjs/Chart.js}"></script>
		<script>
		const __menus = new duice.List();
		__menus.setReadonly('icon', true);
		__menus.fromJson([
			{ name:'[[#{application.user}]]', icon:'[[@{/static/image/icon_user.png}]]', linkUrl:'[[@{/admin/user}]]' },
			{ name:'[[#{application.group}]]', icon:'[[@{/static/image/icon_group.png}]]', linkUrl:'[[@{/admin/group}]]' },
			{ name:'[[#{application.role}]]', icon:'[[@{/static/image/icon_role.png}]]', linkUrl:'[[@{/admin/role}]]' },
			{ name:'[[#{application.authority}]]', icon:'[[@{/static/image/icon_authority.png}]]', linkUrl:'[[@{/admin/authority}]]' },
			{ name:'[[#{application.property}]]', icon:'[[@{/static/image/icon_property.png}]]', linkUrl:'[[@{/admin/property}]]' },
			{ name:'[[#{application.message}]]', icon:'[[@{/static/image/icon_message.png}]]', linkUrl:'[[@{/admin/message}]]' },
			{ name:'[[#{application.code}]]', icon:'[[@{/static/image/icon_code.png}]]', linkUrl:'[[@{/admin/code}]]' },
			{ name:'[[#{application.menu}]]', icon:'[[@{/static/image/icon_menu.png}]]', linkUrl:'[[@{/admin/menu}]]' },
			{ name:'[[#{application.board}]]', icon:'[[@{/static/image/icon_board.png}]]', linkUrl:'[[@{/admin/board}]]' },
			{ name:'[[#{application.api}]]', icon:'[[@{/static/image/icon_api.png}]]', linkUrl:'[[@{/admin/api}]]' },
		]);
		
        /**
         * Exeuctes logout
         */ 
        function __logout(){
			$.ajax({
				 url: '[[@{/admin/logout}]]'
				,type: 'POST'
				,success: function(data, textStatus, jqXHR) {
					location.href='[[@{/admin}]]';
		    	 }
			});
        }
		</script>
	</head>
	<body>
		<!-- auto completion off -->
		<div style="display:none;">
			<input type="text"/>
			<input type="password"/>
		</div>
		<!-- ================================================== -->
		<!-- START: top											-->
		<!-- ================================================== -->
		<div class="app-row" style="padding:0px 20px; height:70px; background-color:#fafafa; border-bottom:groove 2px #ccc;">
			<div class="app-col left middle">
				<a th:href="@{/admin}">
					<img th:src="@{/static/image/application.png}"/>
				</a>
			</div>
			<div class="app-col right middle">
				<img th:src="${__user.photo}" class="icon" style="width:32px; height:32px; border-radius:32px;"/>
				<span data-th-text="${__user.name}" style="font-weight:bold;"></span>
				&nbsp;&nbsp;&nbsp;
				<img class="icon" th:src="@{/static/image/icon_logout.png}"/>
				<span data-th-text="#{application.global.logout}" onclick="__logout();" class="link"></span>
				&nbsp;&nbsp;&nbsp;
				<img class="icon" th:src="@{/static/image/icon_language.png}"/>
				<select class="duice-select" onchange="__changeLanguage(this.value);" style="width:100px;">
					<option th:each="language:${__languages}" th:value="${language.language}" th:text="${language.displayLanguageByLocale}" th:selected="${language.language} == ${#locale.language}"></option>
				</select>
			</div>
		</div>
		<!-- ================================================== -->
		<!-- END: top											-->
		<!-- ================================================== -->
		<div class="app-row" style="min-height:calc(100% - 120px);">
			<!-- ================================================== -->
			<!-- START: menu										-->
			<!-- ================================================== -->
			<div class="app-col" style="width:10%;">
				<ul is="duice-ul"
				data-duice-bind="__menus,__menu" 
				data-duice-hierarchy="id,upperId"
				data-duice-foldable="false"
				style="margin: 1.5rem 1rem;">
					<li>
						<a href="javascript:void(0);" 
						data-link-url="[@duice[$context.__menu.get('linkUrl')]]" 
						data-link-target="[@duice[$context.__menu.get('linkTarget')]]"
						onclick="javascript:__openLink(this.dataset.linkUrl, this.dataset.linkTarget);"
						style="display:block; border-bottom:dotted 1px #ccc; line-height:2.5rem;">
							<img is="duice-img" data-duice-bind="__menu,icon" th:src="@{/static/image/icon_menu.png}" style="width:24px; height:24px;"/>
							<span is="duice-span" data-duice-bind="__menu,name" style="font-weight:bold;"></span>
						</a>
					</li>
				</ul>
				<br/>
				<div style="padding-left:20px;">
					<a th:href="@{/swagger-ui.html}" target="blank" >
						<img class="banner" th:src="@{/static/image/banner_swagger.png}"/>
					</a>
					<br/><br/>
					<a href="https://github.com/oopscraft/application" target="blank">
						<img class="banner" th:src="@{/static/image/banner_github.png}"/>
					</a>
				</div>
			</div>
			<!-- ================================================== -->
			<!-- START: menu										-->
			<!-- ================================================== -->
			<!-- ================================================== -->
			<!-- START: content										-->
			<!-- ================================================== -->
			<div layout:fragment="content" class="app-col" style="width:calc(100% - 200px); padding:1rem;">
				<script>
				// defines variables		
				const webSocketClient = new duice.WebSocketClient();
				var loadAverageChart = null;
				var memoryChart = null;
				var threadInfoChart = null;
				var classLoadingChart = null;
				const threadInfos = new duice.List();
				
				// document ready
				$(document).ready(function() {
					
					// creates web socket
					getMonitors();
					
					// connects web socket
				    var webSocketUrl = (window.location.protocol === 'https'?'wss':'ws')+'://'+location.host+'/api/webSocket';
					webSocketClient.open(webSocketUrl);
					webSocketClient.onMessage(function(event){
						var data = JSON.parse(event.data);
						
						// monitor
						if(data.id === 'Monitor'){
							var monitor = data;
							$('#top').text(monitor.top);
							
							// updates chart
							updateLoadAverageChart(monitor);
							updateMemoryChart(monitor);
							updateThreadInfoChart(monitor);
							updateClassLoadingChart(monitor);
							
							// updates threadInfos
							threadInfos.fromJson(monitor.threadInfos);
						}
					});
				});
				
				/**
				 * Getting monitors
				 */
				function getMonitors() {
					$.ajax({
						 url: '[[@{/api/monitors}]]'
						,type: 'GET'
						,data: null
					})
					.done(function(data, textStatus, jqXHR) {
						var monitors = data;
						var lastMonitor = data[data.length-1];
						$('#top').text(lastMonitor.top);
						
						// initializes chart
						initializeLoadAverageChart(monitors);
						initializeMemoryChart(monitors);
						initializeThreadInfoChart(monitors);
						initializeClassLoadingChart(monitors);
						
						// setting threadInfos
						threadInfos.fromJson(lastMonitor.threadInfos);
				   	});
				}
				
				/**
				 * initializeLoadAverageChart
				 */
				function initializeLoadAverageChart(monitors) {
					var labels = new Array();
					var data = new Array();
					var yMax;
					monitors.forEach(function(monitor){
						labels.push(moment().format('HH:mm:ss',monitor.date));
						data.push(monitor.operatingSystem.systemLoadAverage);
						yMax = monitor.operatingSystem.availableProcessors;
					});
					
					// creates chart
					loadAverageChart = new Chart(document.getElementById("loadAverageChart").getContext('2d'), {
					    type: 'line',
					    data: {
					        labels: labels,
					        datasets: [{
					            label: 'System Load Average',
					            data: data,
					            fill: true,
					            borderColor: 'steelblue',
					            backgroundColor: 'rgba(75, 192, 192, 0.2)',
					            borderWidth: 1
					        }]},
					    options: {
							responsive: true,
							legend: {
							    position: 'top',
							    align: 'start',
							    labels: {
							    	boxWidth: 20,
							    	fontSize: 11,
							    	fontStyle: 'bold'
							    }
							},
					    	scales: {
								yAxes: [{
									ticks: {
										fontSize: 8,
										beginAtZero: true,
										suggestedMax: yMax
									}
								}],
								xAxes: [{
									ticks: {
										fontSize: 8
									}
								}]
							},
							elements: {
								point: {
									pointStyle: 'crossRot'
								}
							}
					    }
					});
				}
				
				/**
				 * updateLoadAverageChart
				 */
				function updateLoadAverageChart(monitor) {
					loadAverageChart.config.options.scales.yAxes[0].ticks.suggestedMax = monitor.operatingSystem.availableProcessors;
					loadAverageChart.config.data.labels.shift();
					loadAverageChart.config.data.labels.push(moment().format('HH:mm:ss',monitor.date));
					loadAverageChart.config.data.datasets[0].data.shift();
					loadAverageChart.config.data.datasets[0].data.push(monitor.operatingSystem.systemLoadAverage);
					loadAverageChart.update();
				}
				
				/**
				 * initializeMemoryChart
				 */
				function initializeMemoryChart(monitors) {
					var labels = new Array();
					var data = new Array();
					var yMax;
					monitors.forEach(function(monitor){
						console.log(monitor);
						labels.push(moment().format('HH:mm:ss',monitor.date));
						data.push(monitor.memory.heapMemoryUsage.used/1024/1024);
						yMax = Math.max(monitor.memory.heapMemoryUsage.committed, monitor.memory.heapMemoryUsage.max)/1024/1024;
					});
					
					// creates chart
					memoryChart = new Chart(document.getElementById("memoryChart").getContext('2d'), {
					    type: 'line',
					    data: {
					        labels: labels,
					        datasets: [{
					            label: 'Heap Memory Usage',
					            data: data,
					            fill: true,
					            borderColor: 'steelblue',
					            backgroundColor: 'rgba(75, 192, 192, 0.2)',
					            borderWidth: 1
					        }]},
					    options: {
							responsive: true,
							legend: {
							    position: 'top',
							    align: 'start',
							    labels: {
							    	boxWidth: 20,
							    	fontSize: 11,
							    	fontStyle: 'bold'
							    }
							},
					    	scales: {
								yAxes: [{
									ticks: {
										fontSize: 8,
										beginAtZero: true,
										suggestedMax: yMax,
									    userCallback: function(value, index, values) {
									        return new duice.NumberMask(0).encode(value) + ' m';
									    }
									}
								}],
								xAxes: [{
									ticks: {
										fontSize: 8
									}
								}]
							},
							elements: {
								point: {
									pointStyle: 'crossRot'
								}
							}
					    }
					});
				}
				
				/**
				 * updateMemoryChart
				 */
				function updateMemoryChart(monitor) {
					memoryChart.config.options.scales.yAxes[0].ticks.suggestedMax = Math.max(monitor.memory.heapMemoryUsage.committed, monitor.memory.heapMemoryUsage.max)/1024/1024;
					memoryChart.config.data.labels.shift();
					memoryChart.config.data.labels.push(moment().format('HH:mm:ss',monitor.date));
					memoryChart.config.data.datasets[0].data.shift();
					memoryChart.config.data.datasets[0].data.push(monitor.memory.heapMemoryUsage.used/1024/1024);
					memoryChart.update();
				}
				
				/**
				 * initializeThreadInfoChart
				 */
				function initializeThreadInfoChart(monitors) {
					var labels = new Array();
					var data = new Array();
					var yMax = 100;
					monitors.forEach(function(monitor){
						labels.push(moment().format('HH:mm:ss',monitor.date));
						data.push(monitor.threadInfos.length);
						yMax = Math.pow(10,String(monitor.threadInfos.length).length);
					});
					
					// creates chart
					threadInfoChart = new Chart(document.getElementById("threadInfoChart").getContext('2d'), {
					    type: 'line',
					    data: {
					        labels: labels,
					        datasets: [{
					            label: 'Thread Info',
					            data: data,
					            fill: true,
					            borderColor: 'steelblue',
					            backgroundColor: 'rgba(75, 192, 192, 0.2)',
					            borderWidth: 1
					        }]},
					    options: {
							responsive: true,
							legend: {
							    position: 'top',
							    align: 'start',
							    labels: {
							    	boxWidth: 20,
							    	fontSize: 11,
							    	fontStyle: 'bold'
							    }
							},
					    	scales: {
								yAxes: [{
									ticks: {
										fontSize: 8,
										beginAtZero: true,
										suggestedMax: yMax,
									    userCallback: function(value, index, values) {
									        return new duice.NumberMask(0).encode(value);
									    }
									}
								}],
								xAxes: [{
									ticks: {
										fontSize: 8
									}
								}]
							},
							elements: {
								point: {
									pointStyle: 'crossRot'
								}
							}
					    }
					});
				}
				
				/**
				 * updateThreadInfoChart
				 */
				function updateThreadInfoChart(monitor) {
					threadInfoChart.config.options.scales.yAxes[0].ticks.suggestedMax = Math.pow(10,String(monitor.threadInfos.length).length);
					threadInfoChart.config.data.labels.shift();
					threadInfoChart.config.data.labels.push(moment().format('HH:mm:ss',monitor.date));
					threadInfoChart.config.data.datasets[0].data.shift();
					threadInfoChart.config.data.datasets[0].data.push(monitor.threadInfos.length);
					threadInfoChart.update();
				}
				
				/**
				 * initializeClassLoadingChart
				 */
				function initializeClassLoadingChart(monitors) {
					var labels = new Array();
					var data = new Array();
					var yMax = 100;
					monitors.forEach(function(monitor){
						labels.push(moment().format('HH:mm:ss',monitor.date));
						data.push(monitor.classLoading.totalLoadedClassCount);
						yMax = Math.pow(10,String(monitor.classLoading.totalLoadedClassCount).length);
					});
					
					// creates chart
					classLoadingChart = new Chart(document.getElementById("classLoadingChart").getContext('2d'), {
					    type: 'line',
					    data: {
					        labels: labels,
					        datasets: [{
					            label: 'Class Loading',
					            data: data,
					            fill: true,
					            borderColor: 'steelblue',
					            backgroundColor: 'rgba(75, 192, 192, 0.2)',
					            borderWidth: 1
					        }]},
					    options: {
							responsive: true,
							legend: {
							    position: 'top',
							    align: 'start',
							    labels: {
							    	boxWidth: 20,
							    	fontSize: 11,
							    	fontStyle: 'bold'
							    }
							},
					    	scales: {
								yAxes: [{
									ticks: {
										fontSize: 8,
										beginAtZero: true,
										suggestedMax: yMax,
									    userCallback: function(value, index, values) {
									        return new duice.NumberMask(0).encode(value);
									    }
									}
								}],
								xAxes: [{
									ticks: {
										fontSize: 8
									}
								}]
							},
							elements: {
								point: {
									pointStyle: 'crossRot'
								}
							}
					    }
					});
				}
				
				/**
				 * updateClassLoadingChart
				 */
				function updateClassLoadingChart(monitor) {
					classLoadingChart.config.options.scales.yAxes[0].ticks.suggestedMax = Math.pow(10,String(monitor.classLoading.totalLoadedClassCount).length);
					classLoadingChart.config.data.labels.shift();
					classLoadingChart.config.data.labels.push(moment().format('HH:mm:ss',monitor.date));
					classLoadingChart.config.data.datasets[0].data.shift();
					classLoadingChart.config.data.datasets[0].data.push(monitor.classLoading.totalLoadedClassCount);
					classLoadingChart.update();
				}
				</script>
				<div class="app-row title">
					<div class="app-col bottom">
						<h1>
							<img class="icon large" th:src="@{/static/image/icon_monitor.png}"/>
							<span data-th-text="#{application.monitor}"></span>
						</h1>
					</div>
				</div>
				<div class="app-row">
					<div class="app-col">
						<pre style="margin:0px; height:300px; border-radius:3px;">
							<code id="top" class="language-bash line-numbers" style="white-space:pre-wrap;"></code>
						</pre>
					</div>
				</div>
				<div class="app-row">
					<div class="app-col" style="width:20%;">
						<canvas id="loadAverageChart"></canvas>
					</div>
					<div class="app-col" style="width:20%;">
						<canvas id="memoryChart"></canvas>
					</div>
					<div class="app-col" style="width:20%;">
						<canvas id="threadInfoChart"></canvas>
					</div>
					<div class="app-col" style="width:20%;">
						<canvas id="classLoadingChart"></canvas>
					</div>
				</div>
				<div class="app-row">
					<div class="app-col">
						<table is="duice-table" 
						data-duice-bind="threadInfos,threadInfo" 
						style="width:100%; font-size: 10px;">
							<col/>
							<col/>
							<col/>
							<col/>
							<col/>
							<col/>
							<col/>
							<thead style="background-color:#fafafa;">
								<tr>
									<th>Thread ID</th>
									<th>Thread Name</th>
									<th>Thread State</th>
									<th>Waited Count</th>
									<th>Waited Time</th>
									<th>Block Count</th>
									<th>Block Time</th>
								</tr>
							</thead>
							<tbody>
								<tr>
									<td><span is="duice-span" data-duice-bind="threadInfo,threadId"></span></td>
									<td><span is="duice-span" data-duice-bind="threadInfo,threadName"></span></td>
									<td><span is="duice-span" data-duice-bind="threadInfo,threadState"></span></td>
									<td><span is="duice-span" data-duice-bind="threadInfo,waitedCount"></span></td>
									<td><span is="duice-span" data-duice-bind="threadInfo,waitedTime"></span></td>
									<td><span is="duice-span" data-duice-bind="threadInfo,blockCount"></span></td>
									<td><span is="duice-span" data-duice-bind="threadInfo,blockTime"></span></td>
								</tr>
							</tbody>
						</table>
					</div>
				</div>
			</div>
			<!-- ================================================== -->
			<!-- END: content										-->
			<!-- ================================================== -->
		</div>
		<!-- ================================================== -->
		<!-- START: footer										-->
		<!-- ================================================== -->
		<div style="text-align:center; border-top:dotted 1px #ccc;">
			<img th:src="@{/static/image/copyright.png}"/>
		</div>
		<!-- ================================================== -->
		<!-- END: footer										-->
		<!-- ================================================== -->
		
		<!-- ====================================================== -->
		<!-- START: Groups Dialog									-->
		<!-- ====================================================== -->
		<dialog is="duice-dialog" id="__groupDialog" style="width:800px;">
			<div class="app-row title">
				<div class="app-col bottom">
					<h2>
						<img class="icon" th:src="@{/static/image/icon_group.png}"/>
						<span data-th-text="#{application.group} + ' ' + #{application.global.select}" class="font-bold"></span>
					</h2>
				</div>
			</div>
			<div class="app-row">
				<div class="app-col">
					<ul is="duice-ul" 
					data-duice-bind="__groupDialog.groups,group" 
					data-duice-hierarchy="id,upperId"
					data-duice-selectable="true"
					data-duice-foldable="true"
					style="max-height:600px; overflow-y:scroll;">
						<li>
							<div class="app-row" style="width:100%;border-bottom:dotted 1px #ccc;">
								<div class="app-col">
									<img is="duice-img" data-duice-bind="group,icon" th:src="@{/static/image/icon_group.png}" class="icon small"/>
									<span is="duice-span" data-duice-bind="group,name" style="font-weight:bold;"></span>
								</div>
								<div class="app-col text-right">
									<input is="duice-input" type="checkbox" data-duice-bind="group,__checked"/>
								</div>
							</div>
						</li>
					</ul>				
				</div>
			</div>
			<div class="app-row">
				<div class="app-col right">
					<button class="button" onclick="__groupDialog.confirm();">
						<img th:src="@{/static/image/icon_confirm.png}" class="icon small"/>
						<span data-th-text="#{application.global.confirm}"></span>
					</button>
				</div>
			</div>
		</dialog>
		<script>
		/**
		 * Global common group select dialog
		 */
        const __groupDialog = {
        	dialog: new duice.Dialog(document.getElementById('__groupDialog')),
        	groups: new duice.List(),
        	
        	// option
        	singleSelect: false,
        	checkedGroups: null,
        	disabledGroups: null,

        	/**
        	 * Opens group dialog
        	 * @param option.singleSelect 
			 * @param option.selectedGroups 
			 * @param option.disabledGroups 
			 * @param option.onAfterConfirm
        	 */
        	async open(option) {
        		
        		// setting options
        		this.singleSelect = option.singleSelect||false;
        		this.checkedGroups = option.checkedGroups||[];
        		this.disabledGroups = option.disabledGroups||[];
        		this.dialog.onAfterConfirm(option.onAfterConfirm||function(){});
        		
        		// defines index change event
        		var _this = this;
        		this.groups.setReadonly('__checked', true);
        		this.groups.onAfterSelectRow(function(group){
       				
       				// check disabled
       				if(group.isDisable('id') === true){
       					return;
       				}
       				
       				// if singleSelect, desleect all except self index
       				if(_this.singleSelect === true){
       					_this.groups.forEach(function(row){
       						if(row.get('id') !== group.get('id')){
       							row.set('__checked', false);        							
       						}
       					});
       				}

       				// toggles __checked
       				var __checked = group.get('__checked');
       				if(__checked === true){
       					group.set('__checked', false);
       				}else{
       					group.set('__checked', true);
       				}
        		});
        		
        		// retrieves and open
        		await this.getGroups(1);
        		this.dialog.open();
        	},
        	
        	/**
        	 * Getting groups
        	 */
        	getGroups(page) {
				var _this = this;
				return new Promise(function(resolve,reject){
					$.ajax({
						 url: '[[@{/admin/getGroups}]]'
						,type: 'GET'
						,data: {page:page, rows:10000}
						,success: function(data, textStatus, jqXHR) {
							_this.groups.fromJson(data);
							_this.groups.forEach(function(group){
								var id = group.get('id');
								
								// checks __selected value, if it set as selected list.
								_this.checkedGroups.forEach(function(item){
									if(item.id === id){
										group.set('__checked', true);
									}
								});
								
								// excepts disableds list
								_this.disabledGroups.forEach(function(item){
									if(item.id === id){
										group.setDisableAll(true);
									}
								});
							});
							resolve(true);
						}
					});
				});
        	},
        	
        	/**
        	 * Executes dialog confirm.
        	 */
        	confirm() {
				var checkedGroups = new Array();
				this.groups.forEach(function(group){
					if(group.isDisable() === false && group.get('__checked') === true){
						checkedGroups.push(group.toJson());
					}
				});
				this.dialog.confirm(checkedGroups);
        	}
        }
		</script>
		<!-- ====================================================== -->
		<!-- END: Groups Dialog										-->
		<!-- ====================================================== -->
		
		<!-- ====================================================== -->
		<!-- START: Roles Dialog									-->
		<!-- ====================================================== -->
		<dialog is="duice-dialog" id="__roleDialog" style="width:800px;">
			<div class="app-row title">
				<div class="app-col bottom">
					<h2>
						<img class="icon" th:src="@{/static/image/icon_role.png}"/>
						<span data-th-text="#{application.role}+' '+#{application.global.select}" class="font-bold"></span>
					</h2>
				</div>
			</div>
			<div class="app-row search">
				<div class="app-col">
					<img class="icon" th:src="@{/static/image/icon_search.png}"/>
					<select is="duice-select" data-duice-bind="__roleDialog.search,key" style="width:125px;">
						<option value data-th-text="'- '+#{application.global.all}+' -'"></option>
						<option value="id" data-th-text="#{application.role.id}">Role ID</option>
						<option value="name" data-th-text="#{application.role.name}">Role Name</option>
					</select>
					<input is="duice-input" type="text" data-duice-bind="__roleDialog.search,value" style="width:250px;"/>
				</div>
				<div class="app-col right">
					<button class="button" onclick="__roleDialog.getRoles();">
						<img th:src="@{/static/image/icon_search.png}" class="icon"/>
						<span data-th-text="#{application.global.search}"></span>
					</button>
				</div>
			</div>
			<div class="app-row">
				<div class="app-col">
					<table is="duice-table" 
					data-duice-bind="__roleDialog.roles,role" 
					data-duice-selectable="true"
					style="width:100%;">
						<col style="width:5%;"/>					
						<col style="width:10%;"/>
						<col style="width:35%;"/>
						<col style="width:50%;"/>
						<thead>
							<tr>
								<th class="text-center">-</th>
								<th data-th-text="#{application.global.no}" class="text-center">No</th>
								<th data-th-text="#{application.role.id}">ID</th>
								<th data-th-text="#{application.role.name}">Name</th>
							</tr>
						</thead>
						<tbody>
							<tr>
								<td class="text-center"><input is="duice-input" type="checkbox" data-duice-bind="role,__checked" /></td>
								<td class="text-center"><small is="duice-scriptlet" data-duice-bind="role" data-duice-value="return $context.index+1;"></small></td>
								<td>
									<img is="duice-img" data-duice-bind="role,icon" th:src="@{/static/image/icon_role.png}" class="icon small"/>
									<span is="duice-span" data-duice-bind="role,id"></span>
								</td>
								<td><span is="duice-span" data-duice-bind="role,name"></span></td>
							</tr>
						</tbody>
					</table>
				</div>
			</div>
			<div class="app-row">
				<div class="app-col center">
					<ul is="duice-widget-pagination" data-duice-bind="__roleDialog.search,page,rows,totalCount" data-duice-size="5">
						<li onclick="__roleDialog.getRoles();"></li>
					</ul>
				</div>
			</div>
			<div class="app-row">
				<div class="app-col">
					<table is="duice-table" 
					data-duice-bind="__roleDialog.selectedRoles,role" 
					data-duice-selectable="true"
					style="width:100%;">
						<col style="width:10%;"/>
						<col style="width:35%;"/>
						<col/>
						<col style="width:5%;"/>
						<thead>
							<tr>
								<th data-th-text="#{application.global.no}" class="text-center">No</th>
								<th data-th-text="#{application.role.id}">ID</th>
								<th data-th-text="#{application.role.name}">Name</th>
								<th class="text-center">-</th>
							</tr>
						</thead>
						<tbody>
							<tr>
								<td class="text-center"><small is="duice-scriptlet" data-duice-bind="role" data-duice-value="return $context.index+1;"></small></td>
								<td>
									<img is="duice-img" data-duice-bind="role,icon" th:src="@{/static/image/icon_group.png}" class="icon small"/>
									<span is="duice-span" data-duice-bind="role,id"></span>
								</td>
								<td><span is="duice-span" data-duice-bind="role,name"></span></td>
								<td class="text-center">
									<img th:src="@{/static/image/icon_remove.png}" class="icon small button" data-index="[@duice[$context.index]]" onclick="__roleDialog.selectedRoles.removeRow(this.dataset.index);"/>
								</td>
							</tr>
						</tbody>
					</table>
				</div>
			</div>
			<div class="app-row action">
				<div class="app-col right">
					<button class="button" onclick="__roleDialog.confirm();">
						<img th:src="@{/static/image/icon_confirm.png}" class="icon"/>
						<span data-th-text="#{application.global.confirm}"></span>
					</button>
				</div>
			</div>
		</dialog>
		<script>
		/**
		 * Global common role dialog
		 */
        const __roleDialog = {
        	dialog: new duice.Dialog(document.getElementById('__roleDialog')),
        	search: new duice.Map({
        		page: 1,
        		rows: 10,
        		totalCount: -1
        	}),
        	roles: new duice.List(),
        	selectedRoles: new duice.List(),
        	
        	// option
        	checkedRoles: null,
        	disabledRoles: null,
        	onAfterConfirm: null,
        	
        	/**
        	 * Opens dialogs
        	 * @param option.checkedRoles:Array
			 * @param option.disabledRoles:Array
			 * @param option.onAfterConfirm:Function 
        	 */
        	async open(option) {
				this.checkedRoles = option.checkedRoles || [];
				this.disabledRoles = option.disabledRoles || [];
				this.dialog.onAfterConfirm(option.onAfterConfirm || new function(){});
        		this.selectedRoles.fromJson([]);
        		this.search.reset();
        		
        		// add index change event listener
        		var _this = this;
        		this.roles.setReadonly('__checked', true);
        		this.roles.onAfterSelectRow(function(role){
    				var id = role.get('id');
    				
    				// check disabled
    				if(role.isDisable('id') === true){
    					return;
    				}

    				// toggles __selected
    				var __checked = role.get('__checked');
    				if(__checked === true){
    					role.set('__checked', false);
    					_this.selectedRoles.forEach(function(row,index){
    						if(row.get('id') === id){
    							_this.selectedRoles.removeRow(index);
    							return false;
    						}
    					});
    				}else{
    					role.set('__checked', true);
    					_this.selectedRoles.addRow(new duice.Map(role.toJson()));
    				}
        		});

        		// retrieves roles and open
        		await this.getRoles(1);
        		this.dialog.open();
        	},

        	/**
			 * Getting groups
			 */
        	getRoles(page) {
        		var _this = this;
        		return new Promise(function(resolve,reject){
					if(page){
            			_this.search.set('page', page);
					}
    				var data = {};
    				if(_this.search.get('key')){
    					data[_this.search.get('key')] = _this.search.get('value');
    				}
    				data.page = _this.search.get('page');
    				data.rows = _this.search.get('rows');
					$.ajax({
						 url: '[[@{/admin/getRoles}]]'
						,type: 'GET'
						,data: data
						,success: function(data, textStatus, jqXHR) {
							_this.roles.fromJson(data);
							_this.search.set('totalCount', __parseTotalCount(jqXHR));
							
							// check earch role
							_this.roles.forEach(function(role){
								var id = role.get('id');
								
								// checks disabled	
								_this.disabledRoles.forEach(function(obj){
									if(obj.id === id){
										role.setDisableAll(true);
										role.set('__checked', true);
										return false;
									}
								});
								
								// checks already selected
								_this.selectedRoles.forEach(function(map){
									if(map.get('id') === id){
										role.set('__checked', true);
										return false;
									}
								});
							});
							resolve(true);
				   	 	}
					});
        		});
        	},

        	/**
        	 * Executes confirm
        	 */
        	confirm() {
        		this.dialog.confirm(this.selectedRoles.toJson());
        	}
        }
		</script>
		<!-- ====================================================== -->
		<!-- END: Roles Dialog										-->
		<!-- ====================================================== -->
		
		<!-- ====================================================== -->
		<!-- START: Authorities Dialog								-->
		<!-- ====================================================== -->
		<dialog is="duice-dialog" id="__authorityDialog" style="width:800px;">
			<div class="app-row title">
				<div class="app-col bottom">
					<h2>
						<img class="icon" th:src="@{/static/image/icon_authority.png}"/>
						<span data-th-text="#{application.authority}+' '+#{application.global.select}" class="font-bold"></span>
					</h2>
				</div>
			</div>
			<div class="app-row search">
				<div class="app-col">
					<img class="icon" th:src="@{/static/image/icon_search.png}"/>
					<select is="duice-select" data-duice-bind="__authorityDialog.search,key" style="width:125px;">
						<option value data-th-text="'- '+#{application.global.all}+' -'"></option>
						<option value="id" data-th-text="#{application.authority.id}">ID</option>
						<option value="name" data-th-text="#{application.authority.name}">Name</option>
					</select>
					<input is="duice-input" type="text" data-duice-bind="__authorityDialog.search,value" style="width:250px;"/>
				</div>
				<div class="app-col right">
					<button class="button" onclick="__authorityDialog.getAuthorities();">
						<img th:src="@{/static/image/icon_search.png}" class="icon"/>
						<span data-th-text="#{application.global.search}"></span>
					</button>
				</div>
			</div>
			<div class="app-row">
				<div class="app-col">
					<table is="duice-table" 
					data-duice-bind="__authorityDialog.authorities,authority" 
					data-duice-selectable="true"
					style="width:100%;">
						<col style="width:5%;"/>
						<col style="width:10%;"/>
						<col style="width:35%;"/>
						<col style="width:50%;"/>
						<thead>
							<tr>
								<th class="text-center">-</th>
								<th data-th-text="#{application.global.no}" class="text-center">No</th>
								<th data-th-text="#{application.authority.id}">ID</th>
								<th data-th-text="#{application.authority.name}">Name</th>
							</tr>
						</thead>
						<tbody>
							<tr>
								<td class="text-center"><input is="duice-input" type="checkbox" data-duice-bind="authority,__checked"/></td>
								<td class="text-center"><small is="duice-scriptlet" data-duice-bind="authority" data-duice-value="return $context.index+1;"></small></td>
								<td>
									<img is="duice-img" data-duice-bind="authority,icon" th:src="@{/static/image/icon_authority.png}" class="icon small"/>
									<span is="duice-span" data-duice-bind="authority,id"></span>
								</td>
								<td><span is="duice-span" data-duice-bind="authority,name"></span></td>
							</tr>
						</tbody>
					</table>
				</div>
			</div>
			<div class="app-row">
				<div class="app-col center">
					<ul is="duice-widget-pagination" data-duice-bind="__authorityDialog.search,page,rows,totalCount" data-duice-size="5">
						<li data-page="[@duice[$context.page]]" onclick="__authorityDialog.getAuthorities(this.dataset.page);"></li>
					</ul>
				</div>
			</div>
			<div class="app-row">
				<div class="app-col">
					<table is="duice-table" 
					data-duice-bind="__authorityDialog.selectedAuthorities,authority" 
					style="width:100%;">
						<col style="width:10%;"/>
						<col style="width:35%;"/>
						<col/>
						<col style="width:5%;"/>
						<thead>
							<tr>
								<th data-th-text="#{application.global.no}" class="text-center">No</th>
								<th data-th-text="#{application.authority.id}">Authority ID</th>
								<th data-th-text="#{application.authority.name}">Authority Name</th>
								<th class="text-center">-</th>
							</tr>
						</thead>
						<tbody>
							<tr>
								<td class="text-center"><small is="duice-scriptlet" data-duice-bind="authority" data-duice-value="return $context.index+1;"></small></td>
								<td>
									<img is="duice-img" data-duice-bind="authority,icon" th:src="@{/static/image/icon_authority.png}" class="icon small"/>
									<span is="duice-span" data-duice-bind="authority,id"></span>
								</td>
								<td><span is="duice-span" data-duice-bind="authority,name"></span></td>
								<td style="text-align:center;">
									<img th:src="@{/static/image/icon_remove.png}" class="icon small button" data-index="[@duice[$context.index]]" onclick="__authorityDialog.selectedAuthorities.removeRow(this.dataset.index);"/>
								</td>
							</tr>
						</tbody>
					</table>
				</div>
			</div>
			<div class="app-row action">
				<div class="app-col right">
					<button class="button" onclick="__authorityDialog.confirm();">
						<img th:src="@{/static/image/icon_confirm.png}" class="icon small"/>
						<span data-th-text="#{application.global.confirm}"></span>
					</button>
				</div>
			</div>
		</dialog>
		<script>
        var __authorityDialog = {
           	dialog: new duice.Dialog(document.getElementById('__authorityDialog')),
           	search: new duice.Map({
           		page: 1,
           		rows: 10,
           		totalCount: -1
           	}),
           	authorities: new duice.List(),
           	selectedAuthorities: new duice.List(),
           	
           	// option
           	checkedAuthorities: null,
           	disabledAuthorities: null,
           	onAfterConfirm: null,
           	
           	/**
           	 * Opens dialogs
           	 * @param option.checkedAuthorities:Array
   			 * @param option.disabledAuthorities:Array
   			 * @param option.onAfterConfirm:Function 
           	 */
           	async open(option) {
   				this.checkedAuthorities = option.checkedAuthorities || [];
   				this.disabledAuthorities = option.disabledAuthorities || [];
   				this.dialog.onAfterConfirm(option.onAfterConfirm || new function(){});
           		this.selectedAuthorities.fromJson([]);
           		this.search.reset();
           		
           		// add index change event listener
           		var _this = this;
           		this.authorities.setReadonly('__checked', true);
           		this.authorities.onAfterSelectRow(function(authority){
       				var id = authority.get('id');
       				
       				// checkes disabled
       				if(authority.isDisable('id') === true){
       					return false;
       				}

       				// toggles __selected
       				var __checked = authority.get('__checked');
       				if(__checked === true){
       					authority.set('__checked', false);
       					_this.selectedAuthorities.forEach(function(row,index){
       						if(row.get('id') === id){
       							_this.selectedAuthorities.removeRow(index);
       							return false;
       						}
       					});
       				}else{
       					authority.set('__checked', true);
       					_this.selectedAuthorities.addRow(new duice.Map(authority.toJson()));
       				}
           		});
           		
           		// retrieves and open
           		await this.getAuthorities(1);
           		this.dialog.open();
           	},

           	/**
   			 * Getting groups
   			 */
           	getAuthorities(page) {
   				var _this = this;
				return new Promise(function(resolve,reject){
					if(page){
            			_this.search.set('page', page);
					}
    				var data = {};
    				if(_this.search.get('key')){
    					data[_this.search.get('key')] = _this.search.get('value');
    				}
    				data.page = _this.search.get('page');
    				data.rows = _this.search.get('rows');
    				$.ajax({
    					 url: '[[@{/admin/getAuthorities}]]'
    					,type: 'GET'
    					,data: data
    					,success: function(data, textStatus, jqXHR) {
    						_this.authorities.fromJson(data);
    						_this.search.set('totalCount', __parseTotalCount(jqXHR));
    						
    						// check earch authority
    						_this.authorities.forEach(function(authority){
    							var id = authority.get('id');
    							
    							// checks disabled	
    							_this.disabledAuthorities.forEach(function(obj){
    								if(obj.id === id){
    									authority.setDisableAll(true);
    									authority.set('__checked', true);
    									return false;
    								}
    							});
    							
    							// checks already selected
    							_this.selectedAuthorities.forEach(function(map){
    								if(map.get('id') === id){
    									authority.set('__checked', true);
    									return false;
    								}
    							});
    						});
    						resolve(true);
    			   	 	}
    				});
				});  				
           	},

           	/**
           	 * Executes confirm
           	 */
           	confirm() {
           		this.dialog.confirm(this.selectedAuthorities.toJson());
           	}
		}
		</script>
		<!-- ====================================================== -->
		<!-- END: Authorities Dialog								-->
		<!-- ====================================================== -->

	</body>
</html>
<!DOCTYPE html>
<html>
	<head>
		<meta charset="UTF-8">
		<meta name="viewport" content="width=2048,initial-scale=1">
    	<title>Application</title>
		<link rel="stylesheet" type="text/css" th:href="@{/static/polyfill/normalize.css}">
		<script th:src="@{/static/polyfill/dataset.js}"></script>
		<script th:src="@{/static/polyfill/classList.js}"></script>
		<script th:src="@{/static/duice.js}"></script>
		<link rel="stylesheet" type="text/css" th:href="@{/static/duice.css}">
		<script th:src="@{/static/jquery.js}"></script>
		<link rel="stylesheet" type="text/css" th:href="@{/static/application.css}">
		<script th:src="@{/static/application.js}"></script>
		<script th:src="@{/static/marked/marked.min.js}"></script>
		<link rel="stylesheet" th:href="@{/static/prism/prism.css}">
		<script th:src="@{/static/prism/prism.js}"></script>
		<script th:src="@{/static/libphonenumber.js}"></script>
		<script th:src="@{/static/moment.js}"></script>
		<script th:src="@{/static/chartjs/Chart.js}"></script>
		<script>
        /**
         * Exeuctes logout
         */ 
        function __logout(){
			$.ajax({
				 url: '[[@{/admin/logout}]]'
				,type: 'POST'
				,success: function(data, textStatus, jqXHR) {
					location.href='[[@{/admin}]]';
		    	 }
			});
        }
		</script>
	</head>
	<body>
		<!-- auto completion off -->
		<div style="display:none;">
			<input type="text"/>
			<input type="password"/>
		</div>
		<div class="app-row" style="padding:10px 20px; background-color:#eee; border-bottom:dotted 1px #ccc;">
			<div class="app-col left middle">
				<a th:href="@{/admin}">
					<img th:src="@{/static/image/application.png}"/>
				</a>
			</div>
			<div class="app-col right middle">
				<img th:src="${__user.photo}" class="icon" style="width:32px; height:32px; border-radius:32px;"/>
				<span data-th-text="${__user.name}"></span>
				&nbsp;
				<span data-th-text="#{application.global.logout}" onclick="__logout();" class="link"></span>
				&nbsp;
				<select is="duice-select" onchange="__changeLanguage(this.value);" class="duice-ui-select" style="width:120px;">
					<option th:each="language:${__languages}" th:value="${language.language}" th:text="${language.displayLanguageByLocale}" th:selected="${language.language} == ${#locale.language}"></option>
				</select>
			</div>
		</div>
		<div class="app-row" style="min-height:calc(100% - 120px);">
			<div class="app-col" style="width:200px; padding:1rem;">
				<nav class="menu">
					<ul>
						<li>
							<a th:href="@{/admin/user}">
								<img class="menu-item__icon" th:src="@{/static/image/icon_user.png}"/>
								<span class="menu-item__text" data-th-text="#{application.user}">User</span>
							</a>
						</li>
						<li>
							<a th:href="@{/admin/group}">
								<img class="menu-item__icon" th:src="@{/static/image/icon_group.png}"/>
								<span class="menu-item__text" data-th-text="#{application.group}">Group</span>
							</a>
						</li>
						<li>
							<a th:href="@{/admin/role}">
								<img class="menu-item__icon" th:src="@{/static/image/icon_role.png}"/>
								<span class="menu-item__text" data-th-text="#{application.role}">Role</span>
							</a>
						</li>
						<li>
							<a th:href="@{/admin/authority}">
								<img class="menu-item__icon" th:src="@{/static/image/icon_authority.png}"/>
								<span class="menu-item__text" data-th-text="#{application.authority}">Authority</span>
							</a>
						</li>
						<li>
							<a th:href="@{/admin/property}">
								<img class="menu-item__icon" th:src="@{/static/image/icon_property.png}"/>
								<span class="menu-item__text" data-th-text="#{application.property}">Property</span>
							</a>
						</li>
						<li>
							<a th:href="@{/admin/code}">
								<img class="menu-item__icon" th:src="@{/static/image/icon_code.png}"/>
								<span class="menu-item__text" data-th-text="#{application.code}">Code</span>
							</a>
						</li>
						<li>
							<a th:href="@{/admin/menu}">
								<img class="menu-item__icon" th:src="@{/static/image/icon_menu.png}"/>
								<span class="menu-item__text" data-th-text="#{application.menu}">Menu</span>
							</a>
						</li>
						<li>
							<a th:href="@{/admin/message}">
								<img class="menu-item__icon" th:src="@{/static/image/icon_message.png}"/>
								<span class="menu-item__text" data-th-text="#{application.message}">Message</span>
							</a>
						</li>
						<li>
							<a th:href="@{/admin/board}">
								<img class="menu-item__icon" th:src="@{/static/image/icon_board.png}"/>
								<span class="menu-item__text" data-th-text="#{application.board}">Board</span>
							</a>
						</li>
						<li>
							<a th:href="@{/admin/api}">
								<img class="menu-item__icon" th:src="@{/static/image/icon_api.png}"/>
								<span class="menu-item__text" data-th-text="#{application.api}">API</span>
							</a>
						</li>
					</ul>
				</nav>
				<br/>
				<nav class="banner">
					<ul>
						<li>
							<a th:href="@{/swagger-ui.html}" target="blank">
								<img class="banner" th:src="@{/static/image/banner_swagger.png}"/>
							</a>
						</li>
						<li>
							<a href="https://github.com/oopscraft/application" target="blank">
								<img class="banner" th:src="@{/static/image/banner_github.png}"/>
							</a>
						</li>
					</ul>
				</nav>
			</div>
			<div layout:fragment="content" class="app-col" style="width:calc(100% - 200px); padding:1rem;">
				<script>
				// defines variables		
				var webSocketClient = new duice.WebSocketClient();
				var cpuUsageChart = null;
				
				// document ready
				$(document).ready(function() {
					
					// creates web socket
					getMonitors();
					
					// connects web socket
				    var webSocketUrl = (window.location.protocol === 'https'?'wss':'ws')+'://'+location.host+'/api/webSocket';
					webSocketClient.open(webSocketUrl);
					webSocketClient.onMessage(function(event){
						console.log(event);
						var monitor = JSON.parse(event.data);
						$('#top').text(monitor.top);
						
						updateCpuUsageChart(monitor);
					});
				});
				
				/**
				 * Getting monitors
				 */
				function getMonitors() {
					$.ajax({
						 url: '[[@{/api/monitors}]]'
						,type: 'GET'
						,data: null
					})
					.done(function(data, textStatus, jqXHR) {
						var monitors = data;
						var lastMonitor = data[data.length-1];
						$('#top').text(lastMonitor.top);
						
						// initializeCpuUsageChart
						initializeCpuUsageChart(monitors);
				   	});
				}
				
				/**
				 * initializeCpuUsageChart
				 */
				function initializeCpuUsageChart(monitors) {
					var labels = new Array();
					var data = new Array();
					monitors.forEach(function(monitor){
						labels.push(moment().format('HH:mm:ss',monitor.date));
						data.push(monitor.operatingSystem.systemLoadAverage);
					});
					console.log('data', data);
					
					// creates chart
					cpuUsageChart = new Chart(document.getElementById("cpuUsageChart").getContext('2d'), {
					    type: 'line',
					    data: {
					        labels: labels,
					        datasets: [{
					            label: 'CPU', // Name the series
					            data: data,
					            fill: false,
					            borderColor: '#2196f3', // Add custom color border (Line)
					            backgroundColor: '#2196f3', // Add custom color background (Points and Fill)
					            borderWidth: 1 // Specify bar border width
					        }]},
					    options: {
					      responsive: true, // Instruct chart js to respond nicely.
					      maintainAspectRatio: false, // Add to prevent default behaviour of full-width/height 
					    }
					});
					cpuUsageChart.update();
				}
				
				function updateCpuUsageChart(monitor) {
					console.log(cpuUsageChart);
					console.log('monitor.date', monitor.date);
					cpuUsageChart.config.data.labels.shift();
					cpuUsageChart.config.data.labels.push(moment().format('HH:mm:ss',monitor.date));
					console.log('monitor.operatingSystem.systemLoadAverage', monitor.operatingSystem.systemLoadAverage);
					cpuUsageChart.config.data.datasets[0].data.shift();
					cpuUsageChart.config.data.datasets[0].data.push(monitor.operatingSystem.systemLoadAverage);
					cpuUsageChart.update();
				}
				</script>
				<div class="app-row title">
					<div class="app-col bottom">
						<h1>
							<img class="icon large" th:src="@{/static/image/icon_monitor.png}"/>
							<span data-th-text="#{application.monitor}"></span>
						</h1>
					</div>
				</div>
				<div class="app-row">
					<div class="app-col">
						<pre style="margin:0px; height:200px; border-radius:3px;"><code id="top" class="language-bash line-numbers"></code></pre>	
					</div>
				</div>
				<div class="app-row">
					<div class="app-col" style="width:30%;">
						<canvas id="cpuUsageChart"></canvas>
					</div>
					<div class="app-col" style="width:30%;">
						<canvas id="myChart1" ></canvas>
						<script>
						var ctx = document.getElementById('myChart1').getContext('2d');
						var myChart = new Chart(ctx, {
						    type: 'bar',
						    data: {
						        labels: ['Red', 'Blue', 'Yellow', 'Green', 'Purple', 'Orange'],
						        datasets: [{
						            label: '# of Votes',
						            data: [12, 19, 3, 5, 2, 3],
						            backgroundColor: [
						                'rgba(255, 99, 132, 0.2)',
						                'rgba(54, 162, 235, 0.2)',
						                'rgba(255, 206, 86, 0.2)',
						                'rgba(75, 192, 192, 0.2)',
						                'rgba(153, 102, 255, 0.2)',
						                'rgba(255, 159, 64, 0.2)'
						            ],
						            borderColor: [
						                'rgba(255, 99, 132, 1)',
						                'rgba(54, 162, 235, 1)',
						                'rgba(255, 206, 86, 1)',
						                'rgba(75, 192, 192, 1)',
						                'rgba(153, 102, 255, 1)',
						                'rgba(255, 159, 64, 1)'
						            ],
						            borderWidth: 1
						        }]
						    },
						    options: {
						        scales: {
						            yAxes: [{
						                ticks: {
						                    beginAtZero: true
						                }
						            }]
						        }
						    }
						});
						</script>
					</div>
					<div class="app-col" style="width:30%;">
						<canvas id="myChart2" ></canvas>
						<script>
						var ctx = document.getElementById('myChart2').getContext('2d');
						var myChart = new Chart(ctx, {
						    type: 'bar',
						    data: {
						        labels: ['Red', 'Blue', 'Yellow', 'Green', 'Purple', 'Orange'],
						        datasets: [{
						            label: '# of Votes',
						            data: [12, 19, 3, 5, 2, 3],
						            backgroundColor: [
						                'rgba(255, 99, 132, 0.2)',
						                'rgba(54, 162, 235, 0.2)',
						                'rgba(255, 206, 86, 0.2)',
						                'rgba(75, 192, 192, 0.2)',
						                'rgba(153, 102, 255, 0.2)',
						                'rgba(255, 159, 64, 0.2)'
						            ],
						            borderColor: [
						                'rgba(255, 99, 132, 1)',
						                'rgba(54, 162, 235, 1)',
						                'rgba(255, 206, 86, 1)',
						                'rgba(75, 192, 192, 1)',
						                'rgba(153, 102, 255, 1)',
						                'rgba(255, 159, 64, 1)'
						            ],
						            borderWidth: 1
						        }]
						    },
						    options: {
						        scales: {
						            yAxes: [{
						                ticks: {
						                    beginAtZero: true
						                }
						            }]
						        }
						    }
						});
						</script>
					</div>
				</div>
				
				
				
				
				
				
				
				
				
				

				
				
				
				
				
				
				
				
				
				
				
			</div>
		</div>
		<div style="text-align:center; border-top:dotted 1px #ccc;">
			<img th:src="@{/static/image/copyright.png}"/>
		</div>
		
		<!-- ====================================================== -->
		<!-- Groups Dialog											-->
		<!-- ====================================================== -->
		<dialog id="__groupDialog" style="width:600px;">
			<div class="app-row">
				<div class="app-col">
					<img class="icon" th:src="@{/static/image/icon_group.png}"/>
					<span data-th-text="#{application.group} + ' ' + #{application.global.select}" class="font-bold"></span>
				</div>
			</div>
			<hr class="hr"/>
			<div class="app-row">
				<div class="app-col">
					<ul is="duice-ul" 
					data-duice-bind="__groupDialog.groups,group" 
					data-duice-hierarchy="id,upperId"
					data-duice-selectable="true"
					data-duice-foldable="true"
					style="max-height:600px; overflow-y:scroll;">
						<li>
							<div class="app-row" style="width:95%;border-bottom:dotted 1px #ccc;">
								<div class="app-col">
									<img is="duice-img" data-duice-bind="group,icon" th:src="@{/static/image/icon_group.png}" class="icon small"/>
									<span is="duice-span" data-duice-bind="group,name" style="font-weight:bold;"></span>
								</div>
								<div class="app-col text-right">
									<input is="duice-input-checkbox" type="checkbox" data-duice-bind="group,__checked"/>
								</div>
							</div>
						</li>
					</ul>				
				</div>
			</div>
			<div class="app-row">
				<div class="app-col right">
					<button class="button" onclick="__groupDialog.confirm();">
						<img th:src="@{/static/image/icon_confirm.png}" class="icon small"/>
						Ok
					</button>
				</div>
			</div>
		</dialog>
		<script>
		/**
		 * Global common group select dialog
		 */
        const __groupDialog = {
        	dialog: new duice.Dialog(document.getElementById('__groupDialog')),
        	groups: new duice.List(),
        	
        	// option
        	singleSelect: false,
        	checkedGroups: null,
        	disabledGroups: null,

        	/**
        	 * Opens group dialog
        	 * @param option.singleSelect 
			 * @param option.selectedGroups 
			 * @param option.disabledGroups 
			 * @param option.onAfterConfirm
        	 */
        	async open(option) {
        		
        		// setting options
        		this.singleSelect = option.singleSelect||false;
        		this.checkedGroups = option.checkedGroups||[];
        		this.disabledGroups = option.disabledGroups||[];
        		this.dialog.onAfterConfirm(option.onAfterConfirm||function(){});
        		
        		// defines index change event
        		var _this = this;
        		this.groups.setReadonly('__checked', true);
        		this.groups.onAfterSelectRow(function(group){
       				
       				// check disabled
       				if(group.isDisable() === true){
       					return;
       				}
       				
       				// if singleSelect, desleect all except self index
       				if(_this.singleSelect === true){
       					_this.groups.forEach(function(row){
       						if(row.get('id') !== group.get('id')){
       							row.set('__checked', false);        							
       						}
       					});
       				}

       				// toggles __checked
       				var __checked = group.get('__checked');
       				if(__checked === true){
       					group.set('__checked', false);
       				}else{
       					group.set('__checked', true);
       				}
        		});
        		
        		// retrieves and open
        		await this.getGroups(1);
        		this.dialog.open();
        	},
        	
        	/**
        	 * Getting groups
        	 */
        	getGroups(page) {
				var _this = this;
				return new Promise(function(resolve,reject){
					$.ajax({
						 url: '[[@{/admin/getGroups}]]'
						,type: 'GET'
						,data: {page:page, rows:10000}
						,success: function(data, textStatus, jqXHR) {
							_this.groups.fromJson(data);
							_this.groups.forEach(function(group){
								var id = group.get('id');
								
								// checks __selected value, if it set as selected list.
								_this.checkedGroups.forEach(function(item){
									if(item.id === id){
										group.set('__checked', true);
									}
								});
								
								// excepts disableds list
								_this.disabledGroups.forEach(function(item){
									if(item.id === id){
										group.setDisable(true);
									}
								});
							});
							resolve(true);
						}
					});
				});
        	},
        	
        	/**
        	 * Executes dialog confirm.
        	 */
        	confirm() {
				var checkedGroups = new Array();
				this.groups.forEach(function(group){
					if(group.isDisable() === false && group.get('__checked') === true){
						checkedGroups.push(group.toJson());
					}
				});
				this.dialog.confirm(checkedGroups);
        	}
        }
		</script>
		
		<!-- ====================================================== -->
		<!-- Roles Dialog											-->
		<!-- ====================================================== -->
		<dialog id="__roleDialog" style="width:600px;">
			<div class="app-row">
				<div class="app-col">
					<img class="icon" th:src="@{/static/image/icon_role.png}"/>
					<span data-th-text="#{application.role}+' '+#{application.global.select}" class="font-bold"></span>
				</div>
			</div>
			<hr class="hr"/>
			<div class="app-row">
				<div class="app-col">
					<select is="duice-select" data-duice-bind="__roleDialog.search,key" style="width:125px;">
						<option value data-th-text="'- '+#{application.global.all}+' -'"></option>
						<option value="id" data-th-text="#{application.role.id}">Role ID</option>
						<option value="name" data-th-text="#{application.role.name}">Role Name</option>
					</select>
					<input is="duice-input-text" type="text" data-duice-bind="__roleDialog.search,value" style="width:250px;"/>
				</div>
				<div class="app-col right">
					<button class="button" onclick="__roleDialog.getRoles();">
						<img th:src="@{/static/image/icon_search.png}" class="icon"/>
						Search
					</button>
				</div>
			</div>
			<div class="app-row">
				<div class="app-col">
					<table is="duice-table" 
					data-duice-bind="__roleDialog.roles,role" 
					data-duice-selectable="true"
					style="width:100%;">
						<col style="width:5%;"/>					
						<col style="width:10%;"/>
						<col style="width:35%;"/>
						<col style="width:50%;"/>
						<thead>
							<tr>
								<th>-</th>
								<th data-th-text="#{application.global.no}">No</th>
								<th data-th-text="#{application.role.id}">ID</th>
								<th data-th-text="#{application.role.name}">Name</th>
							</tr>
						</thead>
						<tbody>
							<tr>
								<td class="text-center"><input is="duice-input-checkbox" type="checkbox" data-duice-bind="role,__checked" /></td>
								<td class="text-center"><span is="duice-scriptlet" data-duice-bind="role">return $context.index+1;</span></td>
								<td>
									<img is="duice-img" data-duice-bind="role,icon" th:src="@{/static/image/icon_role.png}" class="icon small"/>
									<span is="duice-span" data-duice-bind="role,id"></span>
								</td>
								<td><span is="duice-span" data-duice-bind="role,name"></span></td>
							</tr>
						</tbody>
					</table>
				</div>
			</div>
			<div class="app-row">
				<div class="app-col center">
					<ul is="duice-pagination" data-duice-bind="__roleDialog.search,page,rows,totalCount" data-duice-size="5">
						<li onclick="__roleDialog.getRoles();"></li>
					</ul>
				</div>
			</div>
			<div class="app-row">
				<div class="app-col">
					<table is="duice-table" 
					data-duice-bind="__roleDialog.selectedRoles,role" 
					data-duice-selectable="true"
					style="width:100%;">
						<col style="width:10%;"/>
						<col style="width:35%;"/>
						<col/>
						<col style="width:5%;"/>
						<thead>
							<tr>
								<th data-th-text="#{application.global.no}">No</th>
								<th data-th-text="#{application.role.id}">ID</th>
								<th data-th-text="#{application.role.name}">Name</th>
								<th>-</th>
							</tr>
						</thead>
						<tbody>
							<tr>
								<td class="text-center"><span is="duice-scriptlet" data-duice-bind="role">return $context.index+1;</span></td>
								<td>
									<img is="duice-img" data-duice-bind="role,icon" th:src="@{/static/image/icon_group.png}" class="icon small"/>
									<span is="duice-span" data-duice-bind="role,id"></span>
								</td>
								<td><span is="duice-span" data-duice-bind="role,name"></span></td>
								<td>
									<button class="button small" data-index="[@duice[$context.index]]" onclick="__roleDialog.selectedRoles.removeRow(this.dataset.index);">-</button>
								</td>
							</tr>
						</tbody>
					</table>
				</div>
			</div>
			<div class="app-row">
				<div class="app-col right">
					<button class="button" onclick="__roleDialog.confirm();">
						<img th:src="@{/static/image/icon_confirm.png}" class="icon"/>
						Ok
					</button>
				</div>
			</div>
		</dialog>
		<script>
		/**
		 * Global common role dialog
		 */
        const __roleDialog = {
        	dialog: new duice.Dialog(document.getElementById('__roleDialog')),
        	search: new duice.Map({
        		page: 1,
        		rows: 10,
        		totalCount: -1
        	}),
        	roles: new duice.List(),
        	selectedRoles: new duice.List(),
        	
        	// option
        	checkedRoles: null,
        	disabledRoles: null,
        	onAfterConfirm: null,
        	
        	/**
        	 * Opens dialogs
        	 * @param option.checkedRoles:Array
			 * @param option.disabledRoles:Array
			 * @param option.onAfterConfirm:Function 
        	 */
        	async open(option) {
				this.checkedRoles = option.checkedRoles || [];
				this.disabledRoles = option.disabledRoles || [];
				this.dialog.onAfterConfirm(option.onAfterConfirm || new function(){});
        		this.selectedRoles.fromJson([]);
        		
        		// add index change event listener
        		var _this = this;
        		this.roles.setReadonly('__checked', true);
        		this.roles.onAfterSelectRow(function(role){
    				var id = role.get('id');
    				
    				// check disabled
    				if(role.isDisable() === true){
    					return;
    				}

    				// toggles __selected
    				var __checked = role.get('__checked');
    				if(__checked === true){
    					role.set('__checked', false);
    					_this.selectedRoles.forEach(function(row,index){
    						if(row.get('id') === id){
    							_this.selectedRoles.removeRow(index);
    							return false;
    						}
    					});
    				}else{
    					role.set('__checked', true);
    					_this.selectedRoles.addRow(new duice.Map(role.toJson()));
    				}
        		});

        		// retrieves roles and open
        		await this.getRoles(1);
        		this.dialog.open();
        	},

        	/**
			 * Getting groups
			 */
        	getRoles(page) {
        		var _this = this;
        		return new Promise(function(resolve,reject){
	        		page && _this.search.set('page', page);
					var data = _this.search.toJson();
					if(_this.search.get('key')){
						data[_this.search.get('key')] = _this.search.get('value');
					}
					$.ajax({
						 url: '[[@{/admin/getRoles}]]'
						,type: 'GET'
						,data: data
						,success: function(data, textStatus, jqXHR) {
							_this.roles.fromJson(data);
							_this.search.set('totalCount', __parseTotalCount(jqXHR));
							
							// check earch role
							_this.roles.forEach(function(role){
								var id = role.get('id');
								
								// checks disabled	
								_this.disabledRoles.forEach(function(obj){
									if(obj.id === id){
										role.setDisable(true);
										role.set('__checked', true);
										return false;
									}
								});
								
								// checks already selected
								_this.selectedRoles.forEach(function(map){
									if(map.get('id') === id){
										role.set('__checked', true);
										return false;
									}
								});
							});
							resolve(true);
				   	 	}
					});
        		});
        	},

        	/**
        	 * Executes confirm
        	 */
        	confirm() {
        		this.dialog.confirm(this.selectedRoles.toJson());
        	}
        }
		</script>
		
		<!-- ====================================================== -->
		<!-- Authorities Dialog										-->
		<!-- ====================================================== -->
		<dialog id="__authorityDialog" style="width:600px;">
			<div class="app-row">
				<div class="app-col">
					<img class="icon" th:src="@{/static/image/icon_authority.png}"/>
					<span data-th-text="#{application.authority}+' '+#{application.global.select}" class="font-bold"></span>
				</div>
			</div>
			<hr class="hr"/>
			<div class="app-row">
				<div class="app-col">
					<select is="duice-select" data-duice-bind="__authorityDialog.search,key" style="width:125px;">
						<option value data-th-text="'- '+#{application.global.all}+' -'"></option>
						<option value="id" data-th-text="#{application.authority.id}">ID</option>
						<option value="name" data-th-text="#{application.authority.name}">Name</option>
					</select>
					<input is="duice-input-text" type="text" data-duice-bind="__authorityDialog.search,value" style="width:250px;"/>
				</div>
				<div class="app-col right">
					<button class="button" onclick="__authorityDialog.getAuthorities();">
						<img th:src="@{/static/image/icon_search.png}" class="icon"/>
						Search
					</button>
				</div>
			</div>
			<div class="app-row">
				<div class="app-col">
					<table is="duice-table" 
					data-duice-bind="__authorityDialog.authorities,authority" 
					data-duice-selectable="true"
					style="width:100%;">
						<col style="width:5%;"/>
						<col style="width:10%;"/>
						<col style="width:35%;"/>
						<col style="width:50%;"/>
						<thead>
							<tr>
								<th>-</th>
								<th data-th-text="#{application.global.no}">No</th>
								<th data-th-text="#{application.authority.id}">ID</th>
								<th data-th-text="#{application.authority.name}">Name</th>
							</tr>
						</thead>
						<tbody>
							<tr>
								<td class="text-center"><input is="duice-input-checkbox" type="checkbox" data-duice-bind="authority,__checked"/></td>
								<td class="text-center"><span is="duice-scriptlet" data-duice-bind="authority">return $context.index+1;</span></td>
								<td>
									<img is="duice-img" data-duice-bind="authority,icon" th:src="@{/static/image/icon_authority.png}" class="icon small"/>
									<span is="duice-span" data-duice-bind="authority,id"></span>
								</td>
								<td><span is="duice-span" data-duice-bind="authority,name"></span></td>
							</tr>
						</tbody>
					</table>
				</div>
			</div>
			<div class="app-row">
				<div class="app-col center">
					<ul is="duice-pagination" data-duice-bind="__authorityDialog.search,page,rows,totalCount" data-duice-size="5">
						<li onclick="__authorityDialog.getAuthorities();"></li>
					</ul>
				</div>
			</div>
			<div class="app-row">
				<div class="app-col">
					<table is="duice-table" 
					data-duice-bind="__authorityDialog.selectedAuthorities,authority" 
					style="width:100%;">
						<col style="width:10%;"/>
						<col style="width:35%;"/>
						<col/>
						<col style="width:5%;"/>
						<thead>
							<tr>
								<th data-th-text="#{application.global.no}">No</th>
								<th data-th-text="#{application.authority.id}">Authority ID</th>
								<th data-th-text="#{application.authority.name}">Authority Name</th>
								<th>-</th>
							</tr>
						</thead>
						<tbody>
							<tr>
								<td class="text-center"><span is="duice-scriptlet" data-duice-bind="authority">return $context.index+1;</span></td>
								<td>
									<img is="duice-img" data-duice-bind="authority,icon" th:src="@{/static/image/icon_authority.png}" class="icon small"/>
									<span is="duice-span" data-duice-bind="authority,id"></span>
								</td>
								<td><span is="duice-span" data-duice-bind="authority,name"></span></td>
								<td style="text-align:center;">
									<button class="button small" data-index="[@duice[$context.index]]" onclick="__authorityDialog.selectedAuthorities.removeRow(this.dataset.index);">-</button>
								</td>
							</tr>
						</tbody>
					</table>
				</div>
			</div>
			<div class="app-row">
				<div class="app-col right">
					<button class="button" onclick="__authorityDialog.confirm();">
						<img th:src="@{/static/image/icon_confirm.png}" class="icon small"/>
						OK
					</button>
				</div>
			</div>
		</dialog>
		<script>
        var __authorityDialog = {
           	dialog: new duice.Dialog(document.getElementById('__authorityDialog')),
           	search: new duice.Map({
           		page: 1,
           		rows: 10,
           		totalCount: -1
           	}),
           	authorities: new duice.List(),
           	selectedAuthorities: new duice.List(),
           	
           	// option
           	checkedAuthorities: null,
           	disabledAuthorities: null,
           	onAfterConfirm: null,
           	
           	/**
           	 * Opens dialogs
           	 * @param option.checkedAuthorities:Array
   			 * @param option.disabledAuthorities:Array
   			 * @param option.onAfterConfirm:Function 
           	 */
           	async open(option) {
   				this.checkedAuthorities = option.checkedAuthorities || [];
   				this.disabledAuthorities = option.disabledAuthorities || [];
   				this.dialog.onAfterConfirm(option.onAfterConfirm || new function(){});
           		this.selectedAuthorities.fromJson([]);
           		
           		// add index change event listener
           		var _this = this;
           		this.authorities.setReadonly('__checked', true);
           		this.authorities.onAfterSelectRow(function(authority){
       				var id = authority.get('id');
       				
       				// check disabled
       				if(authority.isDisable() === true){
       					return;
       				}

       				// toggles __selected
       				var __checked = authority.get('__checked');
       				if(__checked === true){
       					authority.set('__checked', false);
       					_this.selectedAuthorities.forEach(function(row,index){
       						if(row.get('id') === id){
       							_this.selectedAuthorities.removeRow(index);
       							return false;
       						}
       					});
       				}else{
       					authority.set('__checked', true);
       					_this.selectedAuthorities.addRow(new duice.Map(authority.toJson()));
       				}
           		});
           		
           		// retrieves and open
           		await this.getAuthorities(1);
           		this.dialog.open();
           	},

           	/**
   			 * Getting groups
   			 */
           	getAuthorities(page) {
   				var _this = this;
				return new Promise(function(resolve,reject){
            		_this.page && _this.search.set('page', page);
    				var data = _this.search.toJson();
    				if(_this.search.get('key')){
    					data[_this.search.get('key')] = _this.search.get('value');
    				}
    				$.ajax({
    					 url: '[[@{/admin/getAuthorities}]]'
    					,type: 'GET'
    					,data: data
    					,success: function(data, textStatus, jqXHR) {
    						_this.authorities.fromJson(data);
    						_this.search.set('totalCount', __parseTotalCount(jqXHR));
    						
    						// check earch authority
    						_this.authorities.forEach(function(authority){
    							var id = authority.get('id');
    							
    							// checks disabled	
    							_this.disabledAuthorities.forEach(function(obj){
    								if(obj.id === id){
    									authority.setDisable(true);
    									authority.set('__checked', true);
    									return false;
    								}
    							});
    							
    							// checks already selected
    							_this.selectedAuthorities.forEach(function(map){
    								if(map.get('id') === id){
    									authority.set('__checked', true);
    									return false;
    								}
    							});
    						});
    						resolve(true);
    			   	 	}
    				});
				});  				
           	},

           	/**
           	 * Executes confirm
           	 */
           	confirm() {
           		this.dialog.confirm(this.selectedAuthorities.toJson());
           	}
		}
		</script>

	</body>
</html>
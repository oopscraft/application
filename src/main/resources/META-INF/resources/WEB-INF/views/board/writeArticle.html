<!DOCTYPE html>
<html layout:decorate="~{index.html}">
<div layout:fragment="content">
	<script>
	// defines variables
	const article = new duice.Map();
	const articleFiles = new duice.List();
	
	// document ready
	$(document).ready(function() {
		if(duice.parseQueryString().id){
			getArticle();	
		}
	});
	
	/**
	 * Getting articles
	 */
	function getArticle(){
		$.ajax({
			 url: '[[@{/api/boards}]]/[[${board.id}]]/articles/[[${param.id}]]'
			,type: 'GET'
		})
		.done(function(data, textStatus, jqXHR) {
			article.fromJson(data);
			articleFiles.fromJson(data.files);
	   	});
	}
	
	/**
	 * Uploads article file
	 */
	function uploadArticleFile() {
		var file = document.createElement('input');
		file.setAttribute('type', 'file');
		file.addEventListener('change', function(e){
			var formData = new FormData();
			formData.append('file', this.files[0]);
			$.ajax({
				 url: '[[@{/api/boards}]]/[[${board.id}]]/files'
				,type: 'POST'
				,data: formData
				,enctype: 'multipart/form-data'
				,cache: false
				,contentType: false
				,processData: false
				,xhr: function() {
					var xhr = new window.XMLHttpRequest();
					xhr.upload.addEventListener("progress", function(evt) {
						if (evt.lengthComputable) {
							var percentComplete = evt.loaded / evt.total;
							percentComplete = parseInt(percentComplete * 100);
							console.log(percentComplete);
						}
					}, false);
				    return xhr;
				}
			})
			.done(function(data, textStatus, jqXHR) {
				articleFiles.addRow(new duice.Map(data));
			});
		});
		file.click();
	}
	
	/**
	 * Removes article file
	 */
	function removeArticleFile(index) {
		articleFiles.removeRow(index);
	}
	
	/**
	 * Saves article reply
	 */
	async function saveArticle(){
		
		// checks title
		if(!article.has('title')){
			duice.alert('[[#{application.global.enterItem(#{application.board.article.title})}]]');
			return false;
		}
		
		// executes save process
		if(await duice.confirm('[[#{application.global.saveConfirm(#{application.board.article})}]]')){
			var articleId = article.get('id');
			var url = '[[@{/api/boards}]]/[[${board.id}]]/articles';
			var type = 'POST';
			if(!duice.isEmpty(articleId)){
				url += '/' + articleId;
				type = 'PUT';
			}
			var data = article.toJson();
			data.files = articleFiles.toJson();
			$.ajax({
				 url: url
				,type: type
				,data: JSON.stringify(data)
				,contentType: 'application/json;charset=UTF-8'
			})
			.done(function(data, textStatus, jqXHR) {
				window.history.back();
		   	});
		}
	}
	
	</script>
	<th:block th:include="|../theme/application/board/default/writeArticle.html|"></th:block>
</div>



